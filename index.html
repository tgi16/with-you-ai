<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>With You Studio - Partner AI v5.4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap" rel="stylesheet">
  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    body { font-family: 'Padauk', sans-serif; }
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
    
    .glass-panel {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }
    
    .nav-item.active, .mobile-nav-item.active {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        border-color: transparent;
    }

    .tactic-btn.active, .creative-btn.active {
        background-color: #7e22ce; 
        border-color: #a855f7;
        color: white;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);
    }

    #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .sidebar-open { transform: translateX(0) !important; }
    .sidebar-closed { transform: translateX(-100%); }
    @media (min-width: 768px) { .sidebar-closed { transform: translateX(0); } }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .listening-ring {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        animation: pulse-red 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        border-color: #ef4444 !important; color: #ef4444 !important;
    }
    @keyframes pulse-red { to { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
    
    /* Chat Bubbles */
    .chat-bubble-ai {
        background: #1e293b;
        color: #e2e8f0;
        border-radius: 12px 12px 12px 2px;
        padding: 12px 16px;
        font-size: 14px;
        line-height: 1.6;
        border: 1px solid rgba(255,255,255,0.05);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .chat-bubble-user {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-radius: 12px 12px 2px 12px;
        padding: 12px 16px;
        font-size: 14px;
        line-height: 1.6;
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
    }

    /* Typing Dot Animation */
    .typing-dot {
        animation: typing 1.4s infinite ease-in-out both;
        width: 6px; height: 6px; background-color: #94a3b8; border-radius: 50%; display: inline-block; margin: 0 2px;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    
    /* Toast Animation */
    .toast { visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; opacity: 0; }
    .toast.show { visibility: visible; bottom: 40px; opacity: 1; }

    /* Mobile Text Size Fix */
    @media screen and (max-width: 768px) {
        input, select, textarea { font-size: 16px !important; }
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-200 h-[100dvh] flex overflow-hidden selection:bg-blue-500/30">

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="fixed inset-0 z-[60] bg-slate-950/98 backdrop-blur-md flex flex-col items-center justify-center p-6 transition-opacity duration-300">
    <div class="glass-panel p-8 rounded-3xl w-full max-w-sm border border-slate-700/50 shadow-2xl flex flex-col items-center space-y-6">
        <div class="text-center">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/20 rotate-3">
                <i class="ph ph-camera text-4xl text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-white tracking-tight">With You Studio</h2>
            <p class="text-sm text-slate-400 mt-1 font-medium">Sales & Content AI</p>
        </div>
        
        <div class="w-full space-y-4">
            <div class="space-y-1">
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">Email</label>
                <input type="email" id="loginEmail" placeholder="admin@studio.com" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 outline-none">
            </div>
            <div class="space-y-1">
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">Password</label>
                <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 outline-none">
            </div>
            <button onclick="window.handleLogin()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition active:scale-95 flex justify-center gap-2 items-center mt-2">
                <span>Log In</span>
                <i class="ph ph-sign-in"></i>
            </button>
        </div>
        
        <p id="loginError" class="text-red-400 text-xs text-center hidden bg-red-900/20 p-3 rounded-lg w-full border border-red-900/30"></p>
    </div>
  </div>

  <!-- OVERLAY for Mobile Sidebar -->
  <div id="overlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden backdrop-blur-sm transition-all"></div>

  <!-- SIDEBAR NAVIGATION (Desktop) -->
  <aside id="sidebar" class="sidebar-closed fixed inset-y-0 left-0 z-50 w-72 bg-slate-900/95 border-r border-slate-800 flex flex-col transition-transform duration-300 md:relative md:translate-x-0 shadow-2xl backdrop-blur-xl">
    <div class="p-6 border-b border-slate-800/50 flex items-center justify-between bg-slate-900/50">
        <div>
            <h1 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
                <span class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white"><i class="ph ph-camera-fill"></i></span>
                With You
            </h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1.5 flex items-center gap-1.5 pl-1">
                <span id="connectionStatus" class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> Offline
            </p>
        </div>
        <button onclick="window.toggleSidebar()" class="md:hidden text-slate-400 hover:text-white p-2 rounded-lg hover:bg-slate-800 transition"><i class="ph ph-x text-xl"></i></button>
    </div>

    <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-8 custom-scroll">
        <div>
            <p class="px-2 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-3">Partner</p>
            <div class="space-y-1">
                <button onclick="window.loadView('manager')" id="nav-manager" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800/80 hover:text-white transition group">
                    <i class="ph ph-robot text-xl text-yellow-400 group-hover:scale-110 transition"></i> AI Manager
                </button>
                <button onclick="window.loadView('dm')" id="nav-dm" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800/80 hover:text-white transition group">
                    <i class="ph ph-chat-circle-text text-xl text-purple-400 group-hover:scale-110 transition"></i> Sales DM
                </button>
                <button onclick="window.loadView('brand')" id="nav-brand" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800/80 hover:text-white transition group">
                    <i class="ph ph-brain text-xl text-blue-400 group-hover:scale-110 transition"></i> Brand Brain
                </button>
            </div>
        </div>
        <div>
            <p class="px-2 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-3">Content</p>
            <div class="space-y-1">
                <button onclick="window.loadView('creative')" id="nav-creative" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800/80 hover:text-white transition group">
                    <i class="ph ph-lightbulb text-xl text-orange-400 group-hover:scale-110 transition"></i> Ideas
                </button>
                <button onclick="window.loadView('fbpost')" id="nav-fbpost" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800/80 hover:text-white transition group">
                    <i class="ph ph-facebook-logo text-xl text-blue-500 group-hover:scale-110 transition"></i> Facebook
                </button>
                <button onclick="window.loadView('tiktok')" id="nav-tiktok" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800/80 hover:text-white transition group">
                    <i class="ph ph-tiktok-logo text-xl text-teal-400 group-hover:scale-110 transition"></i> TikTok
                </button>
            </div>
        </div>
        <div>
            <p class="px-2 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-3">Tools</p>
            <div class="space-y-1">
                <button onclick="window.loadView('timeline')" id="nav-timeline" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800/80 hover:text-white transition group">
                    <i class="ph ph-clock text-xl text-orange-400 group-hover:scale-110 transition"></i> Timeline
                </button>
                <button onclick="window.loadView('pose')" id="nav-pose" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800/80 hover:text-white transition group">
                    <i class="ph ph-camera text-xl text-pink-400 group-hover:scale-110 transition"></i> Pose
                </button>
                <button onclick="window.loadView('recent')" id="nav-recent" class="nav-item w-full flex items-center gap-3 px-3 py-3 rounded-xl text-sm font-medium text-slate-400 hover:bg-slate-800/80 hover:text-white transition group relative">
                    <i class="ph ph-clock-counter-clockwise text-xl text-green-400 group-hover:scale-110 transition"></i> 
                    History
                    <span id="recentBadge" class="hidden absolute right-3 top-4 w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                </button>
            </div>
        </div>
    </nav>

    <div class="p-4 border-t border-slate-800/50 bg-slate-900/50">
        <div id="userEmailDisplay" class="text-[10px] text-slate-500 mb-3 truncate text-center font-mono bg-slate-950/50 py-1 rounded">...</div>
        <button onclick="window.handleLogout()" class="w-full py-2.5 border border-red-500/20 bg-red-500/5 rounded-xl text-red-400 hover:bg-red-500/10 hover:border-red-500/30 transition flex items-center justify-center gap-2 text-xs font-bold">
            <i class="ph ph-sign-out text-lg"></i> Sign Out
        </button>
    </div>
  </aside>

  <!-- MAIN CONTENT AREA (RIGHT) -->
  <div class="flex-1 flex flex-col h-full relative w-full bg-slate-950">
    <header class="md:hidden h-16 bg-slate-900/80 border-b border-slate-800 flex items-center justify-between px-4 z-30 shrink-0 backdrop-blur-md sticky top-0">
        <button onclick="window.toggleSidebar()" class="text-white p-2 hover:bg-slate-800 rounded-lg transition"><i class="ph ph-list text-2xl"></i></button>
        <span class="font-bold text-white text-lg tracking-tight">With You Studio</span>
        <div class="w-10"></div>
    </header>

    <!-- MOBILE QUICK NAV -->
    <div class="md:hidden bg-slate-950/95 border-b border-slate-800 overflow-x-auto no-scrollbar py-3 px-4 flex gap-3 shrink-0 backdrop-blur-md z-20">
        <button onclick="window.loadView('manager')" id="mob-manager" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-900">
            <i class="ph ph-robot text-yellow-400"></i> Partner
        </button>
        <button onclick="window.loadView('dm')" id="mob-dm" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-900">
            <i class="ph ph-chat-circle-text text-purple-400"></i> DM
        </button>
        <button onclick="window.loadView('creative')" id="mob-creative" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-900">
            <i class="ph ph-lightbulb text-orange-400"></i> Ideas
        </button>
        <button onclick="window.loadView('fbpost')" id="mob-fbpost" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-900">
            <i class="ph ph-facebook-logo"></i> Post
        </button>
        <button onclick="window.loadView('tiktok')" id="mob-tiktok" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-900">
            <i class="ph ph-tiktok-logo"></i> TikTok
        </button>
        <button onclick="window.loadView('brand')" id="mob-brand" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-900">
            <i class="ph ph-brain"></i> Brain
        </button>
        <button onclick="window.loadView('timeline')" id="mob-timeline" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-900">
            <i class="ph ph-clock"></i> Timeline
        </button>
        <button onclick="window.loadView('recent')" id="mob-recent" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-900">
            <i class="ph ph-clock-counter-clockwise text-green-400"></i> Recent
        </button>
    </div>

    <!-- Dynamic Content Container -->
    <div id="content-container" class="flex-1 overflow-y-auto p-4 md:p-8 max-w-5xl mx-auto w-full pb-24 scroll-smooth custom-scroll">
        <!-- Content injects here via JS -->
    </div>
  </div>

  <div id="toast" class="toast">Action Complete</div>

  <!-- TEMPLATES -->
  
  <!-- 0. AI MANAGER TEMPLATE (CHAT INTERFACE) -->
  <template id="tpl-manager">
    <div class="animate-fade-in space-y-4 h-full flex flex-col">
        <div class="flex items-center justify-between shrink-0">
            <h2 class="text-xl md:text-2xl font-bold text-yellow-400 flex items-center gap-2"><i class="ph ph-robot"></i> AI Partner</h2>
            <div class="text-[10px] text-slate-400 bg-slate-800/50 border border-slate-700 px-3 py-1 rounded-full">Today's Direction</div>
        </div>
        
        <!-- Chat Area -->
        <div id="chatContainer" class="flex-1 overflow-y-auto space-y-4 p-2 custom-scroll">
            <!-- Initial Greeting -->
            <div class="flex flex-col space-y-2">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400 border border-yellow-500/30 shrink-0"><i class="ph ph-robot"></i></div>
                    <div class="chat-bubble-ai max-w-[85%]">
                        ·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´ ·ÄÄ·Ä≠·ÄØ·ÄÖ·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äõ·Ä±·Åã ·Äí·ÄÆ·Äî·Ä±·Ä∑ ·Äò·Ä¨·Äú·ÄØ·Äï·Ä∫·ÄÄ·Äº·Äô·Äú·Ä≤·Äó·Äª? ·Ä°·Äú·ÄØ·Äï·Ä∫·ÄÄ·Ä≠·ÄÖ·Äπ·ÄÖ ·ÄÜ·ÄΩ·Ä±·Ä∏·Äî·ÄΩ·Ä±·Ä∏·Äô·Äú·Ä¨·Ä∏·Åä Content ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Ä°·ÄÄ·Äº·Ä∂·Äâ·Ä¨·Äè·Ä∫·Äö·Ä∞·Äô·Äú·Ä¨·Ä∏·Åä ·Äí·Ä´·Äô·Äæ·Äô·Äü·ÄØ·Äê·Ä∫ ·ÄÖ·Ä≠·Äê·Ä∫·Äë·ÄΩ·ÄÄ·Ä∫·Äï·Ä±·Ä´·ÄÄ·Ä∫·Ä°·Äî·Ä±·Äî·Ä≤·Ä∑ ·ÄÖ·ÄÄ·Ä¨·Ä∏·Äï·Äº·Ä±·Ä¨·Äô·Äú·Ä¨·Ä∏?
                    </div>
                </div>
            </div>
            <!-- Dynamic Messages go here -->
        </div>

        <!-- Input Area (Fixed Bottom) -->
        <div class="shrink-0 pt-2 space-y-3">
            <!-- Quick Chips -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <button onclick="window.sendChat('üí° ·Äí·ÄÆ·Äî·Ä±·Ä∑·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ Idea ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äú·Ä±·Ä¨·ÄÄ·Ä∫ ·Äï·Ä±·Ä∏·Äï·Ä´')" class="whitespace-nowrap px-4 py-2 rounded-full bg-slate-800 border border-slate-700 text-xs text-slate-300 hover:bg-slate-700 hover:border-yellow-500/50 hover:text-white transition">üí° Today Idea</button>
                <button onclick="window.sendChat('üì© Client ·ÄÄ ·Äà·Ä±·Ä∏·Äô·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·ÄÑ·Äº·Ä≠·Äô·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äê·Äö·Ä∫ ·Äò·Ä¨·Äï·Äº·Äî·Ä∫·Äï·Äº·Ä±·Ä¨·Äõ·Äô·Äú·Ä≤?')" class="whitespace-nowrap px-4 py-2 rounded-full bg-slate-800 border border-slate-700 text-xs text-slate-300 hover:bg-slate-700 hover:border-purple-500/50 hover:text-white transition">üì© DM Strategy</button>
                <button onclick="window.sendChat('üé• TikTok ·Äî·Ä≤·Ä∑ FB ·Äô·Äæ·Ä¨ ·Äò·Ä¨·Äê·ÄÑ·Ä∫·Äõ·ÄÑ·Ä∫·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äú·Ä≤?')" class="whitespace-nowrap px-4 py-2 rounded-full bg-slate-800 border border-slate-700 text-xs text-slate-300 hover:bg-slate-700 hover:border-blue-500/50 hover:text-white transition">üé• Content Plan</button>
                <button onclick="window.sendChat('üß† ·ÄÑ·Ä´·Äî·Ä≤·Ä∑ ·Ä°·Äê·Ä∞·Äê·Ä∞ ·ÄÖ·Äâ·Ä∫·Ä∏·ÄÖ·Ä¨·Ä∏·Äï·Ä±·Ä∏·Äï·Ä´')" class="whitespace-nowrap px-4 py-2 rounded-full bg-slate-800 border border-slate-700 text-xs text-slate-300 hover:bg-slate-700 hover:border-green-500/50 hover:text-white transition">üß† Brainstorm</button>
            </div>

            <!-- Input Box -->
            <div class="relative glass-panel rounded-2xl p-1.5 flex items-end gap-2 border border-slate-600/50">
                <textarea id="chatInput" rows="1" placeholder="·ÄÄ·Ä≠·ÄØ·ÄÖ·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·Äï·Äº·Ä±·Ä¨·ÄÅ·Äª·ÄÑ·Ä∫·Äê·Ä¨ ·Äõ·Ä±·Ä∏·Äï·Ä´..." class="flex-1 bg-transparent border-none text-white text-sm px-4 py-3 focus:ring-0 resize-none max-h-32" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); window.handleChatSubmit(); }"></textarea>
                
                <button onclick="window.startVoiceInput('chatInput', this)" class="p-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-700/50 transition shrink-0" title="Voice"><i class="ph ph-microphone text-xl"></i></button>
                
                <button onclick="window.handleChatSubmit()" class="p-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg hover:shadow-blue-500/20 active:scale-95 transition shrink-0">
                    <i class="ph ph-paper-plane-right-fill text-xl"></i>
                </button>
            </div>
        </div>
    </div>
  </template>

  <!-- OTHER TEMPLATES (Creative, DM, FB, etc. remain the same structure for stability) -->
  <!-- CREATIVE DIRECTOR -->
  <template id="tpl-creative">
    <div class="animate-fade-in space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl md:text-2xl font-bold text-orange-400 flex items-center gap-2"><i class="ph ph-lightbulb"></i> Ideas (Creative)</h2>
        </div>
        <div class="glass-panel p-6 rounded-xl border border-orange-500/20 shadow-lg relative overflow-hidden">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Workload</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setCreativeOption('workload', 'Busy', this)" class="creative-btn p-3 rounded-lg border border-slate-600 bg-slate-800 hover:bg-slate-700 text-xs font-bold text-center transition">Busy<br>ü•µ</button>
                            <button onclick="setCreativeOption('workload', 'Normal', this)" class="creative-btn active p-3 rounded-lg border border-slate-600 bg-slate-800 hover:bg-slate-700 text-xs font-bold text-center transition">Normal<br>üòê</button>
                            <button onclick="setCreativeOption('workload', 'Free', this)" class="creative-btn p-3 rounded-lg border border-slate-600 bg-slate-800 hover:bg-slate-700 text-xs font-bold text-center transition">Motivated<br>ü§©</button>
                        </div>
                        <input type="hidden" id="crWorkload" value="Normal">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Focus</label>
                        <select id="crFocus" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-orange-500 outline-none"><option value="Anything">üé≤ Anything</option><option value="Pre-Wedding">üíç Pre-Wedding</option><option value="Wedding Day">üë∞ Wedding</option><option value="Studio Branding">üè¢ Studio</option></select>
                    </div>
                    <div class="space-y-3 mt-4">
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="window.generateAI('creative_director')" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 font-bold py-3.5 rounded-xl transition active:scale-95 flex items-center justify-center gap-2"><i class="ph ph-calendar-plus text-lg"></i> 3-Day Plan</button>
                            <button onclick="window.generateAI('creative_post')" class="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition active:scale-95 flex items-center justify-center gap-2"><i class="ph ph-pen-nib text-lg"></i> Write Post</button>
                        </div>
                        <button onclick="window.generateAI('creative_tt_text')" class="w-full bg-slate-800 border border-teal-500/50 hover:bg-slate-700 text-teal-400 font-bold py-3.5 rounded-xl transition active:scale-95 flex items-center justify-center gap-2"><i class="ph ph-text-t text-lg"></i> TikTok Text Mode (500 chars)</button>
                    </div>
                </div>
                <div id="crResultArea" class="hidden md:block h-full"><div class="bg-slate-900/50 rounded-xl border border-slate-700 p-4 h-full flex flex-col"><div class="flex justify-between items-center mb-3"><span class="text-xs font-bold text-orange-400 uppercase">Generated</span><button onclick="window.copyText('crOutput')" class="text-xs bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded border border-slate-600 transition">Copy</button></div><div id="crOutput" class="whitespace-pre-wrap text-sm text-slate-200 leading-relaxed flex-1 overflow-y-auto max-h-[400px] custom-scroll"></div></div></div>
            </div>
             <div id="crResultAreaMobile" class="md:hidden hidden mt-4"><div class="bg-slate-900/50 rounded-xl border border-slate-700 p-4"><div class="flex justify-between items-center mb-3"><span class="text-xs font-bold text-orange-400 uppercase">Result</span><button onclick="window.copyText('crOutputMobile')" class="text-xs bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded border border-slate-600 transition">Copy</button></div><div id="crOutputMobile" class="whitespace-pre-wrap text-sm text-slate-200 leading-relaxed"></div></div></div>
        </div>
    </div>
  </template>

  <!-- DM TEMPLATE -->
  <template id="tpl-dm">
    <div class="animate-fade-in space-y-6">
        <div class="flex items-center justify-between"><h2 class="text-xl md:text-2xl font-bold text-purple-400 flex items-center gap-2"><i class="ph ph-chat-circle-text"></i> DM Sales Master</h2></div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div class="glass-panel p-4 md:p-5 rounded-xl space-y-4 border border-purple-500/20 shadow-lg">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Topic</label><select id="dmService" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white focus:border-purple-500"><option value="Pre-wedding">üíç Pre-wedding</option><option value="Wedding Day">üë∞ Wedding</option><option value="General">‚ùì General</option></select></div>
                        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Status</label><select id="dmScenario" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white focus:border-purple-500"><option value="New Inquiry">New Inquiry</option><option value="Price Objection">Expensive</option><option value="Closing">Ready to Book</option></select></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Message</label><div class="relative"><textarea id="dmInput" placeholder="Client text..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm h-32 text-white resize-none focus:border-purple-500 pr-10 shadow-inner"></textarea><button onclick="window.startVoiceInput('dmInput', this)" class="absolute right-2 bottom-2 bg-slate-700/80 hover:bg-purple-600 p-2 rounded-full transition text-slate-300 hover:text-white" title="Speak"><i class="ph ph-microphone text-lg"></i></button></div></div>
                    <button onclick="window.generateAI('dm_auto_detect')" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition active:scale-95 flex items-center justify-center gap-2 border border-indigo-400/30"><i class="ph ph-lightning text-lg"></i> Auto-Detect & Reply</button>
                    <div id="dmAnalysisPanel" class="hidden animate-fade-in bg-slate-900/80 p-4 rounded-xl border border-slate-700 relative mt-2"><div class="absolute -top-3 left-4 bg-slate-800 px-2 text-[10px] text-indigo-400 uppercase font-bold tracking-wider border border-slate-700 rounded">Analysis</div><div id="dmAnalysisContent" class="space-y-2 text-sm mt-1 text-slate-300"></div></div>
                    <div class="pt-2 border-t border-slate-800"><label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Manual</label><div class="grid grid-cols-2 gap-2"><button onclick="window.setDmType('Price Defense', this)" class="tactic-btn p-2 border border-slate-600 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-left transition flex items-center gap-2"><i class="ph ph-shield-check text-green-400"></i> Price Defense</button><button onclick="window.setDmType('Urgency', this)" class="tactic-btn p-2 border border-slate-600 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-left transition flex items-center gap-2"><i class="ph ph-timer text-orange-400"></i> Create Urgency</button></div><input type="hidden" id="dmType" value="Soft Close"></div>
                    <button onclick="window.generateAI('dm_best')" class="w-full bg-slate-800 hover:bg-slate-700 text-purple-300 font-bold py-2 rounded-lg border border-slate-600 transition text-sm">Generate 3 Options</button>
                </div>
            </div>
            <div id="dmResultArea" class="hidden h-full"><div class="glass-panel p-4 md:p-6 rounded-xl border-purple-500/30 h-full flex flex-col relative overflow-hidden"><div class="flex justify-between items-center mb-3 z-10"><span class="text-xs font-bold text-purple-400 uppercase flex items-center gap-1"><i class="ph ph-check-circle"></i> Generated Reply</span><div class="flex gap-2"><button onclick="window.copyText('dmOutput')" class="text-xs bg-purple-900/50 hover:bg-purple-800 px-3 py-1.5 rounded text-purple-200 border border-purple-700">Copy</button></div></div><div id="dmOutput" class="whitespace-pre-wrap text-sm text-slate-200 leading-relaxed flex-1 overflow-y-auto max-h-[600px] z-10 pr-2 custom-scroll"></div><button id="dmContinueBtn" onclick="window.continueAI('dm_best')" class="hidden w-full mt-3 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-purple-300 text-sm font-bold flex items-center justify-center gap-2 transition active:scale-95"><span>‚ö†Ô∏è Continue</span></button></div></div>
        </div>
    </div>
  </template>

  <!-- BRAND -->
  <template id="tpl-brand">
    <div class="animate-fade-in max-w-2xl mx-auto space-y-6">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 md:p-8 rounded-2xl border border-slate-700 relative overflow-hidden shadow-2xl">
            <h2 class="text-xl md:text-2xl font-bold text-white mb-2 flex items-center gap-2"><i class="ph ph-database"></i> Studio Brain (Cloud Sync)</h2>
            <div class="space-y-6 text-left relative z-10">
                <div class="bg-slate-950/50 p-4 rounded-xl border border-slate-700"><label class="text-xs font-bold text-yellow-400 uppercase mb-2 block flex items-center gap-1"><i class="ph ph-package"></i> Packages</label><textarea id="brandPackages" placeholder="Example: Silver Package..." class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm text-white h-32 resize-none focus:border-yellow-500"></textarea></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="text-xs font-bold text-blue-400 uppercase">Studio Vibe</label><input type="text" id="brandStyle" value="Moody, Cinematic" class="w-full mt-1 bg-slate-950 border border-slate-700 rounded p-3 text-white"></div><div><label class="text-xs font-bold text-blue-400 uppercase">Target Audience</label><input type="text" id="brandClient" value="Luxury Couples" class="w-full mt-1 bg-slate-950 border border-slate-700 rounded p-3 text-white"></div></div>
                <div><label class="text-xs font-bold text-slate-300 uppercase mb-2 block">Contact Details</label><div class="grid grid-cols-2 gap-3"><input type="text" id="brandPhone" placeholder="Phone" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white"><input type="text" id="brandViber" placeholder="Viber" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white"><input type="text" id="brandFB" placeholder="FB Link" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white"><input type="text" id="brandTT" placeholder="TikTok Link" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white"></div><input type="text" id="brandAddr" placeholder="Address" class="mt-3 w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white"></div>
                <div class="pt-4 flex flex-col items-center gap-2"><button onclick="window.saveBrandData()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition active:scale-95"><i class="ph ph-floppy-disk"></i> Save Changes to Cloud</button><div id="saveStatus" class="text-xs text-slate-400">Ready.</div></div>
            </div>
        </div>
    </div>
  </template>

  <!-- FB, TIKTOK, TIMELINE, POSE, RECENT (Condensed for length, logic same) -->
  <template id="tpl-fbpost"><div class="animate-fade-in space-y-6"><h2 class="text-xl font-bold text-white flex gap-2"><i class="ph ph-facebook-logo text-blue-500"></i> Facebook Post</h2><div class="glass-panel p-4 rounded-xl space-y-4"><div class="flex gap-2"><input type="text" id="fbInput" placeholder="Topic..." class="flex-1 bg-slate-800 border-slate-700 rounded p-3 text-white"><button onclick="window.startVoiceInput('fbInput', this)" class="bg-slate-800 rounded px-4 text-blue-400"><i class="ph ph-microphone text-xl"></i></button></div><div class="grid grid-cols-2 gap-4"><select id="fbTone" class="bg-slate-800 border-slate-700 rounded p-3 text-white"><option>Professional</option><option>Friendly</option></select><select id="fbLength" class="bg-slate-800 border-slate-700 rounded p-3 text-white"><option>Medium</option><option>Long</option></select></div><button onclick="window.generateAI('fbpost')" class="w-full bg-blue-600 py-3 rounded font-bold text-white">Write Post</button></div><div id="fbResultArea" class="hidden glass-panel p-4 rounded-xl"><div id="fbOutput" class="whitespace-pre-wrap text-sm text-slate-200"></div><button id="fbContinueBtn" onclick="window.continueAI('fbpost')" class="hidden w-full mt-3 py-2 bg-slate-800 text-blue-300 rounded text-sm">‚ö†Ô∏è Continue</button><button onclick="window.copyText('fbOutput')" class="w-full mt-2 py-2 border border-slate-700 rounded text-slate-300 text-sm">Copy</button></div></div></template>
  <template id="tpl-tiktok"><div class="animate-fade-in space-y-6"><h2 class="text-xl font-bold text-teal-400 flex gap-2"><i class="ph ph-tiktok-logo"></i> TikTok Script</h2><div class="glass-panel p-4 rounded-xl space-y-4"><div class="flex gap-2"><input type="text" id="ttInput" placeholder="Topic..." class="flex-1 bg-slate-800 border-slate-700 rounded p-3 text-white"><button onclick="window.startVoiceInput('ttInput', this)" class="bg-slate-800 rounded px-4 text-teal-400"><i class="ph ph-microphone text-xl"></i></button></div><select id="ttStyle" class="w-full bg-slate-800 border-slate-700 rounded p-3 text-white"><option>Trending</option><option>Vlog</option></select><div class="grid grid-cols-2 gap-3"><button onclick="window.generateAI('tt_caption')" class="bg-slate-700 py-3 rounded text-white font-bold">Caption</button><button onclick="window.generateAI('tt_script')" class="bg-teal-600 py-3 rounded text-white font-bold">Script</button></div></div><div id="ttResultArea" class="hidden glass-panel p-4 rounded-xl"><div id="ttOutput" class="whitespace-pre-wrap text-sm text-slate-200"></div><button id="ttContinueBtn" onclick="window.continueAI('tt_script')" class="hidden w-full mt-2 py-2 bg-slate-800 text-teal-400 rounded">‚ö†Ô∏è Continue</button><button onclick="window.copyText('ttOutput')" class="mt-2 text-xs bg-slate-800 px-4 py-2 rounded">Copy</button></div></div></template>
  <template id="tpl-timeline"><div class="animate-fade-in space-y-6"><h2 class="text-xl font-bold text-orange-400 flex gap-2"><i class="ph ph-clock"></i> Timeline</h2><div class="glass-panel p-4 rounded-xl"><div class="grid grid-cols-2 gap-4 mb-4"><select id="tlStart" class="bg-slate-800 border-slate-700 rounded p-2 text-white"><option>6:00 AM</option><option>8:00 AM</option></select><select id="tlPlace" class="bg-slate-800 border-slate-700 rounded p-2 text-white"><option>Taunggyi</option><option>Inle</option></select><select id="tlDress" class="bg-slate-800 border-slate-700 rounded p-2 text-white"><option>3 Dresses</option></select><select id="tlPace" class="bg-slate-800 border-slate-700 rounded p-2 text-white"><option>Relaxed</option><option>Packed</option></select></div><div class="flex gap-2 mb-4"><input type="checkbox" id="tlSunset"><label for="tlSunset" class="text-sm text-slate-300">Sunset</label></div><button onclick="window.generateAI('timeline')" class="w-full bg-orange-600 py-3 rounded text-white font-bold">Generate</button></div><div id="tlResultArea" class="hidden glass-panel p-4 rounded-xl"><div id="tlOutput" class="whitespace-pre-wrap text-sm text-slate-200 font-mono"></div><button id="tlContinueBtn" onclick="window.continueAI('timeline')" class="hidden w-full mt-2 py-2 bg-slate-800 text-orange-400 rounded">‚ö†Ô∏è Continue</button><button onclick="window.copyText('tlOutput')" class="w-full mt-2 py-2 border border-slate-700 rounded text-slate-300">Copy</button></div></div></template>
  <template id="tpl-pose"><div class="animate-fade-in space-y-6"><h2 class="text-xl font-bold text-pink-400 flex gap-2"><i class="ph ph-camera"></i> Pose Helper</h2><div class="glass-panel p-4 rounded-xl space-y-4"><div class="grid grid-cols-2 gap-3"><select id="poseOutfit" class="bg-slate-800 border-slate-700 rounded p-2 text-white"><option>Gown</option><option>Traditional</option></select><input type="text" id="poseProps" placeholder="Props..." class="bg-slate-800 border-slate-700 rounded p-2 text-white"></div><div class="flex gap-2"><button onclick="window.fillPose('Shy')" class="px-3 py-1 bg-pink-900/30 text-pink-200 text-xs rounded">üò≥ Shy</button><button onclick="window.fillPose('Plus')" class="px-3 py-1 bg-pink-900/30 text-pink-200 text-xs rounded">‚ù§Ô∏è Plus</button></div><div class="relative"><textarea id="poseInput" class="w-full bg-slate-800 border-slate-700 rounded p-3 text-white h-24" placeholder="Situation..."></textarea><button onclick="window.startVoiceInput('poseInput', this)" class="absolute right-2 bottom-2 bg-slate-700/80 p-2 rounded-full text-white"><i class="ph ph-microphone"></i></button></div><button onclick="window.generateAI('pose')" class="w-full bg-pink-600 py-3 rounded text-white font-bold">Generate</button></div><div id="poseResultArea" class="hidden glass-panel p-4 rounded-xl"><div id="poseOutput" class="whitespace-pre-wrap text-sm text-slate-200"></div></div></div></template>
  <template id="tpl-recent"><div class="animate-fade-in space-y-6"><div class="flex justify-between items-center"><h2 class="text-xl font-bold text-white flex gap-2"><i class="ph ph-clock-counter-clockwise text-green-400"></i> History</h2><button onclick="window.clearHistory()" class="text-red-400 text-xs border border-red-900 px-3 py-1 rounded">Clear</button></div><div id="historyListContainer" class="space-y-4 pb-20"></div></div></template>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyBEqE5lWdLWIZOO_M3RYY35e17VMTGk-G0", authDomain: "saiai-content-generator.firebaseapp.com", projectId: "saiai-content-generator", storageBucket: "saiai-content-generator.firebasestorage.app", messagingSenderId: "574947512372", appId: "1:574947512372:web:1d35a5b5aa6f24ea493a61", measurementId: "G-C2Q8Y2XBMD" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'with-you-studio-v4';
    let userId = null;

    const getValue = (id) => { const el = document.getElementById(id); return el ? el.value : ""; };
    
    window.handleLogin = async () => {
        try { await signInWithEmailAndPassword(auth, getValue('loginEmail'), getValue('loginPass')); } 
        catch(e) { const err = document.getElementById('loginError'); err.classList.remove('hidden'); document.getElementById('loginErrorText').innerText = e.message; }
    };
    window.handleLogout = async () => { await signOut(auth); window.location.reload(); };

    onAuthStateChanged(auth, (user) => {
        const overlay = document.getElementById('loginOverlay');
        if (user) {
            userId = user.uid;
            document.getElementById('connectionStatus').classList.replace('bg-red-500', 'bg-green-500');
            document.getElementById('userEmailDisplay').innerText = user.email;
            overlay.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => overlay.classList.add('hidden'), 300);
            if(window.currentView === 'brand') loadBrandData();
            if(window.currentView === 'recent') renderHistoryList();
        } else {
            userId = null;
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0', 'pointer-events-none'), 50);
        }
    });

    window.currentView = 'manager'; 
    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        if (sidebar.classList.contains('sidebar-closed')) { sidebar.classList.remove('sidebar-closed'); sidebar.classList.add('sidebar-open'); overlay.classList.remove('hidden'); }
        else { sidebar.classList.add('sidebar-closed'); sidebar.classList.remove('sidebar-open'); overlay.classList.add('hidden'); }
    }
    window.loadView = function(viewId) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navBtn = document.getElementById('nav-' + viewId);
        if(navBtn) navBtn.classList.add('active');
        if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('sidebar-closed'); document.getElementById('overlay').classList.add('hidden'); }
        const container = document.getElementById('content-container');
        container.innerHTML = ''; 
        let templateId = 'tpl-' + viewId;
        const tpl = document.getElementById(templateId);
        if(tpl) {
            container.appendChild(tpl.content.cloneNode(true));
            if(viewId === 'brand') loadBrandData();
            if(viewId === 'recent') renderHistoryList();
            if(viewId === 'manager') loadChatHistory(); // Load previous chat session if any
        }
        window.currentView = viewId;
    }

    // --- NEW: CHAT MANAGER LOGIC ---
    // This function handles the chat flow for the AI Manager tab
    
    // Simple in-memory or session storage for chat history to persist during session
    let chatHistory = []; 

    window.handleChatSubmit = async function() {
        const inputEl = document.getElementById('chatInput');
        const text = inputEl.value.trim();
        if(!text) return;
        
        // 1. Add User Message to UI
        addMessageToUI('user', text);
        inputEl.value = '';
        
        // 2. Add loading bubble
        const loadingId = addMessageToUI('ai', 'Thinking...', true);
        
        // 3. Construct Context-Aware Prompt
        let brand = {};
        if(userId) { try { const s = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand')); if(s.exists()) brand = s.data(); } catch(e){} }
        
        // Fetch last 3 saved decisions for context
        let savedDecisions = [];
        if(userId) {
             const q = query(collection(db, 'artifacts', appId, 'users', userId, 'decisions'), orderBy('timestamp', 'desc'), limit(3));
             const snaps = await getDocs(q); // Need getDocs import
             snaps.forEach(d => savedDecisions.push(d.data().content));
        }

        const packages = brand.brandPackages || "Not set";
        const style = brand.brandStyle || "Professional";
        
        const systemPrompt = `
        ROLE: Ko Sai's Business Partner & AI Manager for "With You Studio" (Taunggyi).
        TONE: Natural, warm, "Bya" ending. Chat like a human friend.
        MEMORY:
        - Studio Style: ${style}
        - Recent Decisions (Ko Sai liked these): ${savedDecisions.join('; ')}
        - Packages: ${packages}
        
        TASK: Respond to "${text}".
        - If asking "what to do", give 1 clear direction or 3 options.
        - If asking for content, give a specific idea.
        - If venting, be supportive.
        - Keep it concise (chat bubble style).
        `;
        
        try {
            const res = await fetch("/api/generate", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: systemPrompt })
            });
            const d = await res.json();
            
            // Remove loading, add real message
            document.getElementById(loadingId).remove();
            const msgId = addMessageToUI('ai', d.result);
            
            // Add "Save Decision" button to this AI response
            addSaveButton(msgId, d.result);
            
        } catch(e) {
            document.getElementById(loadingId).innerText = "Error connecting...";
        }
    };
    
    // Wrapper for chip buttons
    window.sendChat = function(text) {
        document.getElementById('chatInput').value = text;
        window.handleChatSubmit();
    }

    function addMessageToUI(role, text, isLoading=false) {
        const container = document.getElementById('chatContainer');
        const div = document.createElement('div');
        const id = 'msg-' + Date.now();
        div.id = id;
        div.className = 'flex w-full ' + (role === 'user' ? 'justify-end' : 'justify-start');
        
        let content = text;
        if(isLoading) content = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
        else content = text.replace(/\n/g, '<br>');

        div.innerHTML = `
            <div class="${role === 'user' ? 'chat-bubble-user max-w-[80%]' : 'flex items-start gap-3 max-w-[85%]'}">
                ${role === 'ai' ? '<div class="w-8 h-8 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400 border border-yellow-500/30 shrink-0"><i class="ph ph-robot"></i></div>' : ''}
                <div class="${role === 'ai' ? 'chat-bubble-ai' : ''}">${content}</div>
            </div>
        `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return id;
    }
    
    function addSaveButton(msgId, content) {
        const msgEl = document.getElementById(msgId).querySelector('.chat-bubble-ai');
        const btn = document.createElement('button');
        btn.className = "mt-2 text-[10px] flex items-center gap-1 text-slate-400 hover:text-yellow-400 transition";
        btn.innerHTML = `<i class="ph ph-star"></i> Save Decision`;
        btn.onclick = () => window.saveDecision(content, btn);
        msgEl.appendChild(btn);
    }
    
    window.saveDecision = async function(content, btnElement) {
        if(!userId) return window.showToast("Login to save");
        try {
            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'decisions'), {
                content: content,
                timestamp: Date.now()
            });
            btnElement.innerHTML = `<i class="ph ph-star-fill text-yellow-400"></i> Saved`;
            btnElement.classList.add('text-yellow-400');
            window.showToast("Memory Updated!");
        } catch(e) { console.error(e); }
    }
    
    function loadChatHistory() {
        // Optional: Load previous chat from session storage or firestore
        // For now, it starts fresh each session as per "Today's Direction" concept
    }
    
    // Need to import getDocs for the context feature
    import { getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


    // --- OLD LOGIC PRESERVED BELOW (Standard Generators) ---
    // ... [Previous setCreativeOption, saveBrandData, loadBrandData, saveToRecents, renderHistoryList, generateAI, etc. functions remain identical] ...
    
    window.setCreativeOption = function(type, value, btn) {
        if(type === 'workload') {
            document.getElementById('crWorkload').value = value;
            document.querySelectorAll('.creative-btn').forEach(b => b.classList.remove('active')); 
            if(btn && btn.parentElement) {
                Array.from(btn.parentElement.children).forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
            }
        }
    };

    window.saveBrandData = async function() {
        if (!userId) { window.showToast("Login required!"); return; }
        const statusEl = document.getElementById('saveStatus');
        if(statusEl) statusEl.innerText = "Saving...";
        const ids = ['brandStyle', 'brandClient', 'brandPhone', 'brandViber', 'brandFB', 'brandTT', 'brandAddr', 'brandPackages'];
        const data = {};
        ids.forEach(id => { const el = document.getElementById(id); if(el) data[id] = el.value; });
        try { 
            await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand'), data, {merge: true}); 
            if(statusEl) { statusEl.innerText = "Cloud Saved ‚úÖ"; statusEl.classList.add('text-green-400'); }
            window.showToast("Cloud Save Success!"); 
        } catch (e) { console.error(e); }
    }
    window.loadBrandData = async function() {
        if (!userId) return;
        try {
            const docSnap = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand'));
            if (docSnap.exists()) { const data = docSnap.data(); for (const [key, value] of Object.entries(data)) { const el = document.getElementById(key); if(el) el.value = value; } }
        } catch(e) { console.error(e); }
    }
    async function saveToRecents(type, content, topic) {
        if (!userId) return;
        try { await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'history'), { type: type, topic: topic || "Generated Content", content: content, date: new Date().toLocaleString(), timestamp: Date.now() }); } catch(e) { console.error(e); }
    }
    function renderHistoryList() {
        if (!userId) return;
        const c = document.getElementById('historyListContainer');
        if(!c) return;
        const q = query(collection(db, 'artifacts', appId, 'users', userId, 'history'), orderBy('timestamp', 'desc'), limit(30));
        onSnapshot(q, (snapshot) => {
            const items = [];
            snapshot.forEach((doc) => { items.push({ id: doc.id, ...doc.data() }); });
            c.innerHTML = items.length ? items.map(i=>`<div class="glass-panel p-4 rounded-lg border-l-4 border-green-500 mb-2 group relative"><div class="flex justify-between items-start mb-2"><div><span class="font-bold text-white text-sm block">${i.topic}</span><span class="text-[10px] text-slate-400 uppercase bg-slate-800 px-1.5 rounded">${i.type}</span></div><span class="text-[10px] text-slate-500">${i.date}</span></div><div class="text-xs text-slate-300 line-clamp-3 bg-slate-900/50 p-2 rounded cursor-pointer hover:bg-slate-900 transition" onclick="window.toggleExpand(this)">${i.content}</div><div class="mt-2 text-right flex justify-end gap-2"><button onclick="window.copyText('${i.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')" class="text-blue-400 text-xs hover:text-white border border-blue-500/30 px-2 py-1 rounded">Copy</button></div></div>`).join('') : "<div class='text-center text-slate-500 py-10'>No recent activity.</div>";
        });
    }

    // Classic Generator logic (for other tabs)
    window.generateAI = async function(type, isContinue = false) {
        const outputIds = { 'fbpost': 'fbOutput', 'dm_best': 'dmOutput', 'timeline': 'tlOutput', 'tt_caption': 'ttOutput', 'tt_script': 'ttOutput', 'pose': 'poseOutput', 'creative_director': 'crOutput', 'creative_post': 'crOutput', 'creative_tt_text': 'crOutput', 'dm_auto_detect': 'dmOutput' };
        const areaIds = { 'fbpost': 'fbResultArea', 'dm_best': 'dmResultArea', 'timeline': 'tlResultArea', 'tt_caption': 'ttResultArea', 'tt_script': 'ttResultArea', 'pose': 'poseResultArea', 'creative_director': 'crResultArea', 'creative_post': 'crResultArea', 'creative_tt_text': 'crResultArea', 'dm_auto_detect': 'dmResultArea' };
        const outId = outputIds[type];
        const areaId = areaIds[type];

        if(type !== 'dm_analyze') {
             const areaEl = document.getElementById(areaId);
             if (areaEl) areaEl.classList.remove('hidden');
             if(!isContinue) {
                const outEl = document.getElementById(outId);
                if (outEl) outEl.innerHTML = "<span class='animate-pulse text-purple-400'>‚ú® Thinking...</span>";
                if(window.innerWidth < 768) {
                    if((type.includes('creative'))) {
                        const mobEl = document.getElementById('crResultAreaMobile');
                        if (mobEl) mobEl.classList.remove('hidden');
                    }
                    const scrollId = (type.includes('creative')) ? 'crResultAreaMobile' : areaId;
                    const scrollTarget = document.getElementById(scrollId);
                    if (scrollTarget) {
                        setTimeout(() => scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                    }
                }
            }
        } else {
             const panel = document.getElementById('dmAnalysisPanel');
             if(panel) { 
                 panel.classList.remove('hidden'); 
                 const content = document.getElementById('dmAnalysisContent');
                 if(content) content.innerHTML = "<span class='animate-pulse text-indigo-400'>üîç Analyzing...</span>"; 
             }
        }

        let brand = {};
        if(userId) { try { const s = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand')); if(s.exists()) brand = s.data(); } catch(e){} }
        const packages = brand.brandPackages || "Not set";
        const contact = `Ph: ${brand.brandPhone||''}, Viber: ${brand.brandViber||''}`;
        const baseSystem = `Role: Owner of With You Studio. Tone: Natural Burmese (Bya/Khamya), Warm. Data: ${packages}, ${contact}. IMPORTANT: Use complete sentences.`;
        
        let prompt = "";
        let contextTopic = "";
        
        // ... (Existing switch cases for other tabs remain same) ...
        if (type === 'creative_director') {
             prompt = `Task: Create a 3-Day Mini Content Plan. Input: Energy=${getValue('crWorkload')}, Focus=${getValue('crFocus')}. Output: Checklist format in Burmese.`;
             contextTopic = `Creative Plan`;
        }
        else if (type === 'creative_post') {
             prompt = `Task: Write a social media post about ${getValue('crFocus')}. Goal: Bookings. Tone: Emotional.`;
             contextTopic = `Creative Post`;
        }
        else if (type === 'creative_tt_text') {
             prompt = `Task: Write TikTok Text Mode post about ${getValue('crFocus')}. Under 500 chars.`;
             contextTopic = `TikTok Text`;
        }
        else if (type === 'dm_auto_detect') { 
             prompt = `Task: Analyze client message "${getValue('dmInput')}" and write BEST reply.`;
             contextTopic = `Auto DM Reply`;
        }
        else if (type === 'dm_analyze') {
            const msg = getValue('dmInput');
            prompt = `ROLE: Strategist. TASK: Analyze "${msg}". Output: Status, Reason, NextAction.`;
        }
        else if (type === 'dm_best') {
             prompt = `Task: Write 3 Sales Replies. Client: "${getValue('dmInput')}". Context: ${getValue('dmService')}.`;
             contextTopic = `DM: ${getValue('dmService')}`;
        } else if(type === 'fbpost') {
             prompt = `Task: Write 3 FB Post Variations. Topic: ${getValue('fbInput')}.`;
             contextTopic = `FB: ${getValue('fbInput')}`;
        } else if(type === 'timeline') {
             prompt = `Task: Wedding Timeline. Start: ${getValue('tlStart')}.`;
             contextTopic = `Timeline`;
        } else if(type.includes('tt_')) {
             prompt = `Task: TikTok Script. Topic: ${getValue('ttInput')}.`;
             contextTopic = `TikTok`;
        } else if(type === 'pose') {
             prompt = `Task: 3 Pose Ideas. Context: ${getValue('poseInput')}.`;
             contextTopic = `Pose`;
        }

        try {
            const res = await fetch("/api/generate", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: baseSystem + "\n\n" + prompt })
            });
            const d = await res.json();
            
            if(type === 'dm_analyze') {
                const html = `<div class='text-slate-300'>${d.result.replace(/\n/g, '<br>')}</div>`;
                document.getElementById('dmAnalysisContent').innerHTML = html;
            } else {
                const outEl = document.getElementById(outId);
                if(outEl) {
                    if(isContinue) outEl.innerText += "\n" + d.result;
                    else outEl.innerText = d.result;
                    
                    if(type.includes('creative') && document.getElementById('crOutputMobile')) {
                        document.getElementById('crOutputMobile').innerText = outEl.innerText;
                    }
                    if(d.result && !d.result.includes("Error")) {
                         saveToRecents(type, outEl.innerText, contextTopic);
                    }
                }
                const btn = document.getElementById(continueBtnIds[type]);
                if(btn) btn.classList.remove('hidden');
            }
        } catch(e) { console.error(e); }
    };

    window.continueAI = (t) => window.generateAI(t, true);
    window.showToast = (m) => { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); };
    window.copyText = (id) => { navigator.clipboard.writeText(document.getElementById(id).innerText); window.showToast("Copied"); };
    window.setDmType = (t, b) => { document.getElementById('dmType').value = t; document.querySelectorAll('.tactic-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
    window.fillPose = (t) => { document.getElementById('poseInput').value = t === 'Shy' ? "·Ä°·Äõ·Äô·Ä∫·Ä∏·Äõ·Äæ·ÄÄ·Ä∫·Äê·Äê·Ä∫·Äê·Äö·Ä∫" : "·Äù·Äê·Ä≤·Ä∑·Ä°·Äê·ÄΩ·Ä≤"; };
    window.startVoiceInput = (id, btn) => {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR) return window.showToast("No Voice Support");
        const r = new SR(); r.lang = 'my-MM'; r.start();
        btn.classList.add('listening-ring');
        r.onresult = (e) => { document.getElementById(id).value += " " + e.results[0][0].transcript; window.showToast("Heard!"); };
        r.onend = () => btn.classList.remove('listening-ring');
    };
    window.clearHistory = () => { if(userId && confirm("Clear?")) window.showToast("Clearing local view (Cloud persists)"); };
    window.toggleExpand = (el) => { if(el.classList.contains('line-clamp-3')) el.classList.remove('line-clamp-3'); else el.classList.add('line-clamp-3'); };
    window.downloadFile = (n, id) => { const b = new Blob([document.getElementById(id).innerText],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=n; a.click(); };

    window.loadView('manager'); // Start with new Manager
  </script>
</body>
</html>
