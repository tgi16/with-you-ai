<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>With You Studio - Sales Master AI v4.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap" rel="stylesheet">
  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    body { font-family: 'Padauk', sans-serif; }
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    
    .glass-panel {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-item.active, .mobile-nav-item.active {
        background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        border-color: transparent;
    }

    .tactic-btn.active {
        background-color: #7e22ce; 
        border-color: #a855f7;
        color: white;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);
    }

    #sidebar { transition: transform 0.3s ease-in-out; }
    .sidebar-open { transform: translateX(0) !important; }
    .sidebar-closed { transform: translateX(-100%); }
    @media (min-width: 768px) { .sidebar-closed { transform: translateX(0); } }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .listening-ring {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        animation: pulse-red 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        border-color: #ef4444 !important; color: #ef4444 !important;
    }
    @keyframes pulse-red { to { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
    
    /* Analysis Status Colors */
    .status-ready { color: #34d399; border-color: #34d399; background: rgba(52, 211, 153, 0.1); }
    .status-thinking { color: #fbbf24; border-color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
    .status-notready { color: #60a5fa; border-color: #60a5fa; background: rgba(96, 165, 250, 0.1); }
  </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen h-[100dvh] flex overflow-hidden">

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="fixed inset-0 z-[60] bg-slate-950 flex flex-col items-center justify-center p-6 transition-opacity duration-300">
    <div class="glass-panel p-8 rounded-2xl w-full max-w-sm border border-slate-700 shadow-2xl flex flex-col items-center space-y-6">
        <div class="text-center">
            <div class="w-16 h-16 bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/30">
                <i class="ph ph-lock-key text-3xl text-blue-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-white">With You Studio</h2>
            <p class="text-sm text-slate-400 mt-1">AI Sales Assistant Login</p>
        </div>
        
        <div class="w-full space-y-4">
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Email</label>
                <div class="relative">
                    <i class="ph ph-envelope absolute left-3 top-3 text-slate-500 text-lg"></i>
                    <input type="email" id="loginEmail" placeholder="admin@studio.com" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 pl-10 text-white focus:border-blue-500 outline-none transition placeholder-slate-600">
                </div>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Password</label>
                <div class="relative">
                    <i class="ph ph-key absolute left-3 top-3 text-slate-500 text-lg"></i>
                    <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 pl-10 text-white focus:border-blue-500 outline-none transition placeholder-slate-600">
                </div>
            </div>
            <button onclick="window.handleLogin()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-900/50 transition active:scale-95 flex justify-center gap-2 items-center">
                <span>Sign In</span>
                <i class="ph ph-arrow-right"></i>
            </button>
        </div>
        
        <p id="loginError" class="text-red-400 text-xs text-center hidden bg-red-900/20 p-2 rounded w-full border border-red-900/50"></p>
    </div>
  </div>

  <!-- OVERLAY for Mobile Sidebar -->
  <div id="overlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass-panel"></div>

  <!-- SIDEBAR NAVIGATION -->
  <aside id="sidebar" class="sidebar-closed fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 border-r border-slate-800 flex flex-col transition-transform duration-300 md:relative md:translate-x-0 shadow-2xl">
    <div class="p-6 border-b border-slate-800 flex items-center justify-between">
        <div>
            <h1 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
                <i class="ph ph-camera text-blue-400"></i> With You
            </h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1 flex items-center gap-1">
                <span id="connectionStatus" class="w-2 h-2 rounded-full bg-red-500"></span> Online
            </p>
        </div>
        <button onclick="window.toggleSidebar()" class="md:hidden text-slate-400"><i class="ph ph-x text-xl"></i></button>
    </div>

    <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-6">
        <div>
            <p class="px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Priority</p>
            <div class="space-y-1">
                <!-- NEW CREATIVE DIRECTOR TAB -->
                <button onclick="window.loadView('creative')" id="nav-creative" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-lightbulb text-lg text-yellow-400"></i> What to Post Today?
                </button>
                <button onclick="window.loadView('dm')" id="nav-dm" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-chat-circle-text text-lg text-purple-400"></i> DM Sales Master
                </button>
                <button onclick="window.loadView('brand')" id="nav-brand" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-brain text-lg text-blue-400"></i> Brand Brain
                </button>
            </div>
        </div>
        <div>
            <p class="px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Content Marketing</p>
            <div class="space-y-1">
                <button onclick="window.loadView('fbpost')" id="nav-fbpost" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-facebook-logo text-lg"></i> Facebook Post
                </button>
                <button onclick="window.loadView('tiktok')" id="nav-tiktok" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-tiktok-logo text-lg"></i> TikTok Script
                </button>
            </div>
        </div>
        <div>
            <p class="px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Studio Ops</p>
            <div class="space-y-1">
                <button onclick="window.loadView('timeline')" id="nav-timeline" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-clock text-lg"></i> Timeline
                </button>
                <button onclick="window.loadView('pose')" id="nav-pose" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-camera"></i> Pose Helper
                </button>
            </div>
        </div>
        <div>
            <div class="space-y-1 border-t border-slate-800 pt-4">
                <button onclick="window.loadView('recent')" id="nav-recent" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition group relative">
                    <i class="ph ph-clock-counter-clockwise text-lg group-hover:text-green-400"></i> 
                    <span>Recent Activity</span>
                    <span id="recentBadge" class="hidden absolute right-3 top-3 w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                </button>
            </div>
        </div>
    </nav>

    <div class="p-4 border-t border-slate-800 text-xs text-slate-600 text-center">
        <div id="userEmailDisplay" class="text-[10px] text-blue-400 mb-2 truncate">Checking Auth...</div>
        <button onclick="window.handleLogout()" class="w-full py-2 border border-red-900/30 rounded text-red-400 hover:bg-red-900/20 transition flex items-center justify-center gap-1">
            <i class="ph ph-sign-out"></i> Logout
        </button>
    </div>
  </aside>

  <!-- MAIN CONTENT AREA (RIGHT) -->
  <div class="flex-1 flex flex-col h-full relative w-full">
    <header class="md:hidden h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 z-30 shrink-0">
        <button onclick="window.toggleSidebar()" class="text-white p-2"><i class="ph ph-list text-2xl"></i></button>
        <span class="font-bold text-blue-400 text-lg">With You Studio</span>
        <div class="w-8"></div>
    </header>

    <!-- MOBILE QUICK NAV -->
    <div class="md:hidden bg-slate-900/90 border-b border-slate-800 overflow-x-auto no-scrollbar py-2 px-3 flex gap-2 shrink-0 backdrop-blur-sm z-20 sticky top-0">
        <!-- New Creative Tab for Mobile -->
        <button onclick="window.loadView('creative')" id="mob-creative" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-800">
            <i class="ph ph-lightbulb text-yellow-400"></i> Ideas
        </button>
        <button onclick="window.loadView('dm')" id="mob-dm" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-800">
            <i class="ph ph-chat-circle-text text-purple-400"></i> DM
        </button>
        <button onclick="window.loadView('fbpost')" id="mob-fbpost" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-800">
            <i class="ph ph-facebook-logo"></i> Post
        </button>
        <button onclick="window.loadView('tiktok')" id="mob-tiktok" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-800">
            <i class="ph ph-tiktok-logo"></i> TikTok
        </button>
        <button onclick="window.loadView('brand')" id="mob-brand" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-800">
            <i class="ph ph-brain"></i> Brain
        </button>
        <button onclick="window.loadView('timeline')" id="mob-timeline" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-800">
            <i class="ph ph-clock"></i> Timeline
        </button>
        <button onclick="window.loadView('pose')" id="mob-pose" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-800">
            <i class="ph ph-camera"></i> Pose
        </button>
        <button onclick="window.loadView('recent')" id="mob-recent" class="mobile-nav-item flex items-center gap-2 px-4 py-2 rounded-full border border-slate-700 text-xs font-bold text-slate-300 whitespace-nowrap bg-slate-800">
            <i class="ph ph-clock-counter-clockwise text-green-400"></i> Recent
        </button>
    </div>

    <!-- Dynamic Content Container -->
    <div id="content-container" class="flex-1 overflow-y-auto p-4 md:p-8 max-w-4xl mx-auto w-full pb-20 scroll-smooth">
        <!-- Content injects here via JS -->
    </div>
  </div>

  <div id="toast" class="toast">Action Complete</div>

  <!-- TEMPLATES -->
  
  <!-- 0. CREATIVE DIRECTOR TEMPLATE (NEW) -->
  <template id="tpl-creative">
    <div class="animate-fade-in space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl md:text-2xl font-bold text-yellow-400 flex items-center gap-2"><i class="ph ph-lightbulb"></i> Creative Director</h2>
            <div class="text-[10px] text-slate-400 bg-slate-800 px-2 py-1 rounded">Idea Generator</div>
        </div>
        
        <div class="glass-panel p-6 rounded-xl border border-yellow-500/20 shadow-lg relative overflow-hidden">
            <i class="ph ph-sparkle absolute -top-4 -right-4 text-9xl text-yellow-500 opacity-10"></i>
            
            <p class="text-sm text-slate-300 mb-6 relative z-10">
                "·Äí·ÄÆ·Äî·Ä±·Ä∑ ·Äò·Ä¨·Äê·ÄÑ·Ä∫·Äõ·Äô·Äú·Ä≤?" ·Äú·Ä≠·ÄØ·Ä∑ ·ÄÖ·Äâ·Ä∫·Ä∏·ÄÖ·Ä¨·Ä∏·Äõ·ÄÅ·ÄÄ·Ä∫·Äî·Ä±·Äú·Ä¨·Ä∏·Åã ·ÄÄ·Ä≠·ÄØ·ÄÖ·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äõ·Ä≤·Ä∑ Brand Brain ·ÄÄ·Ä≠·ÄØ·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·ÅÉ ·Äõ·ÄÄ·Ä∫·ÄÖ·Ä¨ Plan ·ÄÜ·ÄΩ·Ä≤·Äï·Ä±·Ä∏·Äï·Ä´·Äô·Äö·Ä∫·Åã
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
                <!-- Inputs -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Today's Workload (·Ä°·Äú·ÄØ·Äï·Ä∫·Äõ·Äæ·ÄØ·Äï·Ä∫·Äú·Ä¨·Ä∏)</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setCreativeOption('workload', 'Busy', this)" class="creative-btn p-3 rounded-lg border border-slate-600 bg-slate-800 hover:bg-slate-700 text-xs font-bold text-center transition">Busy<br>ü•µ</button>
                            <button onclick="setCreativeOption('workload', 'Normal', this)" class="creative-btn active p-3 rounded-lg border border-slate-600 bg-slate-800 hover:bg-slate-700 text-xs font-bold text-center transition">Normal<br>üòê</button>
                            <button onclick="setCreativeOption('workload', 'Free', this)" class="creative-btn p-3 rounded-lg border border-slate-600 bg-slate-800 hover:bg-slate-700 text-xs font-bold text-center transition">Motivated<br>ü§©</button>
                        </div>
                        <input type="hidden" id="crWorkload" value="Normal">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Focus Area (·Äò·Ä¨·Ä°·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äê·ÄÑ·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Äú·Ä≤)</label>
                        <select id="crFocus" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-yellow-500 outline-none">
                            <option value="Anything">üé≤ Anything (Best Choice)</option>
                            <option value="Pre-Wedding">üíç Pre-Wedding Focus</option>
                            <option value="Wedding Day">üë∞ Wedding Day</option>
                            <option value="Studio Branding">üè¢ Studio Branding</option>
                            <option value="Family Portrait">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family / Portrait</option>
                        </select>
                    </div>

                    <div class="pt-2">
                         <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Platforms</label>
                         <div class="flex gap-4">
                             <label class="flex items-center gap-2 cursor-pointer">
                                 <input type="checkbox" id="crFB" checked class="w-4 h-4 rounded bg-slate-700 border-slate-600 text-blue-500 focus:ring-0">
                                 <span class="text-sm text-slate-300">Facebook</span>
                             </label>
                             <label class="flex items-center gap-2 cursor-pointer">
                                 <input type="checkbox" id="crTT" checked class="w-4 h-4 rounded bg-slate-700 border-slate-600 text-teal-500 focus:ring-0">
                                 <span class="text-sm text-slate-300">TikTok</span>
                             </label>
                         </div>
                    </div>

                    <button onclick="window.generateAI('creative_director')" class="w-full mt-2 bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-yellow-900/30 transition active:scale-95 flex items-center justify-center gap-2">
                        <i class="ph ph-magic-wand text-lg"></i> Tell Me What To Post
                    </button>
                </div>

                <!-- Output Area -->
                <div id="crResultArea" class="hidden md:block h-full">
                     <div class="bg-slate-900/50 rounded-xl border border-slate-700 p-4 h-full flex flex-col">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs font-bold text-yellow-400 uppercase">3-Day Plan</span>
                            <button onclick="window.copyText('crOutput')" class="text-[10px] bg-slate-800 px-2 py-1 rounded border border-slate-600 hover:bg-slate-700 transition">Copy</button>
                        </div>
                        <div id="crOutput" class="whitespace-pre-wrap text-sm text-slate-200 leading-relaxed flex-1 overflow-y-auto max-h-[400px] custom-scroll"></div>
                     </div>
                </div>
            </div>
            
            <!-- Mobile Output (Only visible on small screens after gen) -->
            <div id="crResultAreaMobile" class="md:hidden hidden mt-6">
                <div class="bg-slate-900/50 rounded-xl border border-slate-700 p-4">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-yellow-400 uppercase">Your Plan</span>
                        <button onclick="window.copyText('crOutputMobile')" class="text-[10px] bg-slate-800 px-2 py-1 rounded border border-slate-600">Copy</button>
                    </div>
                    <div id="crOutputMobile" class="whitespace-pre-wrap text-sm text-slate-200 leading-relaxed"></div>
                </div>
            </div>

        </div>
    </div>
  </template>

  <!-- 1. DM SALES MASTER TEMPLATE -->
  <template id="tpl-dm">
    <div class="animate-fade-in space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl md:text-2xl font-bold text-purple-400 flex items-center gap-2"><i class="ph ph-chat-circle-text"></i> DM Sales Master</h2>
            <div class="text-[10px] text-slate-400 bg-slate-800 px-2 py-1 rounded">v3.9.1</div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column: Strategy & Input -->
            <div class="space-y-4">
                <div class="glass-panel p-4 md:p-5 rounded-xl space-y-4 border border-purple-500/20 shadow-lg shadow-purple-900/10">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Topic</label>
                            <select id="dmService" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white focus:border-purple-500">
                                <option value="Pre-wedding Package">üíç Pre-wedding</option>
                                <option value="Wedding Actual Day">üë∞ Wedding Day</option>
                                <option value="Family Photoshoot">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</option>
                                <option value="Graduation Photo">üéì Graduation</option>
                                <option value="General Inquiry">‚ùì General</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Status</label>
                            <select id="dmScenario" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white focus:border-purple-500">
                                <option value="New Inquiry">New Inquiry</option>
                                <option value="Price Objection">Expensive (·Äà·Ä±·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏)</option>
                                <option value="Ghosting">Seen (·ÄÖ·Ä¨·Äô·Äï·Äº·Äî·Ä∫)</option>
                                <option value="Comparing">Comparing (·Äö·Äæ·Äâ·Ä∫·Äî·Ä±)</option>
                                <option value="Closing">Ready to Book</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Client Message / Context</label>
                        <div class="relative">
                            <textarea id="dmInput" placeholder="Client ·Äô·Ä±·Ä∏·Äê·Ä≤·Ä∑·ÄÖ·Ä¨ (·Äû·Ä≠·ÄØ·Ä∑) ·Ä°·ÄÅ·Äº·Ä±·Ä°·Äî·Ä±..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm h-32 text-white resize-none focus:border-purple-500 pr-10 shadow-inner"></textarea>
                            <button onclick="window.startVoiceInput('dmInput', this)" class="absolute right-2 bottom-2 bg-slate-700/80 hover:bg-purple-600 p-2 rounded-full transition text-slate-300 hover:text-white" title="Speak"><i class="ph ph-microphone text-lg"></i></button>
                        </div>
                    </div>

                    <button onclick="window.generateAI('dm_analyze')" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95 flex items-center justify-center gap-2 border border-indigo-400/30">
                        <i class="ph ph-magnifying-glass text-lg"></i> Analyze Client
                    </button>
                    
                    <div id="dmAnalysisPanel" class="hidden animate-fade-in bg-slate-900/80 p-4 rounded-xl border border-slate-700 relative">
                        <div class="absolute -top-3 left-4 bg-slate-800 px-2 text-[10px] text-slate-400 uppercase font-bold tracking-wider border border-slate-700 rounded">AI Sales Strategist</div>
                        <div id="dmAnalysisContent" class="space-y-3 text-sm mt-1"></div>
                    </div>

                    <div class="pt-2 border-t border-slate-800">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Manual Actions</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="window.setDmType('Price Defense', this)" class="tactic-btn p-2 border border-slate-600 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-left transition flex items-center gap-2"><i class="ph ph-shield-check text-green-400"></i> Price Defense</button>
                            <button onclick="window.setDmType('Urgency', this)" class="tactic-btn p-2 border border-slate-600 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-left transition flex items-center gap-2"><i class="ph ph-timer text-orange-400"></i> Create Urgency</button>
                        </div>
                        <input type="hidden" id="dmType" value="Soft Close">
                    </div>
                </div>
            </div>

            <div id="dmResultArea" class="hidden h-full">
                <div class="glass-panel p-4 md:p-6 rounded-xl border-purple-500/30 h-full flex flex-col relative overflow-hidden">
                    <div class="flex justify-between items-center mb-3 z-10">
                        <span class="text-xs font-bold text-purple-400 uppercase flex items-center gap-1"><i class="ph ph-check-circle"></i> Generated Reply</span>
                        <div class="flex gap-2"><button onclick="window.copyText('dmOutput')" class="text-xs bg-purple-900/50 hover:bg-purple-800 px-3 py-1.5 rounded text-purple-200 border border-purple-700">Copy</button></div>
                    </div>
                    <div id="dmOutput" class="whitespace-pre-wrap text-sm text-slate-200 leading-relaxed flex-1 overflow-y-auto max-h-[600px] z-10 pr-2 custom-scroll"></div>
                    <button id="dmContinueBtn" onclick="window.continueAI('dm_best')" class="hidden w-full mt-3 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-purple-300 text-sm font-bold flex items-center justify-center gap-2 transition active:scale-95"><span>‚ö†Ô∏è Continue Writing (·ÄÖ·Ä¨·ÄÜ·ÄÄ·Ä∫·Äõ·Ä±·Ä∏·Äï·Ä´)</span><i class="ph ph-arrow-right"></i></button>
                </div>
            </div>
        </div>
    </div>
  </template>

  <!-- 2. BRAND BRAIN TEMPLATE -->
  <template id="tpl-brand">
    <div class="animate-fade-in max-w-2xl mx-auto space-y-6">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 md:p-8 rounded-2xl border border-slate-700 relative overflow-hidden shadow-2xl">
            <h2 class="text-xl md:text-2xl font-bold text-white mb-2 flex items-center gap-2"><i class="ph ph-database"></i> Studio Brain (Cloud Sync)</h2>
            <div class="space-y-6 text-left relative z-10">
                <div class="bg-slate-950/50 p-4 rounded-xl border border-slate-700">
                    <label class="text-xs font-bold text-yellow-400 uppercase mb-2 block flex items-center gap-1"><i class="ph ph-package"></i> Packages & Pricing (Important)</label>
                    <textarea id="brandPackages" placeholder="Example: Silver Package: 3 Lakhs..." class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm text-white h-32 resize-none focus:border-yellow-500"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-blue-400 uppercase">Studio Vibe</label><input type="text" id="brandStyle" value="Moody, Cinematic, Emotional" class="w-full mt-1 bg-slate-950 border border-slate-700 rounded p-3 text-white"></div>
                    <div><label class="text-xs font-bold text-blue-400 uppercase">Target Audience</label><input type="text" id="brandClient" value="Luxury Couples, Young Professionals" class="w-full mt-1 bg-slate-950 border border-slate-700 rounded p-3 text-white"></div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-300 uppercase mb-2 block">Contact Details</label>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="brandPhone" placeholder="Phone" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                        <input type="text" id="brandViber" placeholder="Viber" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                        <input type="text" id="brandFB" placeholder="Facebook Link" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                        <input type="text" id="brandTT" placeholder="TikTok Link" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                    </div>
                    <input type="text" id="brandAddr" placeholder="Address (Taunggyi)" class="mt-3 w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                </div>
                <div class="pt-4 flex flex-col items-center gap-2">
                    <button onclick="window.saveBrandData()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition active:scale-95"><i class="ph ph-floppy-disk"></i> Save Changes to Cloud</button>
                    <div id="saveStatus" class="text-xs text-slate-400">Ready to save.</div>
                </div>
            </div>
        </div>
    </div>
  </template>

  <template id="tpl-fbpost">
    <div class="animate-fade-in space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl md:text-2xl font-bold text-white flex items-center gap-2"><i class="ph ph-facebook-logo text-blue-500"></i> Facebook Post</h2>
            <span class="bg-blue-900/30 text-blue-400 text-[10px] md:text-xs px-2 py-1 rounded border border-blue-500/30">3 Options</span>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <div class="glass-panel p-4 md:p-5 rounded-xl space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Topic</label>
                        <div class="flex gap-2">
                            <input type="text" id="fbInput" placeholder="·Ä•·Äï·Äô·Ä¨ - Pre-wedding package..." class="flex-1 w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none text-white">
                            <button onclick="window.startVoiceInput('fbInput', this)" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg px-4 flex items-center justify-center transition active:scale-95"><i class="ph ph-microphone text-xl text-blue-400"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Tone</label><select id="fbTone" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm outline-none text-white"><option>Professional & Warm</option><option>Friendly & Exciting</option><option>Emotional</option></select></div>
                        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Length</label><select id="fbLength" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm outline-none text-white"><option value="Medium">Medium</option><option value="Long">Long</option><option value="Short">Short</option></select></div>
                    </div>
                    <button onclick="window.generateAI('fbpost')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-600/30 transition flex justify-center items-center gap-2 active:scale-95"><i class="ph ph-pen-nib"></i> Write Post (3 Options)</button>
                </div>
                <div id="fbResultArea" class="hidden space-y-2">
                    <div class="glass-panel p-4 md:p-6 rounded-xl border-blue-500/30">
                        <div id="fbOutput" class="whitespace-pre-wrap leading-relaxed text-sm text-slate-200"></div>
                    </div>
                    <button id="fbContinueBtn" onclick="window.continueAI('fbpost')" class="hidden w-full py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-blue-300 text-sm font-bold flex items-center justify-center gap-2"><span>‚ö†Ô∏è Continue Writing</span><i class="ph ph-arrow-right"></i></button>
                    <div class="flex gap-2">
                        <div class="flex-1 py-3 text-center text-xs text-green-400 italic">‚úÖ Auto-saved</div>
                        <button onclick="window.copyText('fbOutput')" class="flex-1 bg-slate-800 hover:bg-slate-700 py-3 rounded-lg text-xs font-bold border border-slate-700">üìã Copy</button>
                    </div>
                </div>
            </div>
            <div class="space-y-4">
                <div class="bg-slate-900 border border-slate-800 p-4 rounded-xl">
                    <h3 class="text-sm font-bold text-blue-300 mb-3 flex items-center gap-2"><i class="ph ph-sparkle"></i> Creative Assistant</h3>
                    <div class="space-y-2">
                        <button onclick="window.runAssistant('fb_ideas')" class="w-full text-left p-3 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-slate-300 border border-slate-700 transition">üí° Get 5 Post Ideas</button>
                        <button onclick="window.runAssistant('fb_hooks')" class="w-full text-left p-3 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-slate-300 border border-slate-700 transition">üé£ Generate Catchy Hooks</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </template>

  <template id="tpl-timeline">
    <div class="animate-fade-in space-y-6">
        <h2 class="text-xl md:text-2xl font-bold text-orange-400 flex items-center gap-2"><i class="ph ph-clock"></i> Timeline Generator</h2>
        <div class="glass-panel p-4 md:p-6 rounded-xl">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div><label class="text-xs text-slate-400 uppercase font-bold">Start</label><select id="tlStart" class="w-full p-2 mt-1 bg-slate-800 rounded border border-slate-700 text-white"><option>6:00 AM</option><option>8:00 AM</option><option>1:00 PM</option></select></div>
                <div><label class="text-xs text-slate-400 uppercase font-bold">Place</label><select id="tlPlace" class="w-full p-2 mt-1 bg-slate-800 rounded border border-slate-700 text-white"><option>Taunggyi (City)</option><option>Inle Lake</option><option>Kalaw</option></select></div>
                <div><label class="text-xs text-slate-400 uppercase font-bold">Outfits</label><select id="tlDress" class="w-full p-2 mt-1 bg-slate-800 rounded border border-slate-700 text-white"><option>3 Dresses</option><option>4 Dresses</option><option>5 Dresses</option></select></div>
                <div><label class="text-xs text-slate-400 uppercase font-bold">Pacing</label><select id="tlPace" class="w-full p-2 mt-1 bg-slate-800 rounded border border-slate-700 text-white"><option>Relaxed</option><option>Packed</option></select></div>
            </div>
            <div class="flex items-center gap-2 mb-4 p-2 bg-slate-800/50 rounded"><input type="checkbox" id="tlSunset" class="w-4 h-4 rounded bg-slate-800 border-slate-700 text-orange-500"><label for="tlSunset" class="text-sm text-slate-300">Include Sunset Shot</label></div>
            <button onclick="window.generateAI('timeline')" class="w-full bg-orange-600 hover:bg-orange-500 py-3 rounded text-white font-bold active:scale-95 transition">Generate Schedule</button>
        </div>
        <div id="tlResultArea" class="hidden glass-panel p-4 md:p-6 rounded-xl">
            <div id="tlOutput" class="whitespace-pre-wrap text-sm text-slate-200 font-mono"></div>
            <div class="mt-4 flex gap-2">
                <button onclick="window.downloadFile('Schedule.txt', 'tlOutput')" class="text-xs text-blue-400 border border-blue-900 p-2 rounded">‚¨áÔ∏è Download</button>
                <button onclick="window.copyText('tlOutput')" class="text-xs text-slate-400 border border-slate-700 p-2 rounded">üìã Copy</button>
            </div>
        </div>
    </div>
  </template>

  <template id="tpl-recent">
    <div class="animate-fade-in space-y-6">
        <div class="flex justify-between items-center">
            <h2 class="text-xl md:text-2xl font-bold text-white flex items-center gap-2"><i class="ph ph-clock-counter-clockwise text-green-400"></i> Cloud History</h2>
            <button onclick="window.clearHistory()" class="text-red-400 text-xs border border-red-900/50 px-3 py-1.5 rounded">Clear All</button>
        </div>
        <p class="text-xs text-slate-500 mb-4">Saved securely on Firebase.</p>
        <div id="historyListContainer" class="space-y-4 pb-20"></div>
    </div>
  </template>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBEqE5lWdLWIZOO_M3RYY35e17VMTGk-G0",
      authDomain: "saiai-content-generator.firebaseapp.com",
      projectId: "saiai-content-generator",
      storageBucket: "saiai-content-generator.firebasestorage.app",
      messagingSenderId: "574947512372",
      appId: "1:574947512372:web:1d35a5b5aa6f24ea493a61",
      measurementId: "G-C2Q8Y2XBMD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    let userId = null;
    let currentAnalysis = null;

    // --- HELPER: SAFE GET VALUE ---
    const getValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : "";
    };

    // --- AUTH ---
    window.handleLogin = async function() {
        const email = getValue('loginEmail');
        const pass = getValue('loginPass');
        if(!email || !pass) return;
        try { await signInWithEmailAndPassword(auth, email, pass); } catch(error) { document.getElementById('loginError').innerText = error.message; document.getElementById('loginError').classList.remove('hidden'); }
    }
    window.handleLogout = async function() { try { await signOut(auth); window.location.reload(); } catch(e) { console.error(e); } }

    onAuthStateChanged(auth, (user) => {
        const overlay = document.getElementById('loginOverlay');
        if (user) {
            userId = user.uid;
            document.getElementById('connectionStatus').classList.replace('bg-red-500', 'bg-green-500');
            document.getElementById('userEmailDisplay').innerText = user.email;
            overlay.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => overlay.classList.add('hidden'), 300);
            if(window.currentView === 'brand') loadBrandData();
            if(window.currentView === 'recent') renderHistoryList();
        } else {
            userId = null;
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0', 'pointer-events-none'), 50);
        }
    });

    window.currentView = 'dm'; 
    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        if (sidebar.classList.contains('sidebar-closed')) { sidebar.classList.remove('sidebar-closed'); sidebar.classList.add('sidebar-open'); overlay.classList.remove('hidden'); }
        else { sidebar.classList.add('sidebar-closed'); sidebar.classList.remove('sidebar-open'); overlay.classList.add('hidden'); }
    }
    window.loadView = function(viewId) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navBtn = document.getElementById('nav-' + viewId);
        if(navBtn) navBtn.classList.add('active');
        if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('sidebar-closed'); document.getElementById('overlay').classList.add('hidden'); }
        const container = document.getElementById('content-container');
        container.innerHTML = ''; 
        let templateId = 'tpl-' + viewId;
        if(viewId === 'tiktok') container.innerHTML = getTikTokHTML();
        else if(viewId === 'pose') container.innerHTML = getPoseHTML();
        else if(viewId === 'creative') { const tpl = document.getElementById('tpl-creative'); if(tpl) container.appendChild(tpl.content.cloneNode(true)); } // ADDED HANDLER
        else if(viewId === 'recent') { const tpl = document.getElementById('tpl-recent'); if(tpl) container.appendChild(tpl.content.cloneNode(true)); renderHistoryList(); }
        else { const tpl = document.getElementById(templateId); if(tpl) { container.appendChild(tpl.content.cloneNode(true)); if(viewId === 'brand') loadBrandData(); } }
        window.currentView = viewId;
    }

    function getTikTokHTML() { return `<div class="animate-fade-in space-y-6"><h2 class="text-xl md:text-2xl font-bold text-teal-400 flex items-center gap-2"><i class="ph ph-tiktok-logo"></i> TikTok Script</h2><div class="glass-panel p-4 md:p-5 rounded-xl space-y-4"><div class="flex gap-2"><input type="text" id="ttInput" placeholder="Video Topic..." class="flex-1 bg-slate-800 border border-slate-700 rounded p-3 text-white"><button onclick="window.startVoiceInput('ttInput', this)" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded px-4 text-teal-400"><i class="ph ph-microphone text-xl"></i></button></div><select id="ttStyle" class="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white"><option>Trending & Fast</option><option>Vlog / Behind Scenes</option><option>Cinematic Mood</option></select><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><button onclick="window.generateAI('tt_caption')" class="bg-slate-700 py-3 rounded text-white text-sm font-bold active:scale-95 transition">Get 3 Captions</button><button onclick="window.generateAI('tt_script')" class="bg-teal-600 py-3 rounded text-white text-sm font-bold active:scale-95 transition">Write 3 Scripts</button></div></div><div id="ttResultArea" class="hidden glass-panel p-4 md:p-6 rounded-xl"><div id="ttOutput" class="whitespace-pre-wrap text-sm text-slate-200"></div><button id="ttContinueBtn" onclick="window.continueAI('tt_script')" class="hidden w-full mt-2 py-2 bg-slate-800 text-teal-400 text-xs border border-slate-600 rounded">‚ö†Ô∏è Continue Writing</button><div class="text-xs text-green-400 mt-2">‚úÖ Auto-saved to Cloud</div></div></div>`; }
    function getPoseHTML() { return `<div class="animate-fade-in space-y-6"><h2 class="text-xl md:text-2xl font-bold text-pink-400 flex items-center gap-2"><i class="ph ph-camera"></i> Pose Helper</h2><div class="glass-panel p-4 md:p-5 rounded-xl space-y-4"><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label class="text-xs font-bold text-slate-400 uppercase">Outfit</label><select id="poseOutfit" class="w-full mt-1 bg-slate-800 border border-slate-700 rounded p-2 text-white text-sm"><option>Wedding Gown/Suit</option><option>Traditional</option><option>Casual</option></select></div><div><label class="text-xs font-bold text-slate-400 uppercase">Props</label><input type="text" id="poseProps" placeholder="Flowers..." class="w-full mt-1 bg-slate-800 border border-slate-700 rounded p-2 text-white text-sm"></div></div><div class="flex gap-2 mb-2"><button onclick="window.fillPose('Shy')" class="px-3 py-1 bg-pink-900/30 text-pink-200 text-xs rounded border border-pink-500/30">üò≥ Shy</button><button onclick="window.fillPose('Plus')" class="px-3 py-1 bg-pink-900/30 text-pink-200 text-xs rounded border border-pink-500/30">‚ù§Ô∏è Plus</button></div><div class="relative"><textarea id="poseInput" class="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white h-24 pr-10" placeholder="Situation..."></textarea><button onclick="window.startVoiceInput('poseInput', this)" class="absolute right-2 bottom-2 bg-slate-700/80 hover:bg-pink-600 p-2 rounded-full transition text-slate-300 hover:text-white"><i class="ph ph-microphone text-lg"></i></button></div><button onclick="window.generateAI('pose')" class="w-full bg-pink-600 py-3 rounded text-white font-bold active:scale-95 transition">Generate Poses</button></div><div id="poseResultArea" class="hidden glass-panel p-4 md:p-6 rounded-xl"><div id="poseOutput" class="whitespace-pre-wrap text-sm text-slate-200"></div><div class="text-xs text-green-400 mt-2">‚úÖ Auto-saved to Cloud</div></div></div>`; }

    // --- NEW: CREATIVE DIRECTOR HELPERS ---
    window.setCreativeOption = function(type, value, btn) {
        if(type === 'workload') {
            document.getElementById('crWorkload').value = value;
            document.querySelectorAll('#tpl-creative .creative-btn').forEach(b => b.classList.remove('active')); // Note: Selector might need adjustment if clone
            // Better: Find siblings
            if(btn && btn.parentElement) {
                Array.from(btn.parentElement.children).forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
            }
        }
    };

    // --- UPDATED SAVE FUNCTION WITH STATUS ---
    window.saveBrandData = async function() {
        if (!userId) { window.showToast("Login required!"); return; }
        const statusEl = document.getElementById('saveStatus');
        if(statusEl) statusEl.innerText = "Saving...";
        const ids = ['brandStyle', 'brandClient', 'brandPhone', 'brandViber', 'brandFB', 'brandTT', 'brandAddr', 'brandPackages'];
        const data = {};
        ids.forEach(id => { const el = document.getElementById(id); if(el) data[id] = el.value; });
        try { 
            await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand'), data, {merge: true}); 
            if(statusEl) { statusEl.innerText = "Cloud Saved ‚úÖ"; statusEl.classList.add('text-green-400'); }
            window.showToast("Cloud Save Success!"); 
        } catch (e) { 
            console.error(e); 
            if(statusEl) statusEl.innerText = "Error Saving"; 
        }
    }
    window.loadBrandData = async function() {
        if (!userId) return;
        try {
            const docSnap = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand'));
            if (docSnap.exists()) { const data = docSnap.data(); for (const [key, value] of Object.entries(data)) { const el = document.getElementById(key); if(el) el.value = value; } }
        } catch(e) { console.error(e); }
    }
    async function saveToRecents(type, content, topic) {
        if (!userId) return;
        try { await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'history'), { type: type, topic: topic || "Generated Content", content: content, date: new Date().toLocaleString(), timestamp: Date.now() }); } catch(e) { console.error(e); }
    }
    function renderHistoryList() {
        if (!userId) return;
        const c = document.getElementById('historyListContainer');
        if(!c) return;
        const q = query(collection(db, 'artifacts', appId, 'users', userId, 'history'), orderBy('timestamp', 'desc'), limit(30));
        onSnapshot(q, (snapshot) => {
            const items = [];
            snapshot.forEach((doc) => { items.push({ id: doc.id, ...doc.data() }); });
            c.innerHTML = items.length ? items.map(i=>`<div class="glass-panel p-4 rounded-lg border-l-4 border-green-500 mb-2 group relative"><div class="flex justify-between items-start mb-2"><div><span class="font-bold text-white text-sm block">${i.topic}</span><span class="text-[10px] text-slate-400 uppercase bg-slate-800 px-1.5 rounded">${i.type}</span></div><span class="text-[10px] text-slate-500">${i.date}</span></div><div class="text-xs text-slate-300 line-clamp-3 bg-slate-900/50 p-2 rounded cursor-pointer hover:bg-slate-900 transition" onclick="window.toggleExpand(this)">${i.content}</div><div class="mt-2 text-right flex justify-end gap-2"><button onclick="window.copyText('${i.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')" class="text-blue-400 text-xs hover:text-white border border-blue-500/30 px-2 py-1 rounded">Copy</button></div></div>`).join('') : "<div class='text-center text-slate-500 py-10'>No recent activity on Cloud.</div>";
        });
    }

    window.generateAI = async function(type, isContinue = false) {
        const outputIds = { 'fbpost': 'fbOutput', 'dm_best': 'dmOutput', 'timeline': 'tlOutput', 'tt_caption': 'ttOutput', 'tt_script': 'ttOutput', 'pose': 'poseOutput', 'creative_director': 'crOutput' }; // Added creative
        const areaIds = { 'fbpost': 'fbResultArea', 'dm_best': 'dmResultArea', 'timeline': 'tlResultArea', 'tt_caption': 'ttResultArea', 'tt_script': 'ttResultArea', 'pose': 'poseResultArea', 'creative_director': 'crResultArea' }; // Added creative
        
        // Handle Mobile Creative output separately if needed, but basic mapping works for desktop layout. 
        // For mobile, we might need to show crResultAreaMobile.
        
        const outId = outputIds[type];
        const areaId = areaIds[type];
        
        if(type === 'dm_analyze') {
             const panel = document.getElementById('dmAnalysisPanel');
             if(panel) { panel.classList.remove('hidden'); panel.innerHTML = "<div class='text-center text-indigo-400 text-sm animate-pulse'>üîç Analyzing Sales Status...</div>"; }
        } else {
             if(document.getElementById(areaId)) document.getElementById(areaId).classList.remove('hidden');
             // Special handling for Creative Director Mobile
             if(type === 'creative_director') {
                 if(window.innerWidth < 768) document.getElementById('crResultAreaMobile').classList.remove('hidden');
             }

             if(!isContinue && document.getElementById(outId)) {
                document.getElementById(outId).innerHTML = "<span class='animate-pulse text-purple-400'>‚ú® Senior Sales Manager is thinking...</span>";
                if(type === 'creative_director' && window.innerWidth < 768) {
                    document.getElementById('crOutputMobile').innerHTML = "<span class='animate-pulse text-yellow-400'>‚ú® Creating Plan...</span>";
                }
                
                if(window.innerWidth < 768) setTimeout(() => { 
                    if(type === 'creative_director') document.getElementById('crResultAreaMobile').scrollIntoView({ behavior: 'smooth' });
                    else document.getElementById(areaId).scrollIntoView({ behavior: 'smooth', block: 'start' }); 
                }, 100);
            }
        }

        let brandData = {};
        if (userId) { try { const docSnap = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand')); if (docSnap.exists()) brandData = docSnap.data(); } catch(e) {} }
        
        const brandStyle = brandData.brandStyle || "Professional";
        const brandPackages = brandData.brandPackages || "Not specified.";
        const contactInfo = `Phone: ${brandData.brandPhone || ''}, Viber: ${brandData.brandViber || ''}, Facebook: ${brandData.brandFB || ''}, TikTok: ${brandData.brandTT || ''}`;

        // CORE SYSTEM PROMPT
        const systemPrompt = `
        ROLE: Senior Sales Manager & Studio Owner of "With You Photo Studio" in Taunggyi.
        GOAL: Close deals warmly. Be helpful, persuasive, and confident.
        CRITICAL INSTRUCTION - GENDER: You are MALE. ALWAYS use "Bya" (·Äó·Äª) or "Khamya" (·ÄÅ·ÄÑ·Ä∫·Äó·Äª·Ä¨) at the end. NEVER use "Shin" (·Äõ·Äæ·ÄÑ·Ä∫).
        TONE: Natural Burmese (Bya/Khamya). Sandwich Method (Value -> Price -> Value).
        DATA: Packages: ${brandPackages}, Contact: ${contactInfo}.
        IMPORTANT: Always output COMPLETE responses. Do not stop mid-sentence.
        `;

        let taskPrompt = "";
        let contextTopic = "";

        if (type === 'creative_director') {
            const workload = getValue('crWorkload');
            const focus = getValue('crFocus');
            const fbChecked = document.getElementById('crFB').checked ? "Facebook" : "";
            const ttChecked = document.getElementById('crTT').checked ? "TikTok" : "";
            const platforms = [fbChecked, ttChecked].filter(Boolean).join(" & ");
            
            contextTopic = `Creative Plan: ${focus}`;
            taskPrompt = `
            ROLE: Creative Director for With You Photo Studio.
            TASK: Create a 3-Day Mini Content Plan.
            INPUTS: Workload=${workload}, Focus=${focus}, Platforms=${platforms}.
            OUTPUT RULES:
            - Day 1, 2, 3 format.
            - Specific Hook & Call to Action for each.
            - Write in Burmese.
            - Keep it realistic for a studio owner.
            `;
        }
        else if (type === 'dm_analyze') {
            const msg = getValue('dmInput');
            taskPrompt = `ROLE: Senior Sales Strategist. TASK: Analyze message: "${msg}". RETURN FORMAT: Status: READY|THINKING|NOT_READY. Reason: ... NextAction: ... Tone: ... DO NOT write full reply.`;
        }
        else if (type === 'dm_best') {
            const service = getValue('dmService');
            const scenario = getValue('dmScenario');
            const msg = getValue('dmInput');
            const strategy = getValue('dmType');
            let analysisContext = currentAnalysis ? `Based on Analysis: ${currentAnalysis}` : "";
            contextTopic = `DM: ${service} (${scenario})`;
            
            if(isContinue) {
                const prev = document.getElementById(outId).innerText;
                taskPrompt = `CONTEXT: Writing 3 DM replies. Stopped at: "...${prev.slice(-100)}". TASK: CONTINUE exactly from there. Finish the options. Add a closing.`;
            } else {
                taskPrompt = `TASK: Write 3 DISTINCT SALES REPLIES (Numbered 1, 2, 3). Context: ${service}. Status: ${scenario}. Client: "${msg}". Strategy: ${strategy}. ${analysisContext}. OUTPUT: 1. [Warm] 2. [Direct] 3. [Short]. MUST include Contact in CTA. Ensure full text.`;
            }
        } 
        else if (type === 'fbpost') {
            const topic = getValue('fbInput');
            const tone = getValue('fbTone');
            const len = getValue('fbLength');
            contextTopic = `FB Post: ${topic}`;
            
            if(isContinue) {
                const prevText = document.getElementById('fbOutput').innerText;
                const lastChunk = prevText.slice(-300);
                taskPrompt = `CONTEXT: Writing FB post. Stopped at: "...${lastChunk}". TASK: CONTINUE writing from there. Finish body, CTA, Hashtags. End with "--- End of Post ---".`;
            } else {
                if(len === "Long") {
                    taskPrompt = `TASK: Write ONE detailed storytelling Facebook Post about "${topic}". Tone: ${tone}. Go deep. Don't cut off.`;
                } else {
                    taskPrompt = `TASK: Write 3 DISTINCT Facebook Post Variations about "${topic}". Tone: ${tone}. Length: ${len}. FORMAT: Option 1, Option 2, Option 3. Include CTA with ${contactInfo}. Ensure all 3 options are fully written out.`;
                }
            }
        }
        else if (type === 'timeline') {
            const start = getValue('tlStart');
            const place = getValue('tlPlace');
            const dress = getValue('tlDress');
            const pace = getValue('tlPace');
            const sunsetElement = document.getElementById('tlSunset');
            const sunset = sunsetElement && sunsetElement.checked ? "Include Sunset" : "No Sunset";
            contextTopic = `Timeline: ${place} (${dress})`;
            if(isContinue) {
                const prev = document.getElementById(outId).innerText;
                taskPrompt = `CONTEXT: Writing Timeline. Stopped at: "...${prev.slice(-100)}". TASK: Continue finishing the schedule items and tips.`;
            } else {
                taskPrompt = `TASK: Create a detailed Pre-wedding Timeline Schedule. Start: ${start}, Place: ${place}, Outfits: ${dress}, Pace: ${pace}, Sunset: ${sunset}. Output: Clear List with times.`;
            }
        }
        else if (type.includes('tt_')) {
            const topic = getValue('ttInput');
            const style = getValue('ttStyle');
            const sub = type==='tt_caption'?'Caption':'Script';
            contextTopic = `TikTok ${sub}: ${topic}`;
            if(isContinue) {
                const prev = document.getElementById(outId).innerText;
                taskPrompt = `CONTEXT: Writing TikTok content. Stopped at: "...${prev.slice(-100)}". TASK: Continue finishing the 3 options.`;
            } else {
                taskPrompt = `TASK: Write 3 TikTok ${sub} options for "${topic}". Style: ${style}. Keep it viral & trendy. Format: Option 1, 2, 3. Ensure full text.`;
            }
        }
        else if (type === 'pose') {
            const input = getValue('poseInput');
            const outfit = getValue('poseOutfit');
            const props = getValue('poseProps');
            contextTopic = `Pose: ${outfit}`;
            taskPrompt = `TASK: Suggest 3 Poses. Context: ${input}. Outfit: ${outfit}. Props: ${props}. Give clear Burmese instructions.`;
        }

        const fullPrompt = systemPrompt + "\n\n" + taskPrompt;

        try {
            const res = await fetch("/api/generate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: fullPrompt })
            });
            const data = await res.json();
            
            if (type === 'dm_analyze') {
                const result = data.result;
                currentAnalysis = result;
                let statusColor = "text-slate-200";
                let borderColor = "border-slate-600";
                if(result.includes("READY")) { statusColor = "status-ready text-emerald-400"; borderColor = "border-emerald-500/50"; }
                if(result.includes("THINKING")) { statusColor = "status-thinking text-amber-400"; borderColor = "border-amber-500/50"; }
                if(result.includes("NOT READY")) { statusColor = "status-notready text-blue-400"; borderColor = "border-blue-500/50"; }
                
                const panel = document.getElementById('dmAnalysisPanel');
                if(panel) {
                    panel.className = `mt-4 p-4 rounded-xl border ${borderColor} bg-slate-900/90 relative animate-fade-in`;
                    panel.innerHTML = `<div class="absolute -top-3 left-4 bg-slate-900 px-2 text-[10px] ${statusColor} uppercase font-bold tracking-wider border ${borderColor} rounded">AI Analysis</div><div class="text-sm whitespace-pre-wrap leading-relaxed ${statusColor} font-medium mt-2">${result}</div><div class="mt-3 flex gap-2 pt-3 border-t border-slate-700/50"><button onclick="window.generateAI('dm_best')" class="flex-1 bg-white/10 hover:bg-white/20 py-2 rounded text-xs text-white transition">‚ú® Generate Smart Reply</button></div>`;
                }
            }
            else if(document.getElementById(outId)) {
                let finalContent = "";
                if(isContinue) {
                    document.getElementById(outId).innerText += "\n" + data.result;
                    finalContent = document.getElementById(outId).innerText; 
                } else {
                    document.getElementById(outId).innerText = data.result || "Error generating.";
                    finalContent = data.result;
                }
                
                // Duplicate to Mobile Creative Output
                if(type === 'creative_director') {
                    document.getElementById('crOutputMobile').innerText = finalContent;
                }

                if (finalContent && !finalContent.includes("Error")) { saveToRecents(type, finalContent, contextTopic); }
                if(continueBtnIds[type]) { const btn = document.getElementById(continueBtnIds[type]); if(btn) btn.classList.remove('hidden'); }
            }
        } catch(e) {
            console.error(e);
            if(document.getElementById(outId) && !isContinue) document.getElementById(outId).innerText = "Connection Error.";
        }
    }

    window.continueAI = function(type) {
        const outputIds = { 'fbpost': 'fbOutput', 'dm_best': 'dmOutput', 'tt_script': 'ttOutput', 'tt_caption': 'ttOutput', 'timeline': 'tlOutput' };
        const out = document.getElementById(outputIds[type]);
        if(out) out.innerHTML += "<br><br><span class='text-blue-400 text-xs animate-pulse'>... Continuing ...</span>";
        window.generateAI(type, true);
    }

    window.runAssistant = async function(type) {
        const outputId = 'fbOutput'; const areaId = 'fbResultArea';
        document.getElementById(areaId).classList.remove('hidden');
        document.getElementById(outputId).innerHTML = "<span class='animate-pulse text-yellow-400'>üí° Brainstorming...</span>";
        if(window.innerWidth < 768) document.getElementById(areaId).scrollIntoView({ behavior: 'smooth' });
        let prompt = "";
        if(type === 'fb_ideas') prompt = "Generate 5 Creative Facebook Post Ideas for a photography studio.";
        if(type === 'fb_hooks') prompt = "Write 5 catchy hooks (first sentences) in Burmese to stop scrolling.";
        
        const maleInstruction = "IMPORTANT: Write as a MALE speaker using 'Bya' (·Äó·Äª). Do NOT use 'Shin'. ";

        try {
             const res = await fetch("/api/generate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt: "Context: Myanmar Photo Studio. " + maleInstruction + prompt }) });
             const data = await res.json();
             document.getElementById(outputId).innerText = data.result;
             saveToRecents('Idea/Hook', data.result, "Creative Brainstorm");
        } catch(e) {}
    }

    window.startVoiceInput = function(elementId, btn) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { window.showToast("‚ùå Browser not supported"); return; }
        const recognition = new SpeechRecognition();
        recognition.lang = 'my-MM'; recognition.interimResults = false;
        if(btn) btn.classList.add('listening-ring');
        window.showToast("üé§ Speaking...");
        recognition.start();
        recognition.onresult = (e) => {
            const text = e.results[0][0].transcript;
            const el = document.getElementById(elementId);
            if(el) el.value = el.value ? el.value + " " + text : text;
            window.showToast("‚úÖ Added!");
        };
        recognition.onend = () => { if(btn) btn.classList.remove('listening-ring'); };
        recognition.onerror = () => { if(btn) btn.classList.remove('listening-ring'); window.showToast("‚ùå Error"); };
    }

    window.setDmType = function(strength, btn) {
        document.getElementById('dmType').value = strength;
        document.querySelectorAll('.tactic-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        window.showToast("Strategy: " + strength);
    }
    window.fillPose = function(t) { document.getElementById('poseInput').value = t === 'Shy' ? "·Ä°·Äõ·Äô·Ä∫·Ä∏·Äõ·Äæ·ÄÄ·Ä∫·Äê·Äê·Ä∫·Äê·Äö·Ä∫" : "·Äù·Äê·Ä≤·Ä∑·Ä°·Äê·ÄΩ·Ä≤"; }
    window.showToast = function(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    window.copyText = function(textOrId) { 
        let text = document.getElementById(textOrId) ? document.getElementById(textOrId).innerText : textOrId;
        navigator.clipboard.writeText(text); window.showToast("Copied!"); 
    }
    window.downloadFile = function(n, id) { 
        const b = new Blob([document.getElementById(id).innerText],{type:'text/plain'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=n; a.click(); 
    }
    window.clearHistory = function() { 
        if(!userId) return;
        if(confirm("Clear Cloud History?")) { window.showToast("Clear individual items for now."); } 
    }
    window.toggleExpand = function(el) {
        if(el.classList.contains('line-clamp-3')) el.classList.remove('line-clamp-3');
        else el.classList.add('line-clamp-3');
    }
    window.loadView('dm');
  </script>
</body>
</html>
