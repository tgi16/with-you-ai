<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>With You Studio - Sales Master Content AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Padauk:wght@400;700&display=swap" rel="stylesheet">
  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    /* --- MOBILE APP OPTIMIZATIONS --- */
    @media (max-width: 768px) {
        /* ·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äô·Äæ·Ä¨ ·Äò·Ä±·Ä∏·Äò·Ä±·Ä¨·ÄÑ·Ä∫·ÄÄ·Äª·Äâ·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·ÄÖ·Ä¨·Äñ·Äê·Ä∫·Äú·Ä≠·ÄØ·Ä∑·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ */
        .glass-panel { padding: 1.25rem !important; } 
        
        /* ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·ÄÄ Bottom Bar ·Äî·Ä≤·Ä∑ ·Äô·Äú·ÄΩ·Äê·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äî·Ä±·Äõ·Ä¨·ÄÅ·Äª·Äî·Ä∫·Äô·Äö·Ä∫ */
        #content-container { padding-bottom: 120px !important; } 
        
        /* ·ÄÖ·Ä¨·Äú·ÄØ·Ä∂·Ä∏·Äê·ÄΩ·Ä± ·Äî·Ää·Ä∫·Ä∏·Äî·Ää·Ä∫·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏·Äô·Äö·Ä∫ */
        input, select, textarea, button { font-size: 16px !important; } 
    }

    /* Active State for Bottom Nav */
    .mobile-btm-nav.active {
        color: #3b82f6; /* Blue */
    }
    .mobile-btm-nav.active i {
        fill: #3b82f6;
        font-weight: bold;
    }

    /* English ·ÄÄ·Ä≠·ÄØ Inter ·Ä¶·Ä∏·ÄÖ·Ä¨·Ä∏·Äï·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äô·Äæ ·Äô·Äº·Äî·Ä∫·Äô·Ä¨·ÄÖ·Ä¨·ÄÄ·Ä≠·ÄØ Padauk ·Äû·ÄØ·Ä∂·Ä∏·Äï·Ä´·Äô·Äö·Ä∫ */
    body { font-family: 'Inter', 'Padauk', sans-serif; letter-spacing: 0.01em; }
    
    /* ·ÄÖ·Ä¨·Äú·ÄØ·Ä∂·Ä∏·Äê·ÄΩ·Ä± ·Äï·Ä≠·ÄØ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ Line-height ·Äî·Ä≤·Ä∑ Spacing ·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äï·Ä´·Äô·Äö·Ä∫ */
    p, div, span, button { line-height: 1.6; }
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    
    /* <style> ·Äë·Ä≤·ÄÄ .glass-panel ·Ä°·Äü·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·Äí·Ä´·Äî·Ä≤·Ä∑ ·Ä°·ÄÖ·Ä¨·Ä∏·Äë·Ä≠·ÄØ·Ä∏·Äï·Ä´ */
.glass-panel {
    background: rgba(30, 41, 59, 0.6); /* ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÅ·Ä∂·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫ ·Äî·Ää·Ä∫·Ä∏·Äî·Ää·Ä∫·Ä∏·Äú·Äª·Äæ·Ä±·Ä¨·Ä∑ */
    backdrop-filter: blur(16px); /* ·Äù·Ä´·Ä∏·Äê·Ä≤·Ä∑ effect ·Äê·Ä≠·ÄØ·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äô·Äö·Ä∫ */
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.08); /* ·Äò·Ä±·Ä¨·ÄÑ·Ä∫·ÄÄ·Ä≠·ÄØ ·Äï·Ä´·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äô·Äö·Ä∫ */
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); /* ·Ä°·Äõ·Ä≠·Äï·Ä∫·Äë·Ää·Ä∑·Ä∫·Äô·Äö·Ä∫ */
}

/* Button ·Äê·ÄΩ·Ä±·Äô·Äæ·Ä¨ Hover ·Äú·ÄØ·Äï·Ä∫·Äõ·ÄÑ·Ä∫ ·ÄÄ·Äº·ÄΩ·Äê·ÄÄ·Ä∫·Äú·Ä¨·Äê·Ä≤·Ä∑ Effect ·Äë·Ää·Ä∑·Ä∫·Äô·Äö·Ä∫ */
button:active { transform: scale(0.98); }
button { transition: all 0.2s ease; }
    
    .nav-item.active, .mobile-nav-item.active {
        background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        border-color: transparent;
    }

    .tactic-btn.active, .manager-btn.active, .creative-btn.active {
        background-color: #7e22ce; 
        border-color: #a855f7;
        color: white;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);
    }
    
    /* Next Step Button Animation */
    .next-step-btn {
        animation: fadeInUp 0.5s ease-out;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    #sidebar { transition: transform 0.3s ease-in-out; }
    .sidebar-open { transform: translateX(0) !important; }
    .sidebar-closed { transform: translateX(-100%); }
    @media (min-width: 768px) { .sidebar-closed { transform: translateX(0); } }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .listening-ring {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        animation: pulse-red 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        border-color: #ef4444 !important; color: #ef4444 !important;
    }
    @keyframes pulse-red { to { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
    
    /* Chat Bubbles */
    /* Chat Bubbles Fixed - Compact Size */
    .chat-bubble-ai {
        background: #1e293b;
        color: #e2e8f0;
        border-radius: 12px 12px 12px 2px;
        padding: 10px 14px; /* Padding ·Äî·Ää·Ä∫·Ä∏·Äî·Ää·Ä∫·Ä∏·Äú·Äª·Äæ·Ä±·Ä¨·Ä∑·Äë·Ä¨·Ä∏·Äï·Ä´·Äê·Äö·Ä∫ */
        font-size: 14px;
        line-height: 1.6;
        border: 1px solid rgba(255,255,255,0.05);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        white-space: pre-wrap;
        
        /* ‚úÖ KEY FIXES HERE */
        display: inline-block; /* ·ÄÖ·Ä¨·Äõ·Äæ·Ä≠·Äû·Äú·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Ä≤ ·ÄÄ·Äª·Äö·Ä∫·Äï·Ä´·Äô·Äö·Ä∫ */
        width: auto;
        max-width: 100%;
        word-wrap: break-word;
    }

    .chat-bubble-user {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-radius: 12px 12px 2px 12px;
        padding: 10px 14px; /* Padding ·Äî·Ää·Ä∫·Ä∏·Äî·Ää·Ä∫·Ä∏·Äú·Äª·Äæ·Ä±·Ä¨·Ä∑·Äë·Ä¨·Ä∏·Äï·Ä´·Äê·Äö·Ä∫ */
        font-size: 14px;
        line-height: 1.6;
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        white-space: pre-wrap;
        
        /* ‚úÖ KEY FIXES HERE */
        display: inline-block; /* ·ÄÖ·Ä¨·Äõ·Äæ·Ä≠·Äû·Äú·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Ä≤ ·ÄÄ·Äª·Äö·Ä∫·Äï·Ä´·Äô·Äö·Ä∫ */
        width: auto; 
        max-width: 100%;
        margin-left: auto; /* ·Ää·Ä¨·Äò·ÄÄ·Ä∫·ÄÄ·Äï·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ */
    }
    
    .typing-dot {
        animation: typing 1.4s infinite ease-in-out both;
        width: 6px; height: 6px; background-color: #94a3b8; border-radius: 50%; display: inline-block; margin: 0 2px;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    
    /* Toast Animation */
    .toast { visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; opacity: 0; }
    .toast.show { visibility: visible; bottom: 40px; opacity: 1; }

    /* Rebrand UI (With You Studio - Sales Master Content AI) */
    :root {
      --wy-bg-0: #050b1a;
      --wy-bg-1: #0c1530;
      --wy-card: rgba(18, 28, 52, 0.72);
      --wy-card-strong: rgba(14, 23, 44, 0.86);
      --wy-border: rgba(135, 168, 255, 0.18);
      --wy-glow: rgba(56, 189, 248, 0.2);
      --wy-accent: #38bdf8;
      --wy-accent-2: #60a5fa;
    }

    body {
      background:
        radial-gradient(1200px 700px at -10% -20%, rgba(56, 189, 248, 0.14), transparent 60%),
        radial-gradient(800px 500px at 100% 0%, rgba(99, 102, 241, 0.16), transparent 55%),
        linear-gradient(145deg, var(--wy-bg-0), var(--wy-bg-1));
      position: relative;
    }

    #sidebar {
      background: linear-gradient(180deg, rgba(9, 17, 36, 0.96), rgba(7, 13, 28, 0.94)) !important;
      border-right-color: rgba(135, 168, 255, 0.18) !important;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
    }

    .glass-panel {
      background: linear-gradient(165deg, var(--wy-card), var(--wy-card-strong));
      border-color: var(--wy-border) !important;
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.05),
        0 12px 30px rgba(0, 0, 0, 0.25),
        0 0 0 1px rgba(56, 189, 248, 0.05);
    }

    input, select, textarea {
      border-color: rgba(148, 163, 184, 0.3) !important;
      background-color: rgba(17, 24, 39, 0.75) !important;
    }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(56, 189, 248, 0.65) !important;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.12) !important;
      outline: none !important;
    }

    button {
      border-radius: 12px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    button:hover {
      filter: saturate(1.08);
    }

    .nav-item {
      border: 1px solid transparent;
    }

    .nav-item:hover {
      border-color: rgba(148, 163, 184, 0.25);
      background: rgba(30, 41, 59, 0.55);
    }

    .nav-item.active, .mobile-nav-item.active {
      background: linear-gradient(95deg, #0ea5e9 0%, #2563eb 100%) !important;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.32);
    }

    #content-container {
      max-width: 72rem;
    }

    .theme-chip {
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.55);
      color: #cbd5e1;
      font-size: 10px;
      font-weight: 700;
      padding: 6px 8px;
      border-radius: 999px;
      transition: all 0.2s ease;
    }
    .theme-chip:hover { border-color: rgba(56, 189, 248, 0.6); color: #f8fafc; }
    .theme-chip.active {
      color: #fff;
      border-color: rgba(56, 189, 248, 0.8);
      background: linear-gradient(90deg, #0ea5e9, #2563eb);
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.32);
    }

    body[data-theme="studio-blue"] {
      --wy-bg-0: #050b1a;
      --wy-bg-1: #0c1530;
      --wy-card: rgba(18, 28, 52, 0.72);
      --wy-card-strong: rgba(14, 23, 44, 0.86);
      --wy-border: rgba(135, 168, 255, 0.18);
    }

    body[data-theme="dark"] {
      --wy-bg-0: #020617;
      --wy-bg-1: #0b1223;
      --wy-card: rgba(15, 23, 42, 0.8);
      --wy-card-strong: rgba(10, 15, 30, 0.9);
      --wy-border: rgba(100, 116, 139, 0.25);
    }

    body[data-theme="light"] {
      --wy-bg-0: #f8fafc;
      --wy-bg-1: #e2e8f0;
      --wy-card: rgba(255, 255, 255, 0.88);
      --wy-card-strong: rgba(248, 250, 252, 0.92);
      --wy-border: rgba(15, 23, 42, 0.16);
      color: #0f172a !important;
    }
    body[data-theme="light"] #sidebar {
      background: linear-gradient(180deg, rgba(248, 250, 252, 0.98), rgba(241, 245, 249, 0.96)) !important;
      border-right-color: rgba(15, 23, 42, 0.12) !important;
    }
    body[data-theme="light"] .glass-panel {
      box-shadow:
        inset 0 1px 0 rgba(15, 23, 42, 0.03),
        0 10px 26px rgba(15, 23, 42, 0.08),
        0 0 0 1px rgba(15, 23, 42, 0.04);
    }
    body[data-theme="light"] input,
    body[data-theme="light"] select,
    body[data-theme="light"] textarea {
      color: #0f172a !important;
      background: rgba(255, 255, 255, 0.96) !important;
      border-color: rgba(15, 23, 42, 0.16) !important;
    }
    body[data-theme="light"] .text-white,
    body[data-theme="light"] .text-slate-200,
    body[data-theme="light"] .text-slate-300,
    body[data-theme="light"] .text-slate-400,
    body[data-theme="light"] .text-slate-500,
    body[data-theme="light"] .text-slate-600 {
      color: #0f172a !important;
    }
    body[data-theme="light"] .bg-slate-800,
    body[data-theme="light"] .bg-slate-800\/50,
    body[data-theme="light"] .bg-slate-900,
    body[data-theme="light"] .bg-slate-900\/50,
    body[data-theme="light"] .bg-slate-900\/60,
    body[data-theme="light"] .bg-slate-950\/30 {
      background: rgba(241, 245, 249, 0.9) !important;
      color: #0f172a !important;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen h-[100dvh] flex overflow-hidden">

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="fixed inset-0 z-[60] bg-slate-950 flex flex-col items-center justify-center p-6 transition-opacity duration-300">
    <div class="glass-panel p-8 rounded-2xl w-full max-w-sm border border-slate-700 shadow-2xl flex flex-col items-center space-y-6">
        <div class="text-center">
            <div class="w-16 h-16 bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/30">
                <i class="ph ph-lock-key text-3xl text-blue-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-white">With You Studio</h2>
            <p class="text-sm text-slate-400 mt-1">Sales Master Content AI Login</p>
        </div>
        
        <div class="w-full space-y-4">
            <div>
                <label class="text-sm font-bold text-slate-400 uppercase mb-1 ml-1">Email</label>
                <div class="relative">
                    <i class="ph ph-envelope absolute left-3 top-3 text-slate-500 text-lg"></i>
                    <input type="email" id="loginEmail" placeholder="admin@studio.com" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 pl-10 text-white focus:border-blue-500 outline-none transition placeholder-slate-600">
                </div>
            </div>
            <div>
                <label class="text-sm font-bold text-slate-400 uppercase mb-1 ml-1">Password</label>
                <div class="relative">
                    <i class="ph ph-key absolute left-3 top-3 text-slate-500 text-lg"></i>
                    <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 pl-10 text-white focus:border-blue-500 outline-none transition placeholder-slate-600">
                </div>
            </div>
            <button onclick="window.handleLogin()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-900/50 transition active:scale-95 flex justify-center gap-2 items-center">
                <span>Sign In</span>
                <i class="ph ph-arrow-right"></i>
            </button>
        </div>
        
        <p id="loginError" class="text-red-400 text-xs text-center hidden bg-red-900/20 p-2 rounded w-full border border-red-900/50"></p>
    </div>
  </div>

  <!-- OVERLAY for Mobile Sidebar -->
  <div id="overlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass-panel"></div>

  <!-- SIDEBAR NAVIGATION -->
  <aside id="sidebar" class="sidebar-closed fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 border-r border-slate-800 flex flex-col transition-transform duration-300 md:relative md:translate-x-0 shadow-2xl">
    <div class="p-6 border-b border-slate-800 flex items-center justify-between">
        <div>
            <h1 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
                <i class="ph ph-camera text-blue-400"></i> With You Studio
            </h1>
            <div class="text-[10px] text-sky-300 bg-sky-900/30 px-2 py-1 rounded border border-sky-500/30">Sales Master Content AI</div>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1 flex items-center gap-1">
                <span id="connectionStatus" class="w-2 h-2 rounded-full bg-red-500"></span> Online
            </p>
        </div>
        <button onclick="window.toggleSidebar()" class="md:hidden text-slate-400"><i class="ph ph-x text-xl"></i></button>
    </div>

    <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-6">
        <div>
            <p class="px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Management</p>
            <div class="space-y-1">
                <button onclick="window.loadView('manager')" id="nav-manager" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-robot text-lg text-yellow-400"></i> AI Manager
                </button>
                <button onclick="window.loadView('mentor')" id="nav-mentor" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
    <i class="ph ph-student text-lg text-emerald-400"></i> Mentor Mode
</button>
                <button onclick="window.loadView('creative')" id="nav-creative" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-lightbulb text-lg text-orange-400"></i> Content & Ideas
                </button>
                <button onclick="window.loadView('dm')" id="nav-dm" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-chat-circle-text text-lg text-purple-400"></i> DM Auto-Detect
                </button>
                <button onclick="window.loadView('brand')" id="nav-brand" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-brain text-lg text-blue-400"></i> Brand Brain
                </button>
            </div>
        </div>

        <div>
            <p class="px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Studio Ops</p>
            <div class="space-y-1">
                <button onclick="window.loadView('timeline')" id="nav-timeline" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-clock text-lg"></i> Timeline
                </button>
                <button onclick="window.loadView('pose')" id="nav-pose" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition">
                    <i class="ph ph-camera text-lg"></i> Pose Helper
                </button>
            </div>
        </div>
        <div>
            <div class="space-y-1 border-t border-slate-800 pt-4">
                <button onclick="window.loadView('recent')" id="nav-recent" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition group relative">
                    <i class="ph ph-clock-counter-clockwise text-lg group-hover:text-green-400"></i> 
                    <span>Recent / Saved</span>
                    <span id="recentBadge" class="hidden absolute right-3 top-3 w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                </button>
            </div>
        </div>
    </nav>
<div class="px-4 pb-4">
        <div class="bg-slate-900/80 rounded-xl p-3 border border-slate-700 shadow-inner">
            <div class="flex justify-between items-end mb-2">
                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider flex items-center gap-1"><i class="ph ph-lightning"></i> AI Budget</span>
                <span id="usagePercent" class="text-xs font-bold text-green-400">0%</span>
            </div>
            
            <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden mb-2 border border-slate-700/50">
                <div id="usageBar" class="h-full bg-gradient-to-r from-green-500 to-emerald-400 transition-all duration-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]" style="width: 0%"></div>
            </div>
            
            <div class="flex justify-between text-[10px] text-slate-400 font-mono">
               <span><span id="usageCost" class="text-slate-200 font-bold">$0.00</span> / $5.00</span>
               <span id="usageRequests" class="text-slate-500">0 reqs</span>
            </div>
        </div>
        <div class="mt-3 bg-slate-900/70 rounded-xl p-3 border border-slate-700">
            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-2 flex items-center gap-1">
                <i class="ph ph-palette"></i> Theme
            </div>
            <div class="grid grid-cols-3 gap-2">
                <button class="theme-chip" data-theme-btn="studio-blue" onclick="window.setTheme('studio-blue')">Studio Blue</button>
                <button class="theme-chip" data-theme-btn="dark" onclick="window.setTheme('dark')">Dark</button>
                <button class="theme-chip" data-theme-btn="light" onclick="window.setTheme('light')">Light</button>
            </div>
        </div>
    </div>

    <div class="p-4 border-t border-slate-800 text-xs text-slate-600 text-center">
        <div id="userEmailDisplay" class="text-[10px] text-blue-400 mb-2 truncate">Checking Auth...</div>
        <button onclick="window.handleLogout()" class="w-full py-2 border border-red-900/30 rounded text-red-400 hover:bg-red-900/20 transition flex items-center justify-center gap-1">
            <i class="ph ph-sign-out"></i> Logout
        </button>
    </div>
  </aside>

  <!-- MAIN CONTENT AREA (RIGHT) -->
  <div class="flex-1 flex flex-col h-full relative w-full">
    <header class="md:hidden h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 z-30 shrink-0">
        <button onclick="window.toggleSidebar()" class="text-white p-2"><i class="ph ph-list text-2xl"></i></button>
        <span class="font-bold text-blue-300 text-lg">With You Studio</span>
        <div class="w-8"></div>
    </header>

    
    <!-- Dynamic Content Container -->
    <div id="content-container" class="flex-1 overflow-y-auto p-4 md:p-8 max-w-4xl mx-auto w-full pb-20 scroll-smooth custom-scroll">
        <!-- Content injects here via JS -->
    </div>
  </div>

  <div id="toast" class="toast">Action Complete</div>

  <!-- TEMPLATES -->
  
  <!-- 0. AI MANAGER TEMPLATE -->
  <template id="tpl-manager">
    <div class="animate-fade-in space-y-4 h-full flex flex-col">
        <div class="flex items-center justify-between shrink-0">
            <h2 class="text-xl md:text-3xl font-bold text-sky-300 flex items-center gap-3"><i class="ph ph-robot"></i> Strategy Partner</h2>
            <div class="text-[10px] text-slate-400 bg-slate-800/50 border border-slate-700 px-3 py-1 rounded-full">Today's Direction</div>
        </div>
        
        <!-- Chat Area -->
        <div id="chatContainer" class="flex-1 overflow-y-auto space-y-4 p-2 custom-scroll">
            <div class="flex flex-col space-y-4">
                <div class="flex items-start gap-3">
                    <div class="w-9 h-9 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400 border border-yellow-500/30 shrink-0 shadow-lg shadow-yellow-500/10"><i class="ph ph-robot text-lg"></i></div>
                    <div class="chat-bubble-ai max-w-[90%] md:max-w-[75%]">
                        ·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´ ·ÄÄ·Ä≠·ÄØ·ÄÖ·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äõ·Ä±·Åã ·Äí·ÄÆ·Äî·Ä±·Ä∑ ·Äò·Ä¨·Äú·ÄØ·Äï·Ä∫·ÄÄ·Äº·Äô·Äú·Ä≤·Äó·Äª? ·Ä°·Äú·ÄØ·Äï·Ä∫·ÄÄ·Ä≠·ÄÖ·Äπ·ÄÖ ·ÄÜ·ÄΩ·Ä±·Ä∏·Äî·ÄΩ·Ä±·Ä∏·Äô·Äú·Ä¨·Ä∏·Åä Content ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Ä°·ÄÄ·Äº·Ä∂·Äâ·Ä¨·Äè·Ä∫·Äö·Ä∞·Äô·Äú·Ä¨·Ä∏·Åä ·Äí·Ä´·Äô·Äæ·Äô·Äü·ÄØ·Äê·Ä∫ ·ÄÖ·Ä≠·Äê·Ä∫·Äë·ÄΩ·ÄÄ·Ä∫·Äï·Ä±·Ä´·ÄÄ·Ä∫·Ä°·Äî·Ä±·Äî·Ä≤·Ä∑ ·ÄÖ·ÄÄ·Ä¨·Ä∏·Äï·Äº·Ä±·Ä¨·Äô·Äú·Ä¨·Ä∏?
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area (Fixed Bottom) -->
        <div class="shrink-0 pt-3 space-y-3 pb-2">
            <!-- Quick Chips -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 px-1">
                <button onclick="window.sendChat('üí° ·Äí·ÄÆ·Äî·Ä±·Ä∑·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ Idea ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äú·Ä±·Ä¨·ÄÄ·Ä∫ ·Äï·Ä±·Ä∏·Äï·Ä´')" class="whitespace-nowrap px-4 py-2 rounded-full bg-slate-800/80 border border-slate-700 text-xs font-medium text-slate-300 hover:bg-slate-700 hover:border-yellow-500/50 hover:text-white transition backdrop-blur-sm shadow-sm">üí° Today Idea</button>
                <button onclick="window.sendChat('üì© Client ·ÄÄ ·Äà·Ä±·Ä∏·Äô·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·ÄÑ·Äº·Ä≠·Äô·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äê·Äö·Ä∫ ·Äò·Ä¨·Äï·Äº·Äî·Ä∫·Äï·Äº·Ä±·Ä¨·Äõ·Äô·Äú·Ä≤?')" class="whitespace-nowrap px-4 py-2 rounded-full bg-slate-800/80 border border-slate-700 text-xs font-medium text-slate-300 hover:bg-slate-700 hover:border-purple-500/50 hover:text-white transition backdrop-blur-sm shadow-sm">üì© DM Strategy</button>
                <button onclick="window.sendChat('üé• TikTok ·Äî·Ä≤·Ä∑ FB ·Äô·Äæ·Ä¨ ·Äò·Ä¨·Äê·ÄÑ·Ä∫·Äõ·ÄÑ·Ä∫·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äú·Ä≤?')" class="whitespace-nowrap px-4 py-2 rounded-full bg-slate-800/80 border border-slate-700 text-xs font-medium text-slate-300 hover:bg-slate-700 hover:border-blue-500/50 hover:text-white transition backdrop-blur-sm shadow-sm">üé• Content Plan</button>
                <button onclick="window.sendChat('üß† ·ÄÑ·Ä´·Äî·Ä≤·Ä∑ ·Ä°·Äê·Ä∞·Äê·Ä∞ ·ÄÖ·Äâ·Ä∫·Ä∏·ÄÖ·Ä¨·Ä∏·Äï·Ä±·Ä∏·Äï·Ä´')" class="whitespace-nowrap px-4 py-2 rounded-full bg-slate-800/80 border border-slate-700 text-xs font-medium text-slate-300 hover:bg-slate-700 hover:border-green-500/50 hover:text-white transition backdrop-blur-sm shadow-sm">üß† Brainstorm</button>
            </div>

            <!-- Input Box -->
            <div class="relative glass-panel rounded-2xl p-2 flex items-end gap-2 border border-slate-600/50 shadow-xl">
<textarea id="chatInput" rows="1" placeholder="·ÄÄ·Ä≠·ÄØ·ÄÖ·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·Äï·Äº·Ä±·Ä¨·ÄÅ·Äª·ÄÑ·Ä∫·Äê·Ä¨ ·Äõ·Ä±·Ä∏·Äï·Ä´..." class="flex-1 bg-transparent border-none text-white text-sm px-4 py-3 focus:ring-0 resize-none max-h-32 placeholder-slate-500" onkeydown="if(event.key === 'Enter' && !event.shiftKey && !event.isComposing) { event.preventDefault(); window.handleChatSubmit(); }"></textarea>                
                <button onclick="window.startVoiceInput('chatInput', this)" class="p-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-700/50 transition shrink-0" title="Voice"><i class="ph ph-microphone text-xl"></i></button>
                
                <button onclick="window.handleChatSubmit()" class="p-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg hover:shadow-blue-500/20 active:scale-95 transition shrink-0">
                    <i class="ph ph-paper-plane-right-fill text-xl"></i>
                </button>
            </div>
        </div>
    </div>
  </template>
<template id="tpl-mentor">
    <div class="space-y-6 animate-fade-in pb-20"> <div class="flex items-center justify-between">
        <h2 class="text-xl md:text-2xl font-bold text-emerald-400 flex items-center gap-2">
          <i class="ph ph-student"></i> Mentor Mode
        </h2>
        <span class="text-[10px] bg-emerald-900/30 text-emerald-300 px-3 py-1 rounded-full border border-emerald-500/30">
          Inspiration ‚Ä¢ Art ‚Ä¢ Skill
        </span>
      </div>

      <div class="glass-panel p-5 rounded-xl border border-emerald-500/20 space-y-3">
        <label class="text-xs font-bold text-emerald-300 uppercase">Ask your mentor</label>
        <div class="relative">
          <textarea id="mentorInput" rows="3" placeholder="·Ä•·Äï·Äô·Ä¨ - ·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äæ·Ä¨ emotion ·ÄÄ·Ä≠·ÄØ ·Äò·Äö·Ä∫·Äú·Ä≠·ÄØ·Äñ·Äô·Ä∫·Ä∏·Äõ·Äô·Äú·Ä≤?" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-4 text-sm text-white resize-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/50 outline-none"></textarea>
          
          <button onclick="window.startVoiceInput('mentorInput', this)" class="absolute right-3 bottom-3 p-2 rounded-full bg-slate-800 hover:bg-emerald-600 text-emerald-300 hover:text-white transition">
            <i class="ph ph-microphone"></i>
          </button>
        </div>

        <button onclick="window.generateAI('mentor')" class="w-full mt-2 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95 flex items-center justify-center gap-2">
           <i class="ph ph-magic-wand"></i> Ask Mentor
        </button>
      </div>

      <div class="glass-panel p-5 rounded-xl border border-slate-700 space-y-4">
        <h3 class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
            <i class="ph ph-books"></i> Study the Masters
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div onclick="window.askMaster('Jerry Ghionis', 'Lighting & Posing')" class="p-4 bg-slate-900/50 hover:bg-slate-800 rounded-lg border border-slate-700 hover:border-emerald-500/50 cursor-pointer transition group">
            <h4 class="font-bold text-white group-hover:text-emerald-400 transition">Jerry Ghionis</h4>
            <p class="text-xs text-slate-400 mt-1">Lighting ‚Ä¢ Drama ‚Ä¢ Direction</p>
          </div>

          <div onclick="window.askMaster('Jose Villa', 'Fine Art Film Style')" class="p-4 bg-slate-900/50 hover:bg-slate-800 rounded-lg border border-slate-700 hover:border-emerald-500/50 cursor-pointer transition group">
            <h4 class="font-bold text-white group-hover:text-emerald-400 transition">Jose Villa</h4>
            <p class="text-xs text-slate-400 mt-1">Film ‚Ä¢ Natural Light ‚Ä¢ Fine Art</p>
          </div>

          <div onclick="window.askMaster('Fer Juaristi', 'Creative Composition')" class="p-4 bg-slate-900/50 hover:bg-slate-800 rounded-lg border border-slate-700 hover:border-emerald-500/50 cursor-pointer transition group">
            <h4 class="font-bold text-white group-hover:text-emerald-400 transition">Fer Juaristi</h4>
            <p class="text-xs text-slate-400 mt-1">Emotion ‚Ä¢ Storytelling ‚Ä¢ Fun</p>
          </div>

          <div onclick="window.askMaster('Two Mann Studios', 'Documentary Moments')" class="p-4 bg-slate-900/50 hover:bg-slate-800 rounded-lg border border-slate-700 hover:border-emerald-500/50 cursor-pointer transition group">
            <h4 class="font-bold text-white group-hover:text-emerald-400 transition">Two Mann</h4>
            <p class="text-xs text-slate-400 mt-1">Moments ‚Ä¢ Layers ‚Ä¢ Context</p>
          </div>
        </div>
      </div>

      <div id="mentorResultArea" class="hidden glass-panel p-5 rounded-xl border border-emerald-500/30 shadow-lg shadow-emerald-900/20">
        <div class="flex justify-between items-center mb-3">
          <span class="text-xs font-bold text-emerald-400 uppercase flex items-center gap-2"><i class="ph ph-chalkboard-teacher"></i> Mentor Advice</span>
          <button onclick="window.copyText('mentorOutput')" class="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded text-white border border-slate-600 transition">Copy</button>
        </div>
        <div id="mentorOutput" class="whitespace-pre-wrap text-sm text-slate-200 leading-relaxed custom-scroll max-h-[500px] overflow-y-auto"></div>
        
        <button id="mentorContinueBtn" onclick="window.continueAI('mentor')" class="hidden w-full mt-3 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded text-emerald-400 text-xs font-bold transition">
             Tell me more...
        </button>
      </div>

    </div>
  </template>

  <!-- CREATIVE DIRECTOR TEMPLATE -->
  <template id="tpl-creative">
    <div class="animate-fade-in space-y-6">
      <div class="flex items-center justify-between">
        <h2 class="text-xl md:text-3xl font-bold text-cyan-300 flex items-center gap-3"><i class="ph ph-lightbulb"></i> Content Command Center Lite</h2>
      </div>

      <div class="glass-panel p-6 rounded-2xl border border-cyan-500/20 shadow-xl relative overflow-hidden">
        <i class="ph ph-sparkle absolute -top-4 -right-4 text-8xl text-cyan-400 opacity-10 rotate-12"></i>
        <div class="relative z-10 space-y-5">
          <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4 space-y-4">
            <div class="text-sm font-bold text-cyan-300 uppercase tracking-wide">Quick Copy-Ready Generator</div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Service</label>
                <select id="liteService" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white">
                  <option value="pre_wedding">Pre-Wedding</option>
                  <option value="wedding_day">Wedding Day</option>
                  <option value="family_portrait">Family Portrait</option>
                  <option value="general">General</option>
                </select>
              </div>
              <div>
                <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Platform</label>
                <select id="litePlatform" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white">
                  <option value="both">Facebook + TikTok</option>
                  <option value="facebook">Facebook Only</option>
                  <option value="tiktok">TikTok Only</option>
                </select>
              </div>
              <div>
                <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Goal</label>
                <select id="liteGoal" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white">
                  <option value="booking">Booking</option>
                  <option value="awareness">Awareness</option>
                </select>
              </div>
              <div>
                <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Tone</label>
                <select id="liteTone" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white">
                  <option value="premium">Premium</option>
                  <option value="emotional">Emotional</option>
                  <option value="friendly">Friendly</option>
                </select>
              </div>
              <div>
                <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Page Voice</label>
                <select id="liteVoice" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white">
                  <option value="premium">Premium Cinematic</option>
                  <option value="friendly">Friendly Local</option>
                </select>
              </div>
            </div>

            <div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                <div>
                  <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">7-Day Plan (FB)</label>
                  <select id="liteDayPlan" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white">
                    <option value="day1">Day 1: Re-Introduce</option>
                    <option value="day2">Day 2: BTS Reel</option>
                    <option value="day3">Day 3: Before/After</option>
                    <option value="day4">Day 4: Review/Proof</option>
                    <option value="day5">Day 5: Education</option>
                    <option value="day6">Day 6: Mini Offer</option>
                    <option value="day7">Day 7: Live/Recap</option>
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Apply Helper</label>
                  <button id="liteApplyDayBtn" onclick="window.applyLiteDayPlan()" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white font-bold py-2.5 rounded-lg text-xs transition">
                    Apply Day Plan to Topic/Guideline
                  </button>
                </div>
              </div>
              <div id="liteDayHint" class="text-[11px] text-slate-400 mb-2"></div>
              <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Topic / Guideline</label>
              <textarea id="liteTopicGuideline" rows="4" placeholder="·Ä•·Äï·Äô·Ä¨ - Pre-Wedding mood ·Äõ·ÄÑ·Ä∫·ÄÅ·ÄØ·Äî·Ä∫·Äñ·ÄΩ·Äö·Ä∫ style, booking CTA ·ÄÄ·Ä≠·ÄØ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏·Äú·ÄÑ·Ä∫·Ä∏ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white resize-y"></textarea>
            </div>

            <details class="bg-slate-900/40 border border-slate-700 rounded-lg p-3">
              <summary class="cursor-pointer text-[11px] font-bold text-slate-300 uppercase">Studio Context (Optional)</summary>
              <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
                <input id="liteOffer" type="text" placeholder="Offer (·Ä•·Äï·Äô·Ä¨ - 15% Off + 3 outfit)" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white" />
                <input id="liteLocation" type="text" placeholder="Location (·Ä•·Äï·Äô·Ä¨ - Taunggyi Indoor Studio)" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white" />
                <input id="liteContact" type="text" placeholder="Contact (·Ä•·Äï·Äô·Ä¨ - 09255521464 Viber)" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white" />
              </div>
            </details>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
              <button id="liteSuggestBtn" onclick="window.liteSuggestTopics()" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white font-bold py-3 rounded-lg text-xs transition">Suggest 3 Topics</button>
              <button id="liteGenerateBtn" onclick="window.liteGenerateFinal(false)" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 rounded-lg text-xs transition shadow">Generate Final</button>
              <button id="liteRegenerateBtn" onclick="window.liteGenerateFinal(true)" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded-lg text-xs transition">Regenerate Stronger</button>
              <button id="liteVariantsBtn" onclick="window.liteGenerateVariants()" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white font-bold py-3 rounded-lg text-xs transition">3 FB Variants</button>
            </div>

            <div class="bg-slate-900/40 border border-emerald-500/20 rounded-lg p-3 space-y-2">
              <div class="text-[11px] font-bold text-emerald-300 uppercase tracking-wide">Agent Automation</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                <label class="flex items-center gap-2 text-xs text-slate-300 bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2 cursor-pointer">
                  <input id="liteAutoPublishFB" type="checkbox" class="w-4 h-4">
                  Auto publish Facebook
                </label>
                <label class="flex items-center gap-2 text-xs text-slate-300 bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2 cursor-pointer">
                  <input id="liteAutoPublishTT" type="checkbox" class="w-4 h-4">
                  Auto publish TikTok
                </label>
                <button id="liteAgentBtn" onclick="window.liteRunAgent()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2.5 rounded-lg text-xs transition">Run Full Agent</button>
              </div>
              <div id="liteAgentLog" class="text-[11px] text-slate-400 whitespace-pre-wrap"></div>
            </div>
          </div>

          <div id="liteIdeaWrap" class="hidden bg-slate-900/60 border border-cyan-500/30 rounded-xl p-4 space-y-3">
            <div class="text-[11px] font-bold text-cyan-300 uppercase tracking-wide">Suggested Topics (3)</div>
            <div id="liteIdeaList" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
          </div>

          <div id="liteResultArea" class="hidden space-y-4">
            <div id="liteFBBlock" class="bg-slate-900/60 border border-blue-500/30 rounded-xl p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="text-sm font-bold text-blue-300 uppercase">Facebook Final</div>
                <button onclick="window.copyText('liteFBOutput')" class="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded border border-slate-600">Copy</button>
              </div>
              <div id="liteFBOutput" class="whitespace-pre-wrap text-sm text-slate-100 leading-relaxed"></div>
            </div>

            <div id="liteTTBlock" class="bg-slate-900/60 border border-teal-500/30 rounded-xl p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="text-sm font-bold text-teal-300 uppercase">TikTok Final</div>
                <button onclick="window.copyText('liteTTOutput')" class="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded border border-slate-600">Copy</button>
              </div>
              <div id="liteTTOutput" class="whitespace-pre-wrap text-sm text-slate-100 leading-relaxed"></div>
            </div>
          </div>

          <input type="hidden" id="csService" value="pre_wedding" />
          <input type="hidden" id="csTone" value="premium" />
          <input type="hidden" id="csTopic" value="" />
          <input type="hidden" id="csCTA" value="Inbox for booking" />
          <input type="hidden" id="crFocus" value="Auto Mix" />
          <input type="checkbox" id="crFB" class="hidden" checked />
          <input type="checkbox" id="crTT" class="hidden" checked />
          <input type="hidden" id="crPhotoContext" value="" />
          <input type="hidden" id="crWorkload" value="Normal" />
          <div id="crResultArea" class="hidden"><div id="crOutput"></div></div>
          <button id="crContinueBtn" class="hidden"></button>
        </div>
      </div>
    </div>
  </template>

  <!-- 1. DM SALES MASTER TEMPLATE -->
  <template id="tpl-dm">
    <div class="animate-fade-in space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl md:text-3xl font-bold text-indigo-300 flex items-center gap-3">
                <i class="ph ph-chat-circle-text"></i> DM Conversion Desk
            </h2>
        </div>
        
        <div class="glass-panel p-6 rounded-2xl border border-purple-500/20 shadow-xl relative overflow-hidden">
            <i class="ph ph-chat-teardrop-text absolute -top-4 -right-4 text-9xl text-purple-500 opacity-5 rotate-12"></i>

            <div class="relative z-10 space-y-6">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">Topic</label>
                        <select id="dmService" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl p-3 text-sm text-white focus:border-purple-500 outline-none">
                            <option value="Pre-wedding Package">üíç Pre-wedding</option>
                            <option value="Wedding Actual Day">üë∞ Wedding Day</option>
                            <option value="Family Photoshoot">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</option>
                            <option value="Graduation Photo">üéì Graduation</option>
                            <option value="General Inquiry">‚ùì General</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">Client Status</label>
                        <select id="dmScenario" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl p-3 text-sm text-white focus:border-purple-500 outline-none">
                            <option value="New Inquiry">New Inquiry</option>
                            <option value="Price Objection">Expensive (·Äà·Ä±·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏)</option>
                            <option value="Ghosting">Seen (·ÄÖ·Ä¨·Äô·Äï·Äº·Äî·Ä∫)</option>
                            <option value="Comparing">Comparing (·Äö·Äæ·Äâ·Ä∫·Äî·Ä±)</option>
                            <option value="Closing">Ready to Book</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">Strategy</label>
                        <select id="dmType" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl p-3 text-sm text-white focus:border-purple-500 outline-none">
                            <option value="Soft Close">Soft Close (·Äï·ÄØ·Ä∂·Äô·Äæ·Äî·Ä∫)</option>
                            <option value="Price Defense">Price Defense (·Äê·Äî·Ä∫·Äñ·Ä≠·ÄØ·Ä∏·Äï·Äº)</option>
                            <option value="Urgency">Create Urgency (·Äô·Äº·Äî·Ä∫·Äô·Äº·Äî·Ä∫)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider flex justify-between">
                        <span>Client Message / Context</span>
                        <span class="text-purple-400 text-[10px] cursor-pointer hover:underline" onclick="document.getElementById('dmInput').value=''">Clear</span>
                    </label>
                    <div class="relative">
                        <textarea id="dmInput" placeholder="Client ·Äô·Ä±·Ä∏·Äê·Ä≤·Ä∑·ÄÖ·Ä¨ (·Äû·Ä≠·ÄØ·Ä∑) ·Ä°·ÄÅ·Äº·Ä±·Ä°·Äî·Ä±·ÄÄ·Ä≠·ÄØ ·Äí·ÄÆ·Äô·Äæ·Ä¨·Äõ·Ä±·Ä∏·Äï·Ä´..." class="w-full bg-slate-900/50 border border-slate-600 rounded-xl p-4 text-sm h-32 text-white resize-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500/50 pr-12 shadow-inner transition"></textarea>
                        <button onclick="window.startVoiceInput('dmInput', this)" class="absolute right-3 bottom-3 bg-slate-700/80 hover:bg-purple-600 p-2.5 rounded-full transition text-slate-300 hover:text-white shadow-lg"><i class="ph ph-microphone text-xl"></i></button>
                    </div>
                </div>

                <div id="dmAnalysisPanel" class="hidden animate-fade-in bg-slate-900/80 p-4 rounded-xl border border-indigo-500/30">
                    <div class="text-[10px] text-indigo-400 uppercase font-bold tracking-wider mb-2 flex items-center gap-2"><i class="ph ph-magic-wand"></i> AI Analysis</div>
                    <div id="dmAnalysisContent" class="text-sm text-slate-300 leading-relaxed whitespace-pre-wrap"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 pt-2">
                    <button onclick="window.generateAI('dm_analyze')" class="bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3.5 rounded-xl border border-slate-600 transition active:scale-95 flex items-center justify-center gap-2">
                        <i class="ph ph-magnifying-glass text-lg"></i> Analyze Only
                    </button>
                    <button onclick="window.generateAI('dm_best')" class="bg-slate-800 hover:bg-slate-700 text-purple-300 font-bold py-3.5 rounded-xl border border-slate-600 transition active:scale-95 flex items-center justify-center gap-2">
                        Generate Options
                    </button>
                    <button onclick="window.generateAI('dm_auto_detect')" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-purple-900/40 transition active:scale-95 flex items-center justify-center gap-2">
                        <i class="ph ph-lightning text-xl"></i> Auto Reply
                    </button>
                </div>
            </div>
        </div>

        <div id="dmResultArea" class="hidden animate-fade-in">
            <div class="glass-panel p-6 rounded-2xl border border-purple-500/30 relative overflow-hidden shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm font-bold text-purple-400 uppercase flex items-center gap-2"><i class="ph ph-check-circle-fill"></i> Generated Reply</span>
                    <button onclick="window.copyText('dmOutput')" class="text-sm bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg border border-slate-600 text-white transition">Copy</button>
                </div>
                
                <div id="dmOutput" class="whitespace-pre-wrap text-sm text-slate-200 leading-relaxed bg-slate-950/30 p-5 rounded-xl border border-white/5 max-h-[500px] overflow-y-auto custom-scroll"></div>
                
                <button id="dmContinueBtn" onclick="window.continueAI('dm_best')" class="hidden w-full mt-3 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-xl text-purple-300 text-sm font-bold flex items-center justify-center gap-2 transition active:scale-95">
                    <span>‚ö†Ô∏è Continue Writing</span>
                </button>
            </div>
        </div>
    </div>
  </template>

  <!-- 2. BRAND BRAIN TEMPLATE -->
  <template id="tpl-brand">
    <div class="animate-fade-in max-w-2xl mx-auto space-y-6">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-8 rounded-3xl border border-slate-700 relative overflow-hidden shadow-2xl">
            <h2 class="text-xl md:text-3xl font-bold text-white mb-2 flex items-center gap-3"><i class="ph ph-database text-blue-400"></i> Studio Brain (Cloud Sync)</h2>
            <div class="space-y-6 text-left relative z-10">
                <div class="bg-slate-950/50 p-5 rounded-2xl border border-slate-700">
                    <label class="text-sm font-bold text-yellow-400 uppercase mb-3 block flex items-center gap-2"><i class="ph ph-package"></i> Packages & Pricing (Important)</label>
                    <textarea id="brandPackages" placeholder="Example: Silver Package: 3 Lakhs..." class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-sm text-white h-32 resize-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500/50"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="text-sm font-bold text-blue-400 uppercase mb-2 block">Studio Vibe</label>
                        <input type="text" id="brandStyle" value="Moody, Cinematic, Emotional" class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white">
                    </div>
                    <div>
                        <label class="text-sm font-bold text-blue-400 uppercase mb-2 block">Target Audience</label>
                        <input type="text" id="brandClient" value="Luxury Couples, Young Professionals" class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white">
                    </div>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-300 uppercase mb-2 block">Contact Details</label>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="brandPhone" placeholder="Phone" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                        <input type="text" id="brandViber" placeholder="Viber" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                        <input type="text" id="brandFB" placeholder="Facebook Link" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                        <input type="text" id="brandTT" placeholder="TikTok Link" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                        <input type="text" id="brandportfolio" placeholder="portfolio Link" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                    </div>
                    <input type="text" id="brandAddr" placeholder="Address (Taunggyi)" class="mt-3 w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                </div>
                <div class="pt-4 flex flex-col items-center gap-2">
                    <button onclick="window.saveBrandData()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transition active:scale-95"><i class="ph ph-floppy-disk text-xl"></i> Save Changes to Cloud</button>
                    <div id="saveStatus" class="text-sm text-slate-500 text-center">Sync ready.</div>
                </div>
            </div>
        </div>
    </div>
  </template>


  <template id="tpl-studio">
    <div class="animate-fade-in space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl md:text-2xl font-bold text-cyan-300 flex items-center gap-2"><i class="ph ph-sparkle"></i> Creative Studio</h2>
            <span class="text-[10px] md:text-xs px-2 py-1 rounded border border-cyan-500/30 bg-cyan-900/20 text-cyan-300">Persona + Tone Engine</span>
        </div>

        <div class="glass-panel p-6 rounded-2xl border border-cyan-500/20 space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Template</label>
                    <select id="csTemplate" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white">
                        <option value="default">Default Conversion Post</option>
                        <option value="client_showcase">Client Showcase</option>
                        <option value="behind_the_scenes">Behind The Scenes</option>
                        <option value="promotion">Promotion / Offer</option>
                        <option value="educational">Educational Tip</option>
                        <option value="teaser">Teaser / Coming Soon</option>
                        <option value="testimonial">Testimonial Post</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Service</label>
                    <select id="csService" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white">
                        <option value="general">General</option>
                        <option value="pre-wedding">Pre-Wedding</option>
                        <option value="wedding-day">Wedding Day</option>
                        <option value="family">Family Portrait</option>
                        <option value="solo-portrait">Solo Portrait</option>
                        <option value="studio-promo">Studio Promotion</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Persona</label>
                    <select id="csPersona" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white">
                        <option value="sales_closer">Sales Closer</option>
                        <option value="creative_director">Creative Director</option>
                        <option value="warm_storyteller">Warm Storyteller</option>
                        <option value="my_brand_voice">My Brand Voice</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Tone</label>
                    <select id="csTone" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white">
                        <option value="emotional">Emotional</option>
                        <option value="professional">Professional</option>
                        <option value="friendly">Friendly</option>
                        <option value="urgent">Urgent</option>
                        <option value="cinematic">Cinematic</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Length</label>
                    <select id="csLength" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white">
                        <option value="short">Short</option>
                        <option value="medium" selected>Medium</option>
                        <option value="long">Long</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Language</label>
                    <select id="csLanguage" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white">
                        <option value="burmese_default">Burmese Default</option>
                        <option value="eng_header_burmese_body">English Header + Burmese Body</option>
                        <option value="english_only">English Only</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Audience</label>
                    <input id="csAudience" type="text" placeholder="e.g. Luxury couples, young professionals" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white" />
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Main Topic / Brief</label>
                <textarea id="csTopic" rows="3" placeholder="Topic, mood, core message..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white resize-none"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Keywords</label>
                    <input id="csKeywords" type="text" placeholder="wedding, memories, cinematic" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white" />
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">CTA</label>
                    <input id="csCTA" type="text" placeholder="Book now, send message..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white" />
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Avoid</label>
                <input id="csAvoid" type="text" placeholder="robotic words, hard sell..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white" />
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Content Format</label>
                <div id="csFormats" class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-slate-300">
                    <label class="flex items-center gap-2 bg-slate-800 border border-slate-700 p-2 rounded"><input type="checkbox" value="fb_post" checked> FB Post</label>
                    <label class="flex items-center gap-2 bg-slate-800 border border-slate-700 p-2 rounded"><input type="checkbox" value="caption"> Caption</label>
                    <label class="flex items-center gap-2 bg-slate-800 border border-slate-700 p-2 rounded"><input type="checkbox" value="hook_set"> Hook Set</label>
                    <label class="flex items-center gap-2 bg-slate-800 border border-slate-700 p-2 rounded"><input type="checkbox" value="hashtag_pack"> Hashtag Pack</label>
                    <label class="flex items-center gap-2 bg-slate-800 border border-slate-700 p-2 rounded"><input type="checkbox" value="tiktok_cover"> TikTok Cover</label>
                    <label class="flex items-center gap-2 bg-slate-800 border border-slate-700 p-2 rounded"><input type="checkbox" value="tiktok_script"> TikTok Script</label>
                    <label class="flex items-center gap-2 bg-slate-800 border border-slate-700 p-2 rounded"><input type="checkbox" value="tiktok_caption"> TikTok Caption</label>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-2 text-sm">
                <label class="flex items-center gap-2 bg-slate-800 border border-slate-700 p-2 rounded text-slate-300"><input id="csIncludeContact" type="checkbox"> Include Contact</label>
                <label class="flex items-center gap-2 bg-slate-800 border border-slate-700 p-2 rounded text-slate-300"><input id="csIncludeDM" type="checkbox"> Include DM Link</label>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button onclick="window.generateAI('studio_ideas')" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg py-2.5 text-xs font-bold text-slate-200">üí° Ideas</button>
                <button onclick="window.generateAI('studio_hooks')" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg py-2.5 text-xs font-bold text-slate-200">üé£ Hooks</button>
                <button onclick="window.generateAI('studio_cta')" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg py-2.5 text-xs font-bold text-slate-200">üì£ CTA Variants</button>
                <button onclick="window.generateAI('studio_hashtags')" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg py-2.5 text-xs font-bold text-slate-200"># Hashtags</button>
            </div>

            <button onclick="window.generateAI('creative_studio')" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition">Generate Creative Studio Content</button>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <button onclick="window.generateAI('studio_pack_fb')" class="bg-blue-700 hover:bg-blue-600 text-white font-bold py-2.5 rounded-lg text-sm">FB Post Pack</button>
                <button onclick="window.generateAI('studio_pack_tiktok')" class="bg-teal-700 hover:bg-teal-600 text-white font-bold py-2.5 rounded-lg text-sm">TikTok Pack</button>
                <button onclick="window.generateAI('studio_pack_dm')" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-2.5 rounded-lg text-sm">DM Reply Pack</button>
            </div>
        </div>

        <div id="studioResultArea" class="hidden glass-panel p-5 rounded-xl border border-cyan-500/30 space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-sm font-bold text-cyan-300">Creative Studio Output</span>
                <button onclick="window.copyText('studioOutput')" class="text-xs bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded px-3 py-1.5">Copy</button>
            </div>
            <div id="studioOutput" class="whitespace-pre-wrap text-sm text-slate-200 leading-relaxed"></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                <button onclick="window.downloadFile('CreativeStudio.txt', 'studioOutput')" class="text-xs bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded py-2">Download TXT</button>
                <button onclick="window.downloadMarkdownFile('CreativeStudio.md', 'studioOutput')" class="text-xs bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded py-2">Download MD</button>
                <button onclick="window.copyText('studioOutput')" class="text-xs bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded py-2">Copy All</button>
            </div>
            <button id="studioContinueBtn" onclick="window.continueAI('creative_studio')" class="hidden w-full py-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded text-cyan-300 text-xs font-bold">Continue Writing</button>
        </div>
    </div>
  </template>

  <template id="tpl-fbpost">
    <div class="animate-fade-in space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl md:text-2xl font-bold text-white flex items-center gap-2"><i class="ph ph-facebook-logo text-blue-500"></i> Facebook Post</h2>
            <span class="bg-blue-900/30 text-blue-400 text-[10px] md:text-xs px-2 py-1 rounded border border-blue-500/30">3 Options</span>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <div class="glass-panel p-6 md:p-5 rounded-xl space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Topic</label>
                        <div class="flex gap-2">
                            <input type="text" id="fbInput" placeholder="·Ä•·Äï·Äô·Ä¨ - Pre-wedding package..." class="flex-1 w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white">
                            <button onclick="window.startVoiceInput('fbInput', this)" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg px-4 flex items-center justify-center transition active:scale-95"><i class="ph ph-microphone text-xl text-blue-400"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Tone</label><select id="fbTone" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm outline-none text-white"><option>Professional & Warm</option><option>Friendly & Exciting</option><option>Emotional</option></select></div>
                        <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Length</label><select id="fbLength" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm outline-none text-white"><option value="Medium">Medium</option><option value="Long">Long</option><option value="Short">Short</option></select></div>
                    </div>
                    <button onclick="window.generateAI('fbpost')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-600/30 transition flex justify-center items-center gap-2 active:scale-95"><i class="ph ph-pen-nib"></i> Write Post (3 Options)</button>
                </div>
                <div id="fbResultArea" class="hidden space-y-2">
                    <div class="glass-panel p-6 md:p-6 rounded-xl border-blue-500/30">
                        <div id="fbOutput" class="whitespace-pre-wrap leading-relaxed text-sm text-slate-200"></div>
                    </div>
                    <button id="fbContinueBtn" onclick="window.continueAI('fbpost')" class="hidden w-full py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-blue-300 text-sm font-bold flex items-center justify-center gap-2"><span>‚ö†Ô∏è Continue Writing</span><i class="ph ph-arrow-right"></i></button>
                    <div class="flex gap-2">
                        <div class="flex-1 py-3 text-center text-xs text-green-400 italic">‚úÖ Auto-saved</div>
                        <button onclick="window.copyText('fbOutput')" class="flex-1 bg-slate-800 hover:bg-slate-700 py-3 rounded-lg text-xs font-bold border border-slate-700">üìã Copy</button>
                    </div>
                </div>
            </div>
            <div class="space-y-4">
                <div class="bg-slate-900 border border-slate-800 p-4 rounded-xl">
                    <h3 class="text-sm font-bold text-blue-300 mb-3 flex items-center gap-2"><i class="ph ph-sparkle"></i> Creative Assistant</h3>
                    <div class="space-y-2">
                        <button onclick="window.runAssistant('fb_ideas')" class="w-full text-left p-3 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-slate-300 border border-slate-700 transition">üí° Get 5 Post Ideas</button>
                        <button onclick="window.runAssistant('fb_hooks')" class="w-full text-left p-3 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-slate-300 border border-slate-700 transition">üé£ Generate Catchy Hooks</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </template>

  <template id="tpl-timeline">
    <div class="animate-fade-in space-y-6">
        <h2 class="text-xl md:text-2xl font-bold text-orange-400 flex items-center gap-2"><i class="ph ph-clock"></i> Timeline Generator</h2>
        <div class="glass-panel p-6 md:p-6 rounded-xl">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div><label class="text-sm text-slate-400 uppercase font-bold">Start</label><select id="tlStart" class="w-full p-2 mt-1 bg-slate-800 rounded border border-slate-700 text-white"><option>6:00 AM</option><option>7:00 AM</option><option>8:00 AM</option><option>1:00 PM</option></select></div>
                <div><label class="text-sm text-slate-400 uppercase font-bold">Place</label><select id="tlPlace" class="w-full p-2 mt-1 bg-slate-800 rounded border border-slate-700 text-white"><option>Taunggyi (City)</option><option>Inle Lake</option><option>Kalaw</option></select></div>
                <div><label class="text-sm text-slate-400 uppercase font-bold">Outfits</label><select id="tlDress" class="w-full p-2 mt-1 bg-slate-800 rounded border border-slate-700 text-white"><option>3 Dresses</option><option>4 Dresses</option><option>5 Dresses</option></select></div>
                <div><label class="text-sm text-slate-400 uppercase font-bold">Pacing</label><select id="tlPace" class="w-full p-2 mt-1 bg-slate-800 rounded border border-slate-700 text-white"><option>Relaxed</option><option>Packed</option></select></div>
            </div>
            <div class="flex items-center gap-2 mb-4 p-2 bg-slate-800/50 rounded"><input type="checkbox" id="tlSunset" class="w-4 h-4 rounded bg-slate-800 border-slate-700 text-orange-500"><label for="tlSunset" class="text-sm text-slate-300">Include Sunset Shot</label></div>
            <button onclick="window.generateAI('timeline')" class="w-full bg-orange-600 hover:bg-orange-500 py-3 rounded text-white font-bold active:scale-95 transition">Generate Schedule</button>
        </div>
        <div id="tlResultArea" class="hidden glass-panel p-4 md:p-6 rounded-xl">
            <div id="tlOutput" class="whitespace-pre-wrap text-sm text-slate-200 font-mono"></div>
            <div class="mt-4 flex gap-2">
                <button onclick="window.downloadFile('Schedule.txt', 'tlOutput')" class="text-sm text-blue-400 border border-blue-900 p-2 rounded">‚¨áÔ∏è Download</button>
                <button onclick="window.downloadMarkdownFile('Schedule.md', 'tlOutput')" class="text-sm text-indigo-300 border border-indigo-900 p-2 rounded">üìù Markdown</button>
                <button onclick="window.copyText('tlOutput')" class="text-sm text-slate-400 border border-slate-700 p-2 rounded">üìã Copy</button>
            </div>
        </div>
    </div>
  </template>

  <template id="tpl-recent">
    <div class="animate-fade-in space-y-6">
        <div class="flex justify-between items-center">
            <h2 class="text-xl md:text-2xl font-bold text-white flex items-center gap-2"><i class="ph ph-clock-counter-clockwise text-green-400"></i> Cloud History</h2>
            <button onclick="window.clearHistory()" class="text-red-400 text-xs border border-red-900/50 px-3 py-1.5 rounded">Clear All</button>
        </div>
        <p class="text-sm text-slate-500 mb-2">Saved securely on Firebase.</p>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
            <input id="historySearch" type="text" placeholder="Search topic/content..." class="md:col-span-2 bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-sm text-white" />
            <select id="historyTypeFilter" class="bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-sm text-white">
                <option value="all">All Types</option>
                <option value="fbpost">FB Post</option>
                <option value="dm_best">DM Sales</option>
                <option value="dm_auto_detect">Auto DM</option>
                <option value="timeline">Timeline</option>
                <option value="tt_script">TikTok Script</option>
                <option value="tt_caption">TikTok Caption</option>
                <option value="tt_post_full">TikTok Full Post</option>
                <option value="creative_post">Creative Post</option>
                <option value="creative_director">Creative Plan</option>
                <option value="creative_studio">Creative Studio</option>
                <option value="studio_ideas">Studio Ideas</option>
                <option value="studio_hooks">Studio Hooks</option>
                <option value="studio_cta">Studio CTA</option>
                <option value="studio_hashtags">Studio Hashtags</option>
                <option value="studio_pack_fb">Studio FB Pack</option>
                <option value="studio_pack_tiktok">Studio TikTok Pack</option>
                <option value="studio_pack_dm">Studio DM Pack</option>
                <option value="lite_final_facebook">Lite Final (FB)</option>
                <option value="lite_final_tiktok">Lite Final (TikTok)</option>
                <option value="lite_final_both">Lite Final (Both)</option>
                <option value="lite_variants_facebook">Lite Variants (FB)</option>
                <option value="mentor">Mentor</option>
                <option value="pose">Pose</option>
                <option value="ai_chat">AI Chat</option>
            </select>
            <select id="historySort" class="bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-sm text-white">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="az">Topic A-Z</option>
            </select>
        </div>
        <div id="historyListContainer" class="space-y-4 pb-20"></div>
    </div>
  </template>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, onSnapshot, deleteDoc, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    

    const firebaseConfig = {
      apiKey: "AIzaSyBEqE5lWdLWIZOO_M3RYY35e17VMTGk-G0",
      authDomain: "saiai-content-generator.firebaseapp.com",
      projectId: "saiai-content-generator",
      storageBucket: "saiai-content-generator.firebasestorage.app",
      messagingSenderId: "574947512372",
      appId: "1:574947512372:web:1d35a5b5aa6f24ea493a61",
      measurementId: "G-C2Q8Y2XBMD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    let userId = null;
    let currentAnalysis = null;
    let chatHistory = [];

    const getValue = (id) => { const el = document.getElementById(id); return el ? el.value : ""; };

    let unsubscribeUsage = null;
    let unsubscribeHistory = null;
    let historyItemsCache = [];

    const escapeHtml = (str = "") => String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');


    const API_TIMEOUT_MS = 35000;
    const API_RETRY_COUNT = 1;
    const DEFAULT_DEV_API_BASE = 'http://localhost:3000';

    const getGenerateEndpoint = () => {
        const fromWindow = (window.__API_BASE_URL || '').toString().trim();
        const fromStorage = (localStorage.getItem('apiBaseUrl') || '').toString().trim();
        const base = fromWindow || fromStorage;

        if (base) {
            return `${base.replace(/\/$/, '')}/api/generate`;
        }

        // VS Code Live Server is static-only. Prefer local backend if available.
        if (window.location.port === '5500' || window.location.port === '5501') {
            return `${DEFAULT_DEV_API_BASE}/api/generate`;
        }

        return '/api/generate';
    };

    const getPublishEndpoint = () => {
        const fromWindow = (window.__API_BASE_URL || '').toString().trim();
        const fromStorage = (localStorage.getItem('apiBaseUrl') || '').toString().trim();
        const base = fromWindow || fromStorage;

        if (base) {
            return `${base.replace(/\/$/, '')}/api/publish`;
        }

        if (window.location.port === '5500' || window.location.port === '5501') {
            return `${DEFAULT_DEV_API_BASE}/api/publish`;
        }

        return '/api/publish';
    };


    const DRAFT_FIELDS = [
        'chatInput', 'mentorInput', 'dmInput', 'fbInput', 'ttInput', 'poseInput',
        'csTopic', 'csAudience', 'csKeywords', 'csCTA', 'csAvoid',
        'csTemplate', 'csService', 'csPersona', 'csTone', 'csLength', 'csLanguage',
        'csIncludeContact', 'csIncludeDM',
        'liteService', 'litePlatform', 'liteGoal', 'liteTone', 'liteVoice', 'liteDayPlan', 'liteTopicGuideline',
        'liteOffer', 'liteLocation', 'liteContact', 'liteAutoPublishFB', 'liteAutoPublishTT',
        'brandPackages', 'brandStyle', 'brandClient', 'brandPhone', 'brandViber', 'brandFB', 'brandTT', 'brandAddr'
    ];

    const draftKey = (id) => `draft:${id}`;

    const setupDraftAutosave = () => {
        DRAFT_FIELDS.forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;

            const stored = localStorage.getItem(draftKey(id));
            if (stored !== null) {
                if (el.type === 'checkbox') {
                    el.checked = stored === '1';
                } else if (el.value !== stored) {
                    el.value = stored;
                }
            }

            if (el.dataset.draftBound === '1') return;
            el.dataset.draftBound = '1';
            const persist = () => {
                if (el.type === 'checkbox') {
                    localStorage.setItem(draftKey(id), el.checked ? '1' : '0');
                } else {
                    localStorage.setItem(draftKey(id), el.value || '');
                }
            };
            el.addEventListener('input', persist);
            el.addEventListener('change', persist);
        });
    };

    const requireAuth = (message = 'Login required!') => {
        if (userId) return true;
        window.showToast(message);
        return false;
    };

    const getApiErrorMessage = (err, fallback = 'Connection failed.') => {
        if (!err) return fallback;
        if (err.name === 'AbortError') return 'Request timed out. Try again.';
        return err.message || fallback;
    };

    const THEME_KEY = 'wy:theme';
    const applyTheme = (theme = 'studio-blue') => {
        const normalized = ['studio-blue', 'dark', 'light'].includes(theme) ? theme : 'studio-blue';
        document.body.dataset.theme = normalized;
        localStorage.setItem(THEME_KEY, normalized);
        document.querySelectorAll('[data-theme-btn]').forEach((btn) => {
            btn.classList.toggle('active', btn.dataset.themeBtn === normalized);
        });
    };
    window.setTheme = (theme) => applyTheme(theme);

    const normalizeIdeaTopic = (value = '') => {
        const t = String(value || '').trim();
        if (!t) return '';
        if (/^anything$/i.test(t) || /^auto mix$/i.test(t)) return '';
        return t;
    };

    let currentTemplateGuide = '';
    let latestResearchBrief = '';
    let latestStrategyBrief = '';
    let latestIdeaItems = [];
    let latestLiteTopics = [];
    const TEMPLATE_PRESETS = {
        default: {
            tone: 'emotional',
            persona: 'sales_closer',
            cta: 'Inbox for booking',
            focus: 'Auto Mix',
            fb: true,
            tt: true,
            guide: 'General conversion mode: emotion + clear CTA.'
        },
        client_showcase: {
            tone: 'premium',
            persona: 'storyteller',
            cta: 'Message us to plan your shoot',
            focus: 'Family Portrait',
            fb: true,
            tt: true,
            guide: 'Client spotlight mode: trust-building + social proof + transformation angle.'
        },
        behind_the_scenes: {
            tone: 'friendly',
            persona: 'storyteller',
            cta: 'Follow & message for full package details',
            focus: 'Studio Branding',
            fb: false,
            tt: true,
            guide: 'BTS mode: authenticity + process reveal + relatable vibe.'
        },
        promotion: {
            tone: 'premium',
            persona: 'sales_closer',
            cta: 'Limited slots: send message now',
            focus: 'Studio Branding',
            fb: true,
            tt: true,
            guide: 'Offer mode: urgency + value stack + easy booking step.'
        },
        educational: {
            tone: 'friendly',
            persona: 'storyteller',
            cta: 'Want us to create this for you? Message now',
            focus: 'Pre-Wedding',
            fb: true,
            tt: true,
            guide: 'Tip mode but conversion-first: short practical insight + direct booking CTA.'
        },
        teaser: {
            tone: 'emotional',
            persona: 'my_brand_voice',
            cta: 'Stay tuned and message to reserve early',
            focus: 'Wedding Day',
            fb: false,
            tt: true,
            guide: 'Teaser mode: curiosity hook + mystery + anticipation.'
        },
        testimonial: {
            tone: 'premium',
            persona: 'sales_closer',
            cta: 'Message us to create your story',
            focus: 'Family Portrait',
            fb: true,
            tt: true,
            guide: 'Testimonial mode: outcomes + quotes + proof-driven conversion.'
        }
    };

    window.applyTemplatePreset = function() {
        const tpl = getValue('csTemplate') || 'default';
        const preset = TEMPLATE_PRESETS[tpl] || TEMPLATE_PRESETS.default;
        const toneEl = document.getElementById('csTone');
        const personaEl = document.getElementById('csPersona');
        const ctaEl = document.getElementById('csCTA');
        const guideEl = document.getElementById('csTemplateGuide');
        const focusEl = document.getElementById('crFocus');
        const fbEl = document.getElementById('crFB');
        const ttEl = document.getElementById('crTT');
        if (toneEl) toneEl.value = preset.tone;
        if (personaEl) personaEl.value = preset.persona;
        if (ctaEl) ctaEl.value = preset.cta;
        if (focusEl) focusEl.value = preset.focus || 'Auto Mix';
        if (fbEl) fbEl.checked = preset.fb !== false;
        if (ttEl) ttEl.checked = preset.tt !== false;
        const guideText = `${preset.guide} Auto: ${preset.persona} / ${preset.tone} / ${preset.fb !== false ? 'FB' : ''}${preset.fb !== false && preset.tt !== false ? '+' : ''}${preset.tt !== false ? 'TikTok' : ''}.`;
        if (guideEl) guideEl.textContent = guideText;
        currentTemplateGuide = guideText;
    };

    const serviceLabelMap = {
        pre_wedding: 'Pre-Wedding',
        wedding_day: 'Wedding Day',
        family_portrait: 'Family Portrait',
        general: 'General',
        'pre-wedding': 'Pre-Wedding',
        'wedding-day': 'Wedding Day',
        family: 'Family Portrait',
        'solo-portrait': 'Solo Portrait',
        'studio-promo': 'Studio Promotion'
    };

    const getServiceLabel = (raw = '') => serviceLabelMap[String(raw || '').trim()] || (raw || 'General');

    const extractIdeaTitles = (text = '') => {
        const rows = String(text || '')
            .split('\n')
            .map((r) => r.trim())
            .filter(Boolean)
            .map((r) => r.replace(/^[\-\*\d\.\)\s]+/, '').replace(/^["'‚Äú‚Äù]+|["'‚Äú‚Äù]+$/g, '').trim())
            .filter((r) => r && r.length > 3);

        const out = [];
        const seen = new Set();
        for (const row of rows) {
            const key = row.toLowerCase();
            if (seen.has(key)) continue;
            seen.add(key);
            out.push(row);
            if (out.length >= 3) break;
        }
        return out;
    };

    const parseJsonArrayFromText = (text = '') => {
        const raw = String(text || '').replace(/```json|```/gi, '').trim();
        const start = raw.indexOf('[');
        const end = raw.lastIndexOf(']');
        if (start === -1 || end === -1 || end <= start) return null;
        try {
            return JSON.parse(raw.slice(start, end + 1));
        } catch (_) {
            return null;
        }
    };

    const parseJsonObjectFromText = (text = '') => {
        const raw = String(text || '').replace(/```json|```/gi, '').trim();
        const start = raw.indexOf('{');
        const end = raw.lastIndexOf('}');
        if (start === -1 || end === -1 || end <= start) return null;
        try {
            return JSON.parse(raw.slice(start, end + 1));
        } catch (_) {
            return null;
        }
    };

    const scoreCreativeIdeas = async (titles = [], meta = {}) => {
        if (!titles.length) return [];
        const numbered = titles.map((t, i) => `${i + 1}. ${t}`).join('\n');
        const prompt = `
You are a social media strategist for a photo studio.
Score each title from 1-10 on:
- engagement
- conversion
- brandFit

Service: ${meta.service || 'General'}
Platform target: ${meta.platform || 'Facebook + TikTok'}
Tone: ${meta.tone || 'emotional'}

Titles:
${numbered}

Return STRICT JSON array only:
[
  {"id":1,"engagement":8,"conversion":7,"brandFit":9,"reason":"short reason"},
  {"id":2,"engagement":...,"conversion":...,"brandFit":...,"reason":"..."},
  {"id":3,"engagement":...,"conversion":...,"brandFit":...,"reason":"..."}
]
`;
        try {
            const d = await callGenerateAPI({
                userMessage: prompt,
                mode: 'studio',
                maxOutputTokens: 700
            });
            const arr = parseJsonArrayFromText(d?.result || '');
            if (!Array.isArray(arr)) return [];
            return arr
                .map((x) => ({
                    id: Number(x?.id),
                    engagement: Math.min(10, Math.max(1, Number(x?.engagement) || 6)),
                    conversion: Math.min(10, Math.max(1, Number(x?.conversion) || 6)),
                    brandFit: Math.min(10, Math.max(1, Number(x?.brandFit) || 6)),
                    reason: String(x?.reason || '').trim()
                }))
                .filter((x) => Number.isFinite(x.id) && x.id >= 1 && x.id <= titles.length);
        } catch (_) {
            return [];
        }
    };

    const renderCreativeIdeas = (items = []) => {
        const wrap = document.getElementById('csIdeaPicker');
        const list = document.getElementById('csIdeaList');
        if (!wrap || !list) return;

        list.innerHTML = '';
        if (!items.length) {
            wrap.classList.add('hidden');
            return;
        }

        const sorted = [...items].sort((a, b) => (b.total || 0) - (a.total || 0));
        const bestTitle = sorted[0]?.title || '';

        items.forEach((item, idx) => {
            const title = item.title || '';
            const metrics = item.metrics || { engagement: 6, conversion: 6, brandFit: 6 };
            const total = item.total || ((metrics.engagement + metrics.conversion + metrics.brandFit) / 3);
            const isBest = title === bestTitle;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = `text-left bg-slate-800 hover:bg-cyan-700/30 border ${isBest ? 'border-cyan-400' : 'border-slate-700'} hover:border-cyan-400 text-slate-100 p-4 rounded-xl text-sm font-medium transition min-h-[180px]`;
            btn.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-cyan-300 text-xs font-bold">Option ${idx + 1}</span>
                    <span class="text-xs ${isBest ? 'text-emerald-300' : 'text-slate-300'}">${isBest ? 'Recommended' : `Score ${total.toFixed(1)}/10`}</span>
                </div>
                <div class="mt-2 leading-relaxed">${escapeHtml(title)}</div>
                ${item.trendAngle ? `<div class="mt-2 text-[11px] text-cyan-300 font-bold">Trend: ${escapeHtml(item.trendAngle)}</div>` : ''}
                ${item.guide ? `<div class="mt-1 text-[11px] text-slate-400 leading-relaxed">Guide: ${escapeHtml(item.guide)}</div>` : ''}
                <div class="mt-2 text-xs text-slate-400">E ${metrics.engagement}/10 ‚Ä¢ C ${metrics.conversion}/10 ‚Ä¢ B ${metrics.brandFit}/10</div>
                ${item.reason ? `<div class="mt-2 text-xs text-slate-500 leading-relaxed">${escapeHtml(item.reason)}</div>` : ''}
            `;
            btn.addEventListener('click', async () => {
                const topicEl = document.getElementById('csTopic');
                if (topicEl) {
                    topicEl.value = title;
                    topicEl.dispatchEvent(new Event('input', { bubbles: true }));
                }
                window.showToast('·Äõ·ÄΩ·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äê·Ä≤·Ä∑·ÄÅ·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·ÄÖ·Äâ·Ä∫·Äî·Ä≤·Ä∑ One-Click Campaign run ·Äî·Ä±·Äï·Ä´·Äê·Äö·Ä∫...');
                await window.generateAI('studio_campaign');
            });
            list.appendChild(btn);
        });

        wrap.classList.remove('hidden');
    };

    const setButtonBusy = (btn, busy, busyText = 'Working...') => {
        if (!btn) return;
        if (busy) {
            btn.disabled = true;
            btn.classList.add('opacity-60', 'cursor-not-allowed');
            if (!btn.dataset.originalLabel) btn.dataset.originalLabel = btn.innerHTML;
            btn.innerHTML = busyText;
            return;
        }
        btn.disabled = false;
        btn.classList.remove('opacity-60', 'cursor-not-allowed');
        if (btn.dataset.originalLabel) {
            btn.innerHTML = btn.dataset.originalLabel;
            delete btn.dataset.originalLabel;
        }
    };

    const setCreativeOutput = (text = '') => {
        const out = document.getElementById('crOutput');
        const area = document.getElementById('crResultArea');
        if (out) out.innerText = String(text || '').trim();
        if (area) area.classList.remove('hidden');
    };

    const callGenerateAPI = async (payload, opts = {}) => {
        const retries = opts.retries ?? API_RETRY_COUNT;
        const timeoutMs = opts.timeoutMs ?? API_TIMEOUT_MS;

        for (let attempt = 0; attempt <= retries; attempt += 1) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const endpoint = getGenerateEndpoint();
                const normalizedPayload = payload?.prompt
                    ? payload
                    : { ...payload, prompt: payload?.userMessage || '' };

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(normalizedPayload),
                    signal: controller.signal
                });

                if (!res.ok) {
                    let details = '';
                    try {
                        const errData = await res.json();
                        if (errData?.error) details = ": " + errData.error;
                    } catch (_) {}

                    if (res.status === 404 || res.status === 405) {
                        throw new Error(`API route unavailable (${res.status}). Start backend (e.g. vercel dev) or set localStorage apiBaseUrl. Endpoint: ${endpoint}`);
                    }
                    throw new Error(`Server Error ${res.status}${details}`);
                }

                const data = await res.json();
                if (data?.error) {
                    throw new Error(data.error);
                }
                return data;
            } catch (err) {
                const isLast = attempt === retries;
                if (isLast) throw err;
                await new Promise((r) => setTimeout(r, 450 * (attempt + 1)));
            } finally {
                clearTimeout(timer);
            }
        }

        throw new Error('Unknown request failure');
    };

    const AI_UI_CONFIG = {
        outputIds: {
            fbpost: 'fbOutput', dm_best: 'dmOutput', timeline: 'tlOutput', tt_caption: 'ttOutput',
            tt_script: 'ttOutput', tt_post_full: 'ttOutput', pose: 'poseOutput', creative_director: 'crOutput',
            creative_post: 'crOutput', creative_tt_text: 'crOutput', creative_brand_idea: 'crOutput', dm_auto_detect: 'dmOutput',
            creative_studio: 'crOutput', studio_ideas: 'crOutput', studio_hooks: 'crOutput',
            studio_cta: 'crOutput', studio_hashtags: 'crOutput',
            studio_pack_fb: 'crOutput', studio_pack_tiktok: 'crOutput', studio_pack_dm: 'crOutput',
            studio_campaign: 'crOutput', studio_campaign_fb: 'crOutput', studio_campaign_tiktok: 'crOutput', studio_hook_pro: 'crOutput',
            manager_daily: 'mgrOutput', mentor: 'mentorOutput'
        },
        areaIds: {
            fbpost: 'fbResultArea', dm_best: 'dmResultArea', timeline: 'tlResultArea', tt_caption: 'ttResultArea',
            tt_script: 'ttResultArea', tt_post_full: 'ttResultArea', pose: 'poseResultArea',
            creative_director: 'crResultArea', creative_post: 'crResultArea', creative_tt_text: 'crResultArea', creative_brand_idea: 'crResultArea',
            creative_studio: 'crResultArea', studio_ideas: 'crResultArea', studio_hooks: 'crResultArea',
            studio_cta: 'crResultArea', studio_hashtags: 'crResultArea',
            studio_pack_fb: 'crResultArea', studio_pack_tiktok: 'crResultArea', studio_pack_dm: 'crResultArea',
            studio_campaign: 'crResultArea', studio_campaign_fb: 'crResultArea', studio_campaign_tiktok: 'crResultArea', studio_hook_pro: 'crResultArea',
            dm_auto_detect: 'dmResultArea', manager_daily: 'mgrResultArea', mentor: 'mentorResultArea'
        },
        continueBtnIds: {
            fbpost: 'fbContinueBtn', dm_best: 'dmContinueBtn', timeline: 'tlContinueBtn', tt_caption: 'ttContinueBtn',
            tt_script: 'ttContinueBtn', tt_post_full: 'ttContinueBtn', manager_daily: 'mgrContinueBtn',
            creative_director: 'crContinueBtn', creative_post: 'crContinueBtn', creative_tt_text: 'crContinueBtn', creative_brand_idea: 'crContinueBtn',
            creative_studio: 'crContinueBtn',
            studio_pack_fb: 'crContinueBtn', studio_pack_tiktok: 'crContinueBtn', studio_pack_dm: 'crContinueBtn',
            studio_campaign: 'crContinueBtn', studio_campaign_fb: 'crContinueBtn', studio_campaign_tiktok: 'crContinueBtn', studio_hook_pro: 'crContinueBtn',
            studio_ideas: 'crContinueBtn', studio_hooks: 'crContinueBtn', studio_cta: 'crContinueBtn', studio_hashtags: 'crContinueBtn',
            dm_auto_detect: 'dmContinueBtn', mentor: 'mentorContinueBtn'
        },
        actionButtonSelectors: {
            creative_director: 'button[onclick="window.generateAI(\'creative_director\')"]',
            creative_post: 'button[onclick="window.generateAI(\'creative_post\')"]',
            studio_campaign: 'button[onclick="window.generateAI(\'studio_campaign\')"]',
            studio_campaign_fb: 'button[onclick="window.generateAI(\'studio_campaign_fb\')"]',
            studio_campaign_tiktok: 'button[onclick="window.generateAI(\'studio_campaign_tiktok\')"]',
            studio_hook_pro: 'button[onclick="window.generateAI(\'studio_hook_pro\')"]',
            creative_tt_text: 'button[onclick="window.generateAI(\'creative_tt_text\')"]',
            creative_brand_idea: 'button[onclick="window.generateAI(\'creative_brand_idea\')"]',
            dm_analyze: 'button[onclick="window.generateAI(\'dm_analyze\')"]',
            dm_best: 'button[onclick="window.generateAI(\'dm_best\')"]',
            dm_auto_detect: 'button[onclick="window.generateAI(\'dm_auto_detect\')"]',
            fbpost: 'button[onclick="window.generateAI(\'fbpost\')"]',
            timeline: 'button[onclick="window.generateAI(\'timeline\')"]',
            tt_script: 'button[onclick="window.generateAI(\'tt_script\')"]',
            tt_caption: 'button[onclick="window.generateAI(\'tt_caption\')"]',
            tt_post_full: 'button[onclick="window.generateAI(\'tt_post_full\')"]',
            creative_studio: 'button[onclick="window.generateAI(\'creative_studio\')"]',
            studio_ideas: 'button[onclick="window.generateAI(\'studio_ideas\')"]',
            studio_hooks: 'button[onclick="window.generateAI(\'studio_hooks\')"]',
            studio_cta: 'button[onclick="window.generateAI(\'studio_cta\')"]',
            studio_hashtags: 'button[onclick="window.generateAI(\'studio_hashtags\')"]',
            studio_pack_fb: 'button[onclick="window.generateAI(\'studio_pack_fb\')"]',
            studio_pack_tiktok: 'button[onclick="window.generateAI(\'studio_pack_tiktok\')"]',
            studio_pack_dm: 'button[onclick="window.generateAI(\'studio_pack_dm\')"]',
            pose: 'button[onclick="window.generateAI(\'pose\')"]',
            mentor: 'button[onclick="window.generateAI(\'mentor\')"]'
        }
    };

    const CONTINUE_ELIGIBLE_TYPES = new Set([
        'fbpost', 'tt_script', 'tt_caption', 'tt_post_full',
        'creative_director', 'creative_post', 'creative_tt_text', 'creative_brand_idea',
        'creative_studio', 'studio_pack_fb', 'studio_pack_tiktok', 'studio_pack_dm',
        'studio_campaign', 'studio_campaign_fb', 'studio_campaign_tiktok', 'studio_hook_pro'
    ]);
    const END_MARKER_TYPES = new Set([
        'creative_director', 'creative_post', 'creative_tt_text', 'creative_brand_idea',
        'creative_studio', 'studio_pack_fb', 'studio_pack_tiktok', 'studio_pack_dm',
        'tt_script', 'tt_post_full'
    ]);
    const hasEndMarker = (type, text = '') => {
        if (!END_MARKER_TYPES.has(type)) return null;
        return /\[END\]\s*$/i.test(String(text || '').trim());
    };

    const shouldShowContinue = (type, resultText = '') => {
        if (!CONTINUE_ELIGIBLE_TYPES.has(type)) return false;
        const text = String(resultText || '').trim();
        if (!text) return false;

        const markerState = hasEndMarker(type, text);
        if (markerState !== null) return !markerState;

        const lines = text.split('\n').map((x) => x.trim()).filter(Boolean);
        const lastLine = lines[lines.length - 1] || text;
        const endsWithEmoji = /[\u{1F300}-\u{1FAFF}]$/u.test(lastLine);
        const endsClean = /[·Åã.!?‚Ä¶]$/.test(lastLine)
            || /[\])}"'‚Äù‚Äô]$/.test(lastLine)
            || endsWithEmoji
            || /^#/.test(lastLine);

        return text.endsWith('...')
            || text.includes('[CONTINUE]')
            || (text.length > 1100 && !endsClean);
    };

    const DIRECT_CONTENT_TYPES = new Set([
        'fbpost', 'creative_post', 'creative_tt_text', 'creative_brand_idea', 'creative_studio',
        'studio_ideas', 'studio_hooks', 'studio_cta', 'studio_hashtags',
        'studio_pack_fb', 'studio_pack_tiktok', 'studio_pack_dm', 'studio_campaign', 'studio_campaign_fb', 'studio_campaign_tiktok', 'studio_hook_pro',
        'tt_script', 'tt_caption', 'tt_post_full', 'dm_best'
    ]);

    const sanitizeGeneratedOutput = (type, text = '') => {
        let out = String(text || '');
        if (!DIRECT_CONTENT_TYPES.has(type)) return out;

        const lines = out.split('\n');
        const leadNoise = /(·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´|·ÄÄ·Äº·Ä≠·ÄØ·ÄÜ·Ä≠·ÄØ·Äï·Ä´·Äê·Äö·Ä∫|creative director|senior sales strategist|i am .*creative director|i'm .*creative director)/i;

        while (lines.length) {
            const head = (lines[0] || '').trim();
            if (!head || leadNoise.test(head)) {
                lines.shift();
                continue;
            }
            break;
        }

        while (lines.length) {
            const head = (lines[0] || '').trim();
            if (!head) {
                lines.shift();
                continue;
            }
            if (/^(here('| i)?s|below is|final ready|requested content|output|·Äí·ÄÆ·Äô·Äæ·Ä¨|·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·Ä¨)/i.test(head)) {
                lines.shift();
                continue;
            }
            break;
        }

        out = lines.join('\n').trim();
        out = out.replace(/\n?\[END\]\s*$/i, '').trim();

        // Remove raw format label lines like **fb_post**
        const rows = out.split('\n').filter((r) => !/^\*\*[a-z0-9_ ]+\*\*$/i.test(r.trim()));
        out = rows.join('\n').trim();

        // Remove prompt/meta leakage lines from model output.
        const metaPatterns = [
            /^(system:|important:)/i,
            /^[-*]\s*(focus on bookings|reduce decision fatigue|one clear suggestion|never sound like marketing textbook)/i,
            /^[-*]\s*(do not|don't)\s/i,
            /(rules?:|goal per type|knowledge base|role & identity|writing rules)/i,
            /\bmarketing textbook\b/i,
            /\boutput format\b/i,
            /\bcompletion rule\b/i,
            /\(nor\).*\(shin\)/i,
            /\badapted for mentor persona\b/i,
            /\bmentor persona\b/i
        ];
        out = out
            .split('\n')
            .filter((line) => {
                const t = line.trim();
                if (!t) return true;
                if (/^[-]{3,}$/.test(t)) return false;
                if (/^·Äí·ÄÆ·Äê·ÄÖ·Ä∫·ÄÅ·Ä´.*(·ÄÜ·ÄÄ·Ä∫·Äú·ÄØ·Äï·Ä∫·Äú·Ä≠·ÄØ·Ä∑·Äõ·Äï·Ä´·Äï·Äº·ÄÆ|·Ä°·ÄÜ·ÄÑ·Ä∫·Äû·ÄÑ·Ä∑·Ä∫·Äï·Äº·ÄÑ·Ä∫·Äï·Ä±·Ä∏·Äë·Ä¨·Ä∏)/i.test(t)) return false;
                if (/^pre-wedding ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫.*content idea/i.test(t)) return false;
                if (/^·Äí·ÄÆ·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨.*(campaign pack|with you photo studio)/i.test(t)) return false;
                if (/^(here('| i)?s|below is).*(campaign pack|final result|final post)/i.test(t)) return false;
                if (/^\**\s*video concept\s*:?\**$/i.test(t)) return false;
                if (/^\**\s*main post.*mentor persona/i.test(t)) return false;
                return !metaPatterns.some((re) => re.test(t));
            })
            .join('\n')
            .trim();

        // Remove duplicated lines/paragraphs that sometimes appear in model output.
        out = removeDuplicateParagraphs(out);

        return out;
    };

    const hasMetaLeak = (text = '') => {
        const t = String(text || '');
        return /(system:|important:|writing rules|goal per type|knowledge base|marketing textbook|completion rule|focus on bookings|reduce decision fatigue)/i.test(t);
    };

    const REQUIRED_SECTION_RULES = {
        creative_brand_idea: [
            { key: 'Facebook Final Post or TikTok Final Pack', test: /(facebook final post|tiktok final pack)/i },
            { key: 'Caption', test: /(caption|·ÄÖ·Ä¨·Ää·ÄΩ·Äæ·Äî·Ä∫·Ä∏)/i },
            { key: 'Hashtags', test: /(hashtag|#)/i }
        ],
        creative_post: [
            { key: 'Hook', test: /(hook|·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫)/i },
            { key: 'Main Post', test: /(main post|aida)/i },
            { key: 'Caption', test: /(caption|·ÄÅ·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·ÄÖ·Äâ·Ä∫)/i },
            { key: 'CTA', test: /(cta|message|inbox)/i },
            { key: 'Hashtags', test: /(hashtag|#)/i }
        ],
        studio_pack_fb: [
            { key: 'Hooks', test: /(hook|hooks)/i },
            { key: 'Main Post', test: /(main post|aida)/i },
            { key: 'Caption', test: /(caption)/i },
            { key: 'CTA', test: /(cta)/i },
            { key: 'Hashtags', test: /(hashtag|#)/i }
        ],
        studio_pack_tiktok: [
            { key: 'Cover Text', test: /(cover text)/i },
            { key: 'Hooks', test: /(hook|hooks)/i },
            { key: 'Caption', test: /(caption)/i }
        ],
        creative_studio: [
            { key: 'Facebook Content', test: /(facebook|fb post|fb)/i },
            { key: 'TikTok Content', test: /(tiktok|tik tok)/i }
        ],
        studio_campaign: [
            { key: 'Facebook Final Post', test: /(facebook final post)/i },
            { key: 'TikTok Final Pack', test: /(tiktok final pack)/i },
            { key: 'TikTok Cover Text', test: /(cover text)/i },
            { key: 'TikTok Hooks', test: /(hook|hooks)/i },
            { key: 'TikTok Captions', test: /(caption|captions)/i }
        ],
        studio_campaign_fb: [
            { key: 'Facebook Final Post', test: /(facebook final post)/i },
            { key: 'Hook', test: /(hook|hooks)/i },
            { key: 'Main Post', test: /(main post|aida)/i },
            { key: 'Caption', test: /(caption)/i },
            { key: 'CTA', test: /(cta)/i },
            { key: 'Hashtags', test: /(hashtag|#)/i }
        ],
        studio_campaign_tiktok: [
            { key: 'TikTok Final Pack', test: /(tiktok final pack)/i },
            { key: 'Cover Text', test: /(cover text)/i },
            { key: 'Hooks', test: /(hook|hooks)/i },
            { key: 'Captions', test: /(caption|captions)/i }
        ],
        studio_hook_pro: [
            { key: 'Question Hooks', test: /(question hooks)/i },
            { key: 'Bold Claim Hooks', test: /(bold claim hooks)/i },
            { key: 'Story Hooks', test: /(story hooks)/i },
            { key: 'FOMO Hooks', test: /(fomo hooks)/i },
            { key: 'Offer Hooks', test: /(offer hooks)/i }
        ]
    };

    const getMissingSections = (type, text = '') => {
        if (type === 'creative_post') {
            const { onFB, onTT } = getCreativePlatformSelection();
            const hay = String(text || '');
            const fbRules = [
                { key: 'Facebook Final Post', test: /(facebook final post)/i },
                { key: 'Facebook Caption', test: /(caption|·ÄÖ·Ä¨·Ää·ÄΩ·Äæ·Äî·Ä∫·Ä∏)/i },
                { key: 'Facebook Hashtags', test: /(hashtag|#)/i }
            ];
            const ttRules = [
                { key: 'TikTok Final Pack', test: /(tiktok final pack)/i },
                { key: 'TikTok Cover Text', test: /(cover text)/i },
                { key: 'TikTok Caption', test: /(caption|·ÄÖ·Ä¨·Ää·ÄΩ·Äæ·Äî·Ä∫·Ä∏)/i },
                { key: 'TikTok Hashtags', test: /(hashtag|#)/i }
            ];
            const activeRules = onFB && onTT ? [...fbRules, ...ttRules] : (onFB ? fbRules : ttRules);
            return activeRules.filter((r) => !r.test.test(hay)).map((r) => r.key);
        }

        const rules = REQUIRED_SECTION_RULES[type];
        if (!rules || !rules.length) return [];
        const hay = String(text || '');
        return rules.filter((r) => !r.test.test(hay)).map((r) => r.key);
    };

    const removeDuplicateParagraphs = (text = '') => {
        const parts = String(text || '').split('\n').map((x) => x.trim());
        const seen = new Set();
        const out = [];
        for (const p of parts) {
            const key = p.toLowerCase();
            if (!p) {
                out.push('');
                continue;
            }
            if (seen.has(key)) continue;
            seen.add(key);
            out.push(p);
        }
        return out.join('\n').replace(/\n{3,}/g, '\n\n').trim();
    };

    // --- ‚úÖ 1. ADD THIS BLOCK HERE (Before Auth Listener) ---
    
    // Usage Tracking Functions (Hoisted)
    window.loadUsage = function() {
        if (!userId) return;
        if (unsubscribeUsage) unsubscribeUsage();
        // Listen to changes in real-time
        unsubscribeUsage = onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'usage', 'stats'), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                const cost = data.totalCost || 0;
                const reqs = data.totalRequests || 0;
                const limit = 5.00; // $5.00 Limit
                
                let percent = (cost / limit) * 100;
                if(percent > 100) percent = 100;

                // Update UI Elements
                const costEl = document.getElementById('usageCost');
                if(costEl) costEl.innerText = `$${cost.toFixed(4)}`;
                
                const reqEl = document.getElementById('usageRequests');
                if(reqEl) reqEl.innerText = `${reqs} reqs`;
                
                const perEl = document.getElementById('usagePercent');
                if(perEl) perEl.innerText = `${percent.toFixed(1)}%`;
                
                const bar = document.getElementById('usageBar');
                if(bar) {
                    bar.style.width = `${percent}%`;
                    bar.className = `h-full transition-all duration-500 shadow-[0_0_10px_rgba(0,0,0,0.3)] ${percent > 80 ? 'bg-red-500 shadow-red-500/50' : percent > 50 ? 'bg-yellow-400 shadow-yellow-400/50' : 'bg-gradient-to-r from-green-500 to-emerald-400 shadow-green-500/50'}`;
                }
            } else {
                // Initialize if not exists
                document.getElementById('usageCost').innerText = "$0.0000";
            }
        });
    };

    window.trackUsage = async function(inputText, outputText) {
        if (!userId) return;
        const charCount = (inputText?.length || 0) + (outputText?.length || 0);
        const estCost = charCount * 0.000002; 
        try {
            const usageRef = doc(db, 'artifacts', appId, 'users', userId, 'usage', 'stats');
            await setDoc(usageRef, {
                totalCost: increment(estCost),
                totalRequests: increment(1),
                lastUpdated: Date.now()
            }, { merge: true });
        } catch(e) { console.error("Tracking Error:", e); }
    };
    
    // --- AUTH ---
    window.handleLogin = async function() {
        const email = getValue('loginEmail');
        const pass = getValue('loginPass');
        if(!email || !pass) return;
        try { await signInWithEmailAndPassword(auth, email, pass); } catch(error) { document.getElementById('loginError').innerText = error.message; document.getElementById('loginError').classList.remove('hidden'); }
    }
    window.handleLogout = async function() { try { await signOut(auth); window.location.reload(); } catch(e) { console.error(e); } }

    onAuthStateChanged(auth, (user) => {
        const overlay = document.getElementById('loginOverlay');
        if (user) {
            userId = user.uid;
            document.getElementById('connectionStatus').classList.replace('bg-red-500', 'bg-green-500');
            document.getElementById('userEmailDisplay').innerText = user.email;
            overlay.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => overlay.classList.add('hidden'), 300);
            if(window.currentView === 'brand') loadBrandData();
            if(window.currentView === 'recent') renderHistoryList();
            window.loadUsage();
        } else {
            userId = null;
            if (unsubscribeUsage) { unsubscribeUsage(); unsubscribeUsage = null; }
            if (unsubscribeHistory) { unsubscribeHistory(); unsubscribeHistory = null; }
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0', 'pointer-events-none'), 50);
        }
    });
// --- ASSISTANT SHORT ACTIONS (FIX MISSING FUNCTION) ---
window.runAssistant = async function(type) {
  let prompt = "";

  if (type === "fb_ideas") {
    prompt = "With You Photo Studio ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ Facebook post idea ·ÅÖ ·ÄÅ·ÄØ·Äú·Ä±·Ä¨·ÄÄ·Ä∫ ·Äï·Ä±·Ä∏·Äï·Ä´·Åã Pre-wedding focus ·Äî·Ä≤·Ä∑ ·Äû·Äò·Ä¨·Äù·ÄÜ·Äî·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äõ·Ä±·Ä∏·Äï·Ä´·Åã";
  }

  if (type === "fb_hooks") {
    prompt = "Pre-wedding couple ·Äê·ÄΩ·Ä±·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ Facebook hook ·ÄÖ·Ä¨·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äê·Ä≠·ÄØ ·ÅÖ ·ÄÅ·ÄØ·Äõ·Ä±·Ä∏·Äï·Ä´·Åã ·Äú·Ä∞·Äï·Äº·Ä±·Ä¨·Äû·Äú·Ä≠·ÄØ ·Äû·Äò·Ä¨·Äù tone ·Äî·Ä≤·Ä∑·Äõ·Ä±·Ä∏·Äï·Ä´·Åã";
  }

  if (!prompt) return;

  const triggerBtn = document.querySelector(`button[onclick="window.runAssistant('${type}')"]`);
  setButtonBusy(triggerBtn, true, 'Generating...');

  try {
    const data = await callGenerateAPI({
      userMessage: prompt,
      mode: "studio"
    });

    const out = document.getElementById("fbOutput");
    const area = document.getElementById("fbResultArea");
    if (out && area) {
      out.innerText = data.result;
      area.classList.remove("hidden");
    }
  } catch (e) {
    console.error(e);
    window.showToast(getApiErrorMessage(e, 'Assistant error'));
  } finally {
    setButtonBusy(triggerBtn, false);
  }
};

    const getLiteInputs = () => {
        const platform = getValue('litePlatform') || 'both';
        const serviceRaw = getValue('liteService') || 'pre_wedding';
        const topicGuideline = (getValue('liteTopicGuideline') || '').trim();
        const voice = (getValue('liteVoice') || '').trim() || 'premium';
        const inputs = {
            serviceRaw,
            service: getServiceLabel(serviceRaw),
            platform,
            goal: getValue('liteGoal') || 'booking',
            tone: getValue('liteTone') || 'premium',
            voice,
            topicGuideline: topicGuideline || `${getServiceLabel(serviceRaw)} ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ booking ·Äê·ÄÄ·Ä∫·ÄÖ·Ä±·Äô·Äö·Ä∑·Ä∫ post`,
            offer: (getValue('liteOffer') || '').trim(),
            location: (getValue('liteLocation') || '').trim() || 'Taunggyi',
            contact: (getValue('liteContact') || '').trim() || '09255521464 (Viber)'
        };

        const csServiceEl = document.getElementById('csService');
        const csToneEl = document.getElementById('csTone');
        const csTopicEl = document.getElementById('csTopic');
        const fbEl = document.getElementById('crFB');
        const ttEl = document.getElementById('crTT');
        if (csServiceEl) csServiceEl.value = serviceRaw;
        if (csToneEl) csToneEl.value = inputs.tone;
        if (csTopicEl) csTopicEl.value = inputs.topicGuideline;
        if (fbEl) fbEl.checked = platform === 'both' || platform === 'facebook';
        if (ttEl) ttEl.checked = platform === 'both' || platform === 'tiktok';

        return inputs;
    };

    const WITH_YOU_COPY_READY_CONTRACT = {
        bannedPatterns: [
            /·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´/i,
            /·Äí·ÄÆ·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨/i,
            /·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·Ä¨/i,
            /here is/i,
            /tutorial/i,
            /mentor/i,
            /analysis/i
        ],
        tiktokLinePattern: /^(cover|hook|caption)\s*:/i
    };

    const cleanFinalText = (text = '') => String(text || '')
        .replace(/```json|```/gi, '')
        .replace(/^\s*(facebook final post|tiktok final pack)\s*:?\s*$/gim, '')
        .replace(/^\s*\d+\)\s*/gm, '')
        .replace(/^\s*[\-\*]\s+/gm, '')
        .trim();

    const normalizeLiteFacebookFinal = (text = '', contact = '') => {
        const src = cleanFinalText(text);
        if (!src) return '';

        // Keep captions human: remove address/phone lines from body, add contact as final line only.
        const contactRaw = String(contact || '').trim();
        const phoneLike = /(\+?95)?\s*0?9\d{7,}/;
        const contactLike = /(viber|ph|phone|call|092|09\d{7,})/i;
        const addressLike = /(·Äê·Ä±·Ä¨·ÄÑ·Ä∫·ÄÄ·Äº·ÄÆ·Ä∏|taunggyi|·Äú·Äô·Ä∫·Ä∏|·Äú·Äô·Ä∫·Ä∏·Äû·ÄΩ·Äö·Ä∫|·Ä°·Äô·Äæ·Äê·Ä∫|LA\/|·Äò·ÄØ·Äõ·ÄÑ·Ä∑·Ä∫·Äî·Ä±·Ä¨·ÄÑ·Ä∫|address)/i;

        let lines = src.split('\n').map((x) => x.trim()).filter(Boolean);
        lines = lines.filter((line) => {
            if (phoneLike.test(line)) return false;
            if (contactLike.test(line) && line.length < 80) return false;
            if (addressLike.test(line) && /[0-9]/.test(line)) return false;
            return true;
        });

        let out = lines.join('\n').trim();

        // Enforce single question mark.
        const firstQ = out.indexOf('?');
        if (firstQ !== -1) {
            out = out.slice(0, firstQ + 1) + out.slice(firstQ + 1).replaceAll('?', '·Åã');
        }

        // Enforce a single, clear CTA.
        if (!/DM\s*'BOOK'/i.test(out)) {
            out = (out ? (out + "\n\n") : "") + "DM 'BOOK' ·Äú·Ä≠·ÄØ·Ä∑·Äï·Ä≠·ÄØ·Ä∑·Äï·Äº·ÄÆ·Ä∏ date/time/style ·Äï·Äº·Ä±·Ä¨·Äï·Ä±·Ä∏·Äï·Ä´·Åã";
        }

        if (contactRaw) {
            out = (out ? (out + "\n") : "") + `·ÄÜ·ÄÄ·Ä∫·Äû·ÄΩ·Äö·Ä∫·Äõ·Äî·Ä∫: ${contactRaw}`;
        }

        return out.trim();
    };

    const normalizeTikTokFinal = (text = '') => {
        const src = cleanFinalText(text);
        if (!src) return '';
        const lines = src.split('\n').map((x) => x.trim()).filter(Boolean);
        let cover = '';
        let hook = '';
        let caption = '';
        lines.forEach((line) => {
            if (!cover && /^cover\s*:?\s*/i.test(line)) cover = line.replace(/^cover\s*:?\s*/i, '').trim();
            else if (!hook && /^hook\s*:?\s*/i.test(line)) hook = line.replace(/^hook\s*:?\s*/i, '').trim();
            else if (!caption && /^caption\s*:?\s*/i.test(line)) caption = line.replace(/^caption\s*:?\s*/i, '').trim();
        });
        if (!cover) cover = lines[0] || '';
        if (!hook) hook = lines[1] || '';
        if (!caption) caption = lines.slice(2).join(' ').trim() || lines[lines.length - 1] || '';
        return [cover, hook, caption].filter(Boolean).join('\n').trim();
    };

    const hasBannedMeta = (text = '') => WITH_YOU_COPY_READY_CONTRACT.bannedPatterns.some((rx) => rx.test(String(text || '')));

    const isValidFacebookFinal = (text = '') => {
        const t = cleanFinalText(text);
        if (!t) return false;
        if (hasBannedMeta(t)) return false;
        const hasHashtag = /#/.test(t);
        const hasCTA = /(message|inbox|booking|book|·ÄÜ·ÄÄ·Ä∫·Äû·ÄΩ·Äö·Ä∫|viber|call)/i.test(t);
        return hasHashtag && hasCTA && t.length >= 60;
    };

    const isValidTikTokFinal = (text = '') => {
        const t = normalizeTikTokFinal(text);
        if (!t) return false;
        if (hasBannedMeta(t)) return false;
        const lines = t.split('\n').map((x) => x.trim()).filter(Boolean);
        if (lines.length !== 3) return false;
        if (lines.some((line) => WITH_YOU_COPY_READY_CONTRACT.tiktokLinePattern.test(line))) return false;
        const hasConversionCue = /(message|inbox|booking|book|·ÄÜ·ÄÄ·Ä∫·Äû·ÄΩ·Äö·Ä∫|viber|slot|·Ä°·ÄÅ·ÄØ·Äï·Ä≤|reserve)/i.test(t);
        return hasConversionCue;
    };

    const renderLiteIdeas = (titles = []) => {
        const wrap = document.getElementById('liteIdeaWrap');
        const list = document.getElementById('liteIdeaList');
        if (!wrap || !list) return;
        list.innerHTML = '';
        latestLiteTopics = titles.slice(0, 3);

        if (!titles.length) {
            wrap.classList.add('hidden');
            return;
        }

        titles.slice(0, 3).forEach((title, index) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'text-left bg-slate-800 hover:bg-cyan-700/25 border border-slate-700 hover:border-cyan-400 p-3 rounded-lg transition min-h-[112px]';
            btn.innerHTML = `
                <div class="text-[11px] text-cyan-300 font-bold uppercase">Option ${index + 1}</div>
                <div class="mt-1 text-sm text-slate-100 leading-relaxed">${escapeHtml(title)}</div>
            `;
            btn.addEventListener('click', () => {
                const guideEl = document.getElementById('liteTopicGuideline');
                if (guideEl) guideEl.value = title;
                window.showToast('Topic ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ·Åã Generate Final ·ÄÄ·Ä≠·ÄØ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´·Åã');
            });
            list.appendChild(btn);
        });

        wrap.classList.remove('hidden');
    };

    const renderLiteFinalResult = (payload = {}, platform = 'both') => {
        const resultArea = document.getElementById('liteResultArea');
        const fbBlock = document.getElementById('liteFBBlock');
        const ttBlock = document.getElementById('liteTTBlock');
        const fbOutput = document.getElementById('liteFBOutput');
        const ttOutput = document.getElementById('liteTTOutput');
        if (!resultArea || !fbBlock || !ttBlock || !fbOutput || !ttOutput) return;

        const wantsFB = platform === 'both' || platform === 'facebook';
        const wantsTT = platform === 'both' || platform === 'tiktok';
        const fbText = cleanFinalText(payload.facebook || '');
        const ttText = normalizeTikTokFinal(payload.tiktok || '');

        fbBlock.classList.toggle('hidden', !wantsFB);
        ttBlock.classList.toggle('hidden', !wantsTT);
        fbOutput.innerText = wantsFB ? fbText : '';
        ttOutput.innerText = wantsTT ? ttText : '';

        const combined = [
            wantsFB && fbText ? `Facebook Final\n${fbText}` : '',
            wantsTT && ttText ? `TikTok Final\n${ttText}` : ''
        ].filter(Boolean).join('\n\n');

        const legacyOut = document.getElementById('crOutput');
        if (legacyOut) legacyOut.innerText = combined;
        resultArea.classList.remove('hidden');
    };

    const buildLiteFinalPrompt = (inputs, stronger = false) => {
        const wantsFB = inputs.platform === 'both' || inputs.platform === 'facebook';
        const wantsTT = inputs.platform === 'both' || inputs.platform === 'tiktok';
        const schema = wantsFB && wantsTT
            ? `{"facebook":"...", "tiktok":"..."}`
            : (wantsFB ? `{"facebook":"..."}` : `{"tiktok":"..."}`);
        const strongerRule = stronger
            ? '- Make hook and CTA more aggressive for conversion while staying natural Burmese.\n'
            : '';
        const voiceRule = inputs.voice === 'friendly'
            ? '- Voice: Friendly local Burmese, conversational, warm. Avoid overly poetic lines.\n'
            : '- Voice: Premium cinematic Burmese, clean and confident. Avoid salesy phrases.\n';
        return `
You are senior social copywriter for With You Photo Studio (Taunggyi).
Goal: Return FINAL ready-to-post content only.

Inputs:
- Service: ${inputs.service}
- Platform target: ${inputs.platform}
- Goal: ${inputs.goal}
- Tone: ${inputs.tone}
- Page voice: ${inputs.voice}
- Topic/Guideline: ${inputs.topicGuideline}
- Offer (optional): ${inputs.offer || 'none'}
- Location: ${inputs.location}
- Contact: ${inputs.contact}

Return STRICT JSON only:
${schema}

Rules:
- Burmese language only.
- No greeting, no intro, no explanation, no numbering.
- No mentor/analysis/tutorial text.
- Return only copy-ready final content.
${voiceRule}- Short lines (use line breaks) and natural human Burmese.
- Ask exactly ONE question in the whole Facebook post.
- Include exactly ONE soft CTA to DM (prefer: DM 'BOOK').
- Do NOT include address/phone in the body; put contact as FINAL line only.
- No emojis unless user explicitly asks.
- Hashtags: 3 to 6 only (no spam).
${strongerRule}${wantsFB ? `
- facebook value: one final post ready to publish.
- Include: opening hook + body + CTA + hashtags in one block.
- Body should be concise, conversion-focused, natural.
` : ''}${wantsTT ? `
- tiktok value: exactly 3 plain lines only (NO labels):
  1) short opening line
  2) strong hook line
  3) caption line with clear booking CTA
- Do NOT write "Cover:", "Hook:", "Caption:".
- No extra lines, no section heading.
` : ''}
`;
    };

    const buildLiteVariantsPrompt = (inputs) => {
        return `
You are a Myanmar Facebook copywriter for With You Photo Studio (Taunggyi).

Task:
Create 3 different Facebook caption variants for the same topic.

Inputs:
- Service: ${inputs.service}
- Goal: ${inputs.goal}
- Tone: ${inputs.tone}
- Page voice: ${inputs.voice}
- Topic/Guideline: ${inputs.topicGuideline}
- Offer (optional): ${inputs.offer || 'none'}
- Location: ${inputs.location}

Return STRICT JSON only:
{"variants":["...","...","..."]}

Rules:
- Burmese only
- Natural human short lines
- Each variant must ask exactly ONE question (only one "?" total)
- Each variant must include exactly ONE CTA: DM 'BOOK'
- No address/phone in the body (contact will be added separately)
- No emojis unless asked
- Hashtags: 3 to 6 only
- Make each variant meaningfully different (hook angle + body angle + CTA phrasing)
`;
    };

    const buildLiteRewritePrompt = (inputs, payload, stronger = false) => {
        const wantsFB = inputs.platform === 'both' || inputs.platform === 'facebook';
        const wantsTT = inputs.platform === 'both' || inputs.platform === 'tiktok';
        const schema = wantsFB && wantsTT
            ? `{"facebook":"...", "tiktok":"..."}`
            : (wantsFB ? `{"facebook":"..."}` : `{"tiktok":"..."}`);
        return `
Rewrite this draft into strict With You Studio copy-ready format.

Input draft JSON:
${JSON.stringify(payload || {}, null, 2)}

Return STRICT JSON only:
${schema}

Rules:
- Burmese only
- No intro/meta/tutorial text
- Remove any mentoring/explanation sentences
- Keep persuasive and booking-focused
 - Ask exactly ONE question in the Facebook post
 - Exactly ONE CTA (prefer: DM 'BOOK')
 - Do NOT include address/phone in the body; put contact as FINAL line only
${stronger ? '- Make wording more conversion-aggressive but natural.\n' : ''}${wantsFB ? `
- facebook must include hook + body + CTA + hashtags in one final block
` : ''}${wantsTT ? `
- tiktok must be exactly 3 plain lines
- line 3 must include booking CTA cue
- Do NOT write "Cover:", "Hook:", "Caption:"
` : ''}
`;
    };

    const renderLiteFacebookVariants = (variants = [], inputs) => {
        const resultArea = document.getElementById('liteResultArea');
        const fbBlock = document.getElementById('liteFBBlock');
        const ttBlock = document.getElementById('liteTTBlock');
        const fbOutput = document.getElementById('liteFBOutput');
        const ttOutput = document.getElementById('liteTTOutput');
        if (!resultArea || !fbBlock || !ttBlock || !fbOutput || !ttOutput) return;

        ttBlock.classList.add('hidden');
        ttOutput.innerText = '';
        fbBlock.classList.remove('hidden');

        const cleaned = (variants || [])
            .map((v) => normalizeLiteFacebookFinal(String(v || ''), inputs?.contact || ''))
            .filter(Boolean)
            .slice(0, 3);

        if (!cleaned.length) {
            fbOutput.innerText = 'No variants returned. Try again with a simpler guideline.';
            resultArea.classList.remove('hidden');
            return;
        }

        fbOutput.innerText = cleaned
            .map((v, i) => `Option ${i + 1}\n${v}`)
            .join('\n\n---\n\n')
            .trim();

        resultArea.classList.remove('hidden');
    };

    const buildLiteFallbackPrompt = (inputs, channel = 'facebook') => {
        if (channel === 'tiktok') {
            return `
Write TikTok final output only for With You Photo Studio.
Service: ${inputs.service}
Goal: ${inputs.goal}
Tone: ${inputs.tone}
Topic/Guideline: ${inputs.topicGuideline}

Output exactly 3 plain lines:
line 1 = short opening line
line 2 = strong hook line
line 3 = caption line with booking CTA

Rules:
- Burmese only
- No extra text
- No heading
- Do NOT write "Cover:", "Hook:", "Caption:"
`;
        }
        return `
Write one Facebook final post only for With You Photo Studio.
Service: ${inputs.service}
Goal: ${inputs.goal}
Tone: ${inputs.tone}
Topic/Guideline: ${inputs.topicGuideline}

Rules:
- Burmese only
- Final ready-to-post text only
- Include hook + body + CTA + hashtags in one block
- No heading, no explanation
`;
    };

    window.liteSuggestTopics = async function() {
        const btn = document.getElementById('liteSuggestBtn');
        setButtonBusy(btn, true, 'Suggesting...');
        try {
            const inputs = getLiteInputs();
            const prompt = `
Create 3 strong topic ideas for a Myanmar photo studio.
Service: ${inputs.service}
Goal: ${inputs.goal}
Tone: ${inputs.tone}
Platform: ${inputs.platform}
User guideline: ${inputs.topicGuideline}

Return STRICT JSON array only:
["topic 1","topic 2","topic 3"]
`;
            const d = await callGenerateAPI({
                userMessage: prompt,
                mode: 'studio_lite',
                maxOutputTokens: 450
            });
            let titles = [];
            const parsed = parseJsonArrayFromText(d?.result || '');
            if (Array.isArray(parsed)) {
                titles = parsed.map((x) => String(x || '').trim()).filter(Boolean).slice(0, 3);
            }
            if (titles.length < 3) titles = extractIdeaTitles(d?.result || '').slice(0, 3);
            if (titles.length < 3) {
                titles = [
                    `${inputs.service} ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Äõ·ÄÑ·Ä∫·ÄÅ·ÄØ·Äî·Ä∫·Äñ·ÄΩ·Äö·Ä∫ moment ·ÄÄ·Ä≠·ÄØ premium mood ·Äî·Ä≤·Ä∑·Äñ·Äô·Ä∫·Ä∏·Äô·Äö·Ä∫`,
                    `${inputs.service} ·Äô·Äæ·Ä¨ client ·ÄÄ·Ä≠·ÄØ ·Ä°·Äõ·ÄÑ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·Äö·ÄØ·Ä∂·ÄÄ·Äº·Ää·Ä∫·ÄÖ·Ä±·Äô·Äö·Ä∑·Ä∫ visual story`,
                    `${inputs.service} booking ·Äê·ÄÄ·Ä∫·ÄÖ·Ä±·Äô·Äö·Ä∑·Ä∫ offer + emotion post idea`
                ];
            }
            const finalTitles = titles.slice(0, 3);
            renderLiteIdeas(finalTitles);
            return finalTitles;
        } catch (e) {
            console.error(e);
            window.showToast(getApiErrorMessage(e, 'Topic suggest failed'));
            return [];
        } finally {
            setButtonBusy(btn, false);
        }
    };

    const LITE_DAY_PLANS = {
        day1: {
            hint: 'Format: Carousel (5-10 photos). Goal: re-introduce + trust.',
            guideline: "Day 1 - Re-Introduce\n- Carousel (5-10 photos) best shots\n- Short story: studio vibe/style\n- CTA: DM 'BOOK'\n- Ask 1 question: A/B style preference"
        },
        day2: {
            hint: 'Format: Reel (10-25 sec). Goal: BTS + retention.',
            guideline: "Day 2 - BTS Reel\n- Reel 10-25 sec: 1 setup, 3 looks\n- Add subtitle idea in caption\n- CTA: DM 'BOOK'\n- Ask 1 question about outfit/pose"
        },
        day3: {
            hint: 'Format: Before/After carousel. Goal: proof of quality.',
            guideline: "Day 3 - Before/After\n- Before/After carousel + natural retouch policy\n- Keep it honest and specific\n- CTA: DM 'PRICE' or DM 'BOOK'\n- Ask 1 question: natural vs glam?"
        },
        day4: {
            hint: 'Format: Review/Proof post. Goal: social proof.',
            guideline: "Day 4 - Client Proof\n- Client review/quote + delivery days\n- Mention experience (on-time, direction, comfort)\n- CTA: DM 'BOOK'\n- Ask 1 question: what shoot type next?"
        },
        day5: {
            hint: 'Format: Educational checklist. Goal: saves/shares.',
            guideline: "Day 5 - Education\n- Shoot day checklist (5 items)\n- Outfit + arrive early + reference poses\n- CTA: Save this post + DM 'BOOK'\n- Ask 1 question: what worries you most?"
        },
        day6: {
            hint: 'Format: Mini offer. Goal: urgency without hard-sell.',
            guideline: "Day 6 - Mini Offer\n- Weekend mini-session details (minutes, photos, delivery)\n- Keep terms clear: deposit/slots\n- CTA: Comment 'MINI' or DM 'BOOK'\n- Ask 1 question: which day/time works?"
        },
        day7: {
            hint: 'Format: Live/Recap. Goal: community + booking push.',
            guideline: "Day 7 - Live/Recap\n- Live 10-15 min or recap reel\n- Show setup + quick Q&A prompt\n- CTA: Next week booking open, DM 'BOOK'\n- Ask 1 question: what content next week?"
        }
    };

    window.applyLiteDayPlan = function() {
        const day = (getValue('liteDayPlan') || 'day1').toString().trim();
        const plan = LITE_DAY_PLANS[day] || LITE_DAY_PLANS.day1;
        const hintEl = document.getElementById('liteDayHint');
        const guideEl = document.getElementById('liteTopicGuideline');
        const platformEl = document.getElementById('litePlatform');
        const goalEl = document.getElementById('liteGoal');

        if (hintEl) hintEl.textContent = plan.hint || '';

        // Keep user edits; only overwrite when empty.
        if (guideEl) {
            const cur = String(guideEl.value || '').trim();
            guideEl.value = cur ? (cur + "\n\n" + plan.guideline) : plan.guideline;
            guideEl.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // Default to Facebook for re-activation plan unless user already selected.
        if (platformEl && !String(platformEl.value || '').trim()) platformEl.value = 'facebook';
        if (goalEl && !String(goalEl.value || '').trim()) goalEl.value = 'booking';

        window.showToast('Day plan applied. Generate Final ·ÄÄ·Ä≠·ÄØ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´·Åã');
    };

    window.liteGenerateFinal = async function(stronger = false) {
        const btn = stronger ? document.getElementById('liteRegenerateBtn') : document.getElementById('liteGenerateBtn');
        setButtonBusy(btn, true, stronger ? 'Regenerating...' : 'Generating...');
        try {
            const inputs = getLiteInputs();
            const wantsFB = inputs.platform === 'both' || inputs.platform === 'facebook';
            const wantsTT = inputs.platform === 'both' || inputs.platform === 'tiktok';

            const draft = await callGenerateAPI({
                userMessage: buildLiteFinalPrompt(inputs, stronger),
                mode: 'studio_lite',
                maxOutputTokens: 1800
            });

            let payload = parseJsonObjectFromText(draft?.result || '') || {};
            const hasFB = !!String(payload?.facebook || '').trim();
            const hasTT = !!String(payload?.tiktok || '').trim();

            if ((wantsFB && !hasFB) || (wantsTT && !hasTT)) {
                const fixSchema = wantsFB && wantsTT
                    ? `{"facebook":"...", "tiktok":"..."}`
                    : (wantsFB ? `{"facebook":"..."}` : `{"tiktok":"..."}`);
                const fix = await callGenerateAPI({
                    userMessage: `Convert draft to STRICT JSON only.\nSchema: ${fixSchema}\nDraft:\n${draft?.result || ''}`,
                    mode: 'studio_lite',
                    maxOutputTokens: 1400
                });
                payload = parseJsonObjectFromText(fix?.result || '') || payload;
            }

            if (wantsFB && !String(payload?.facebook || '').trim()) {
                const fbFallback = await callGenerateAPI({
                    userMessage: buildLiteFallbackPrompt(inputs, 'facebook'),
                    mode: 'studio_lite',
                    maxOutputTokens: 900
                });
                payload.facebook = normalizeLiteFacebookFinal(fbFallback?.result || '', inputs.contact);
            }

            if (wantsTT && !String(payload?.tiktok || '').trim()) {
                const ttFallback = await callGenerateAPI({
                    userMessage: buildLiteFallbackPrompt(inputs, 'tiktok'),
                    mode: 'studio_lite',
                    maxOutputTokens: 500
                });
                payload.tiktok = normalizeTikTokFinal(ttFallback?.result || '');
            }

            const invalidFB = wantsFB && !isValidFacebookFinal(payload?.facebook || '');
            const invalidTT = wantsTT && !isValidTikTokFinal(payload?.tiktok || '');
            if (invalidFB || invalidTT) {
                const rewrite = await callGenerateAPI({
                    userMessage: buildLiteRewritePrompt(inputs, payload, stronger),
                    mode: 'studio_lite',
                    maxOutputTokens: 1400
                });
                const rewritePayload = parseJsonObjectFromText(rewrite?.result || '') || {};
                if (wantsFB && isValidFacebookFinal(rewritePayload?.facebook || '')) {
                    payload.facebook = normalizeLiteFacebookFinal(rewritePayload.facebook || '', inputs.contact);
                }
                if (wantsTT && isValidTikTokFinal(rewritePayload?.tiktok || '')) {
                    payload.tiktok = normalizeTikTokFinal(rewritePayload.tiktok || '');
                }
            }

            if (wantsFB && String(payload?.facebook || '').trim()) {
                payload.facebook = normalizeLiteFacebookFinal(payload.facebook || '', inputs.contact);
            }

            renderLiteFinalResult(payload, inputs.platform);
            // Save Lite output to Cloud History (manual copy/post flow still benefits from history).
            if (userId) {
                const fbText = wantsFB ? normalizeLiteFacebookFinal(payload.facebook || '', inputs.contact) : '';
                const ttText = wantsTT ? normalizeTikTokFinal(payload.tiktok || '') : '';
                const combined = [
                    fbText ? `Facebook Final\n${fbText}` : '',
                    ttText ? `TikTok Final\n${ttText}` : ''
                ].filter(Boolean).join('\n\n').trim();

                if (combined) {
                    const historyType = wantsFB && wantsTT ? 'lite_final_both' : (wantsFB ? 'lite_final_facebook' : 'lite_final_tiktok');
                    await saveToRecents(historyType, combined, inputs.topicGuideline || 'Lite Final');
                }
            }
            window.showToast('Final content ready. Copy and post.');
            return payload;
        } catch (e) {
            console.error(e);
            window.showToast(getApiErrorMessage(e, 'Generate failed'));
            return null;
        } finally {
            setButtonBusy(btn, false);
        }
    };

    window.liteGenerateVariants = async function() {
        const btn = document.getElementById('liteVariantsBtn');
        setButtonBusy(btn, true, 'Generating...');
        try {
            const inputs = getLiteInputs();
            const wantsFB = inputs.platform === 'both' || inputs.platform === 'facebook';
            if (!wantsFB) {
                window.showToast('FB Variants ·Äû·ÄØ·Ä∂·Ä∏·ÄÅ·Äª·ÄÑ·Ä∫·Äõ·ÄÑ·Ä∫ Platform ·ÄÄ·Ä≠·ÄØ Facebook (·Äû·Ä≠·ÄØ·Ä∑) Both ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´·Åã');
                return null;
            }

            const d = await callGenerateAPI({
                userMessage: buildLiteVariantsPrompt(inputs),
                mode: 'studio_lite',
                maxOutputTokens: 1200
            });

            const payload = parseJsonObjectFromText(d?.result || '') || {};
            let variants = Array.isArray(payload?.variants) ? payload.variants : [];
            variants = variants.map((x) => String(x || '').trim()).filter(Boolean);

            if (variants.length < 3) {
                // Fallback: try to convert whatever came back into strict JSON.
                const fix = await callGenerateAPI({
                    userMessage: "Return STRICT JSON only: {\"variants\":[\"...\",\"...\",\"...\"]}\n\nDraft:\n" + (d?.result || ''),
                    mode: 'studio_lite',
                    maxOutputTokens: 900
                });
                const fixed = parseJsonObjectFromText(fix?.result || '') || {};
                variants = Array.isArray(fixed?.variants) ? fixed.variants.map((x) => String(x || '').trim()).filter(Boolean) : variants;
            }

            renderLiteFacebookVariants(variants, inputs);

            if (userId) {
                const combined = (variants || [])
                    .map((v, i) => `Option ${i + 1}\n${normalizeLiteFacebookFinal(String(v || ''), inputs.contact)}`)
                    .filter(Boolean)
                    .slice(0, 3)
                    .join('\n\n---\n\n')
                    .trim();
                if (combined) await saveToRecents('lite_variants_facebook', combined, inputs.topicGuideline || 'Lite Variants');
            }

            window.showToast('3 variants ready. Choose and post.');
            return variants;
        } catch (e) {
            console.error(e);
            window.showToast(getApiErrorMessage(e, 'Variants failed'));
            return null;
        } finally {
            setButtonBusy(btn, false);
        }
    };

    const addAgentLog = (line = '') => {
        const logEl = document.getElementById('liteAgentLog');
        if (!logEl) return;
        const prev = logEl.innerText ? `${logEl.innerText}\n` : '';
        logEl.innerText = `${prev}${line}`.trim();
    };

    const clearAgentLog = () => {
        const logEl = document.getElementById('liteAgentLog');
        if (logEl) logEl.innerText = '';
    };

    const callPublishAPI = async (payload = {}) => {
        const endpoint = getPublishEndpoint();
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || `Publish error (${res.status})`);
        return data;
    };

    window.liteAutoPublish = async function() {
        const inputs = getLiteInputs();
        const fbText = cleanFinalText(document.getElementById('liteFBOutput')?.innerText || '');
        const ttText = normalizeTikTokFinal(document.getElementById('liteTTOutput')?.innerText || '');
        const doFB = document.getElementById('liteAutoPublishFB')?.checked === true;
        const doTT = document.getElementById('liteAutoPublishTT')?.checked === true;
        const wantsFB = inputs.platform === 'both' || inputs.platform === 'facebook';
        const wantsTT = inputs.platform === 'both' || inputs.platform === 'tiktok';

        if (doFB && wantsFB && fbText) {
            addAgentLog('‚Ä¢ Publishing to Facebook...');
            const fb = await callPublishAPI({
                platform: 'facebook',
                text: fbText,
                service: inputs.service,
                topic: inputs.topicGuideline
            });
            addAgentLog(`‚Ä¢ Facebook published: ${fb?.id || 'ok'}`);
        }

        if (doTT && wantsTT && ttText) {
            addAgentLog('‚Ä¢ Publishing to TikTok...');
            const tt = await callPublishAPI({
                platform: 'tiktok',
                text: ttText,
                service: inputs.service,
                topic: inputs.topicGuideline
            });
            addAgentLog(`‚Ä¢ TikTok response: ${tt?.status || 'ok'}`);
        }
    };

    window.liteRunAgent = async function() {
        const btn = document.getElementById('liteAgentBtn');
        setButtonBusy(btn, true, 'Running Agent...');
        clearAgentLog();
        try {
            addAgentLog('Agent started');
            const picks = await window.liteSuggestTopics();
            const topicEl = document.getElementById('liteTopicGuideline');
            if (topicEl && !String(topicEl.value || '').trim()) {
                const best = (Array.isArray(picks) && picks[0]) || latestLiteTopics[0] || '';
                if (best) {
                    topicEl.value = best;
                    addAgentLog(`‚Ä¢ Topic auto-selected: ${best}`);
                }
            }

            addAgentLog('‚Ä¢ Generating final content...');
            const result = await window.liteGenerateFinal(false);
            if (!result) throw new Error('Final generation failed');
            addAgentLog('‚Ä¢ Final content ready');

            const doFB = document.getElementById('liteAutoPublishFB')?.checked === true;
            const doTT = document.getElementById('liteAutoPublishTT')?.checked === true;
            if (doFB || doTT) {
                await window.liteAutoPublish();
            } else {
                addAgentLog('‚Ä¢ Auto publish disabled (content ready for copy/post)');
            }

            addAgentLog('Agent completed');
            window.showToast('Agent run complete');
        } catch (e) {
            console.error(e);
            addAgentLog(`‚Ä¢ Error: ${e?.message || e}`);
            window.showToast(getApiErrorMessage(e, 'Agent failed'));
        } finally {
            setButtonBusy(btn, false);
        }
    };

    window.liteRunChecklist = function() {
        const checks = [
            ['liteService', !!document.getElementById('liteService')],
            ['litePlatform', !!document.getElementById('litePlatform')],
            ['liteGoal', !!document.getElementById('liteGoal')],
            ['liteTone', !!document.getElementById('liteTone')],
            ['liteTopicGuideline', !!document.getElementById('liteTopicGuideline')],
            ['liteSuggestBtn', !!document.getElementById('liteSuggestBtn')],
            ['liteGenerateBtn', !!document.getElementById('liteGenerateBtn')],
            ['liteRegenerateBtn', !!document.getElementById('liteRegenerateBtn')],
            ['liteFBOutput', !!document.getElementById('liteFBOutput')],
            ['liteTTOutput', !!document.getElementById('liteTTOutput')],
            ['liteAgentBtn', !!document.getElementById('liteAgentBtn')]
        ];
        return checks.map(([name, ok]) => ({ name, ok }));
    };

    window.generateCreativeTitles = window.liteSuggestTopics;
    window.runResearchAssistant = window.liteSuggestTopics;
    window.runStrategyAssistant = window.liteSuggestTopics;
    window.runLayeredAssistants = async () => {
        await window.liteSuggestTopics();
        await window.liteGenerateFinal(false);
    };


    // --- GLOBAL EXPORTS ---
    window.currentView = 'dm'; 

    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        if (sidebar.classList.contains('sidebar-closed')) { sidebar.classList.remove('sidebar-closed'); sidebar.classList.add('sidebar-open'); overlay.classList.remove('hidden'); }
        else { sidebar.classList.add('sidebar-closed'); sidebar.classList.remove('sidebar-open'); overlay.classList.add('hidden'); }
    }

    window.loadView = function(viewId) {
        const mergedToCreative = new Set(['fbpost', 'studio', 'tiktok']);
        if (mergedToCreative.has(viewId)) viewId = 'creative';

        // Desktop Sidebar Active Logic
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navBtn = document.getElementById('nav-' + viewId);
        if(navBtn) navBtn.classList.add('active');

        // --- ‚úÖ MOBILE BOTTOM NAV UPDATE ---
        // ·Ä°·Äõ·ÄÑ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏ ·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏·ÄÄ·Ä≠·ÄØ ·Ä°·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Äñ·Äº·Ä∞·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äô·Äö·Ä∫
        document.querySelectorAll('.mobile-btm-nav').forEach(el => {
            el.classList.remove('active', 'text-blue-500');
            el.classList.add('text-slate-500');
        });
        
        // ·Äî·Äæ·Ä≠·Äï·Ä∫·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äê·Ä≤·Ä∑·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÄ·Ä≠·ÄØ Blue ·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äö·Ä∫
        const btmBtn = document.getElementById('btm-' + viewId);
        if(btmBtn) {
            btmBtn.classList.add('active', 'text-blue-500');
            btmBtn.classList.remove('text-slate-500');
        }
        
        // Creative Button (·Ä°·Äú·Äö·Ä∫·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∫) ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Äû·ÄÆ·Ä∏·Äû·Äî·Ä∑·Ä∫ Effect
        const centerBtn = document.getElementById('btm-creative');
        if(viewId === 'creative') {
            centerBtn.classList.add('ring-4', 'ring-blue-500/30');
        } else {
            centerBtn.classList.remove('ring-4', 'ring-blue-500/30');
        }
        // -----------------------------------

        if(window.innerWidth < 768) {
            document.getElementById('sidebar').classList.add('sidebar-closed');
            document.getElementById('sidebar').classList.remove('sidebar-open');
            document.getElementById('overlay').classList.add('hidden');
        }
        const container = document.getElementById('content-container');
        container.innerHTML = ''; 

        const templateId = 'tpl-' + viewId;

        const viewRenderers = {
            tiktok: () => { container.innerHTML = getTikTokHTML(); },
            pose: () => { container.innerHTML = getPoseHTML(); },
            creative: () => {
                const tpl = document.getElementById('tpl-creative');
                if (tpl) container.appendChild(tpl.content.cloneNode(true));
            },
            recent: () => {
                const tpl = document.getElementById('tpl-recent');
                if (tpl) container.appendChild(tpl.content.cloneNode(true));
                renderHistoryList();
                setupDraftAutosave();
            }
        };

        if (viewRenderers[viewId]) {
            viewRenderers[viewId]();
        } else {
            const tpl = document.getElementById(templateId);
            if (tpl) {
                container.appendChild(tpl.content.cloneNode(true));
                if (viewId === 'brand') loadBrandData();
            }
        }
        window.currentView = viewId;
        setupDraftAutosave();
        if (viewId === 'creative' && typeof window.applyTemplatePreset === 'function') {
            window.applyTemplatePreset();
        }
    }

    // --- HTML STRINGS ---
    function getTikTokHTML() {
        return `
        <div class="animate-fade-in space-y-6">
            <h2 class="text-xl md:text-2xl font-bold text-teal-400 flex items-center gap-2"><i class="ph ph-tiktok-logo"></i> TikTok Studio</h2>
            <div class="glass-panel p-6 md:p-5 rounded-xl space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="ttInput" placeholder="Video Topic (e.g. Pre-wedding tips)..." class="flex-1 bg-slate-800 border border-slate-700 rounded p-3 text-white">
                    <button onclick="window.startVoiceInput('ttInput', this)" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded px-4 text-teal-400"><i class="ph ph-microphone text-xl"></i></button>
                </div>
                <select id="ttStyle" class="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white">
                    <option>Trending & Fast</option>
                    <option>Vlog / Behind Scenes</option>
                    <option>Cinematic Mood</option>
                </select>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <button onclick="window.generateAI('tt_script')" class="bg-slate-700 hover:bg-slate-600 py-3 rounded text-white text-xs md:text-sm font-bold active:scale-95 transition">üìù Video Script</button>
                    <button onclick="window.generateAI('tt_caption')" class="bg-slate-700 hover:bg-slate-600 py-3 rounded text-white text-xs md:text-sm font-bold active:scale-95 transition">‚úçÔ∏è Captions Only</button>
                    <button onclick="window.generateAI('tt_post_full')" class="bg-teal-600 hover:bg-teal-500 py-3 rounded text-white text-xs md:text-sm font-bold active:scale-95 transition shadow-lg shadow-teal-900/50">üöÄ Full Post Pack</button>
                </div>
            </div>
            <div id="ttResultArea" class="hidden glass-panel p-4 md:p-6 rounded-xl">
                <div id="ttOutput" class="whitespace-pre-wrap text-sm text-slate-200"></div>
                <button id="ttContinueBtn" onclick="window.continueAI('tt_script')" class="hidden w-full mt-2 py-2 bg-slate-800 text-teal-400 text-xs border border-slate-600 rounded">‚ö†Ô∏è Continue Writing</button>
                <div class="text-sm text-green-400 mt-2">‚úÖ Auto-saved to Cloud</div>
            </div>
        </div>`;
    }
    function getPoseHTML() {
        return `<div class="animate-fade-in space-y-6"><h2 class="text-xl md:text-2xl font-bold text-pink-400 flex items-center gap-2"><i class="ph ph-camera"></i> Pose Helper</h2><div class="glass-panel p-6 md:p-5 rounded-xl space-y-4"><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label class="text-sm font-bold text-slate-400 uppercase">Outfit</label><select id="poseOutfit" class="w-full mt-1 bg-slate-800 border border-slate-700 rounded p-2 text-white text-sm"><option>Wedding Gown/Suit</option><option>Traditional</option><option>Casual</option></select></div><div><label class="text-sm font-bold text-slate-400 uppercase">Props</label><input type="text" id="poseProps" placeholder="Flowers..." class="w-full mt-1 bg-slate-800 border border-slate-700 rounded p-2 text-white text-sm"></div></div><div class="flex gap-2 mb-2"><button onclick="window.fillPose('Shy')" class="px-3 py-1 bg-pink-900/30 text-pink-200 text-xs rounded border border-pink-500/30">üò≥ Shy</button><button onclick="window.fillPose('Plus')" class="px-3 py-1 bg-pink-900/30 text-pink-200 text-xs rounded border border-pink-500/30">‚ù§Ô∏è Plus</button></div><div class="relative"><textarea id="poseInput" class="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white h-24 pr-10" placeholder="Situation..."></textarea><button onclick="window.startVoiceInput('poseInput', this)" class="absolute right-2 bottom-2 bg-slate-700/80 hover:bg-pink-600 p-2 rounded-full transition text-slate-300 hover:text-white"><i class="ph ph-microphone text-lg"></i></button></div><button onclick="window.generateAI('pose')" class="w-full bg-pink-600 py-3 rounded text-white font-bold active:scale-95 transition">Generate Poses</button></div><div id="poseResultArea" class="hidden glass-panel p-4 md:p-6 rounded-xl"><div id="poseOutput" class="whitespace-pre-wrap text-sm text-slate-200"></div><div class="text-sm text-green-400 mt-2">‚úÖ Auto-saved to Cloud</div></div></div>`;
    }

    // --- UPDATED SAVE FUNCTION WITH STATUS ---
    window.saveBrandData = async function() {
        if (!requireAuth()) return;
        const statusEl = document.getElementById('saveStatus');
        if(statusEl) statusEl.innerText = "Saving...";
        const ids = ['brandStyle', 'brandClient', 'brandPhone', 'brandViber', 'brandFB', 'brandTT', 'brandAddr', 'brandPackages'];
        const data = {};
        ids.forEach(id => { const el = document.getElementById(id); if(el) data[id] = el.value; });
        try { 
            await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand'), data, {merge: true}); 
            if(statusEl) { statusEl.innerText = "Cloud Saved ‚úÖ"; statusEl.classList.add('text-green-400'); }
            window.showToast("Cloud Save Success!"); 
        } catch (e) { 
            console.error(e); 
            if(statusEl) statusEl.innerText = "Error Saving"; 
        }
    }
    window.loadBrandData = async function() {
        if (!userId) return;
        try {
            const docSnap = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand'));
            if (docSnap.exists()) { const data = docSnap.data(); for (const [key, value] of Object.entries(data)) { const el = document.getElementById(key); if(el) el.value = value; } }
        } catch(e) { console.error(e); }
    }
    async function saveToRecents(type, content, topic) {
        if (!userId) return;
        try {
            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'history'), {
                type: type,
                topic: topic || "Generated Content",
                content: content,
                date: new Date().toLocaleString(),
                timestamp: Date.now()
            });
        } catch (e) {
            console.error(e);
            // Don't spam; but do inform if user is actively using the app.
            try { window.showToast('Cloud History save failed (check login/permissions).'); } catch (_) {}
        }
    }
    function bindHistoryControls() {
        const searchEl = document.getElementById('historySearch');
        const typeEl = document.getElementById('historyTypeFilter');
        const sortEl = document.getElementById('historySort');
        [searchEl, typeEl, sortEl].forEach((el) => {
            if (!el || el.dataset.bound === '1') return;
            el.dataset.bound = '1';
            el.addEventListener('input', applyHistoryFilters);
            el.addEventListener('change', applyHistoryFilters);
        });
    }

    function applyHistoryFilters() {
        const c = document.getElementById('historyListContainer');
        if (!c) return;

        const search = (document.getElementById('historySearch')?.value || '').trim().toLowerCase();
        const typeFilter = document.getElementById('historyTypeFilter')?.value || 'all';
        const sort = document.getElementById('historySort')?.value || 'newest';

        let items = [...historyItemsCache];

        if (search) {
            items = items.filter((i) => {
                const topic = (i.topic || '').toLowerCase();
                const content = (i.content || '').toLowerCase();
                return topic.includes(search) || content.includes(search);
            });
        }

        if (typeFilter !== 'all') {
            items = items.filter((i) => (i.type || '') === typeFilter);
        }

        if (sort === 'oldest') {
            items.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        } else if (sort === 'az') {
            items.sort((a, b) => String(a.topic || '').localeCompare(String(b.topic || '')));
        } else {
            items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        }

        if (!items.length) {
            c.innerHTML = "<div class='text-center text-slate-500 py-10'>No matching history found.</div>";
            return;
        }

        c.innerHTML = items.map(i => {
            const topic = escapeHtml(i.topic || 'Generated Content');
            const type = escapeHtml(i.type || 'general');
            const date = escapeHtml(i.date || '');
            const content = escapeHtml(i.content || '');
            const encodedCopy = encodeURIComponent(i.content || '');
            return `<div class="glass-panel p-6 rounded-lg border-l-4 border-green-500 mb-2 group relative">
<div class="flex justify-between items-start mb-2">
<div><span class="font-bold text-white text-sm block">${topic}</span><span class="text-[10px] text-slate-400 uppercase bg-slate-800 px-1.5 rounded">${type}</span></div>
<span class="text-[10px] text-slate-500">${date}</span>
</div>
<div class="text-sm text-slate-300 line-clamp-3 bg-slate-900/50 p-2 rounded cursor-pointer hover:bg-slate-900 transition" onclick="window.toggleExpand(this)">${content}</div>
<div class="mt-2 text-right flex justify-end gap-2">
<button onclick="window.copyEncoded('${encodedCopy}')" class="text-blue-400 text-xs hover:text-white border border-blue-500/30 px-2 py-1 rounded">Copy</button>
</div>
</div>`;
        }).join('');
    }

    function renderHistoryList() {
        const c = document.getElementById('historyListContainer');
        if(!c) return;
        if (!userId) {
            c.innerHTML = "<div class='text-center text-slate-500 py-10'>Login required to view Cloud History.</div>";
            return;
        }
        bindHistoryControls();
        if (unsubscribeHistory) unsubscribeHistory();
        c.innerHTML = "<div class='text-center text-slate-500 py-10'>Loading history...</div>";
        const q = query(collection(db, 'artifacts', appId, 'users', userId, 'history'), orderBy('timestamp', 'desc'), limit(80));
        unsubscribeHistory = onSnapshot(
            q,
            (snapshot) => {
                historyItemsCache = [];
                snapshot.forEach((doc) => { historyItemsCache.push({ id: doc.id, ...doc.data() }); });
                if (!historyItemsCache.length) {
                    c.innerHTML = "<div class='text-center text-slate-500 py-10'>No cloud history yet. Generate something first.</div>";
                    return;
                }
                applyHistoryFilters();
            },
            (err) => {
                console.error('Cloud history snapshot error:', err);
                const msg = err?.code === 'permission-denied'
                    ? 'Cloud History permission denied. Please log in again.'
                    : (err?.message || 'Cloud History failed to load.');
                c.innerHTML = `<div class='text-center text-slate-500 py-10'>${escapeHtml(msg)}</div>`;
                try { window.showToast(msg); } catch (_) {}
            }
        );
    }


    // --- NEW: CREATIVE DIRECTOR HELPERS ---
    window.setCreativeOption = function(type, value, btn) {
        if(type === 'workload') {
            document.getElementById('crWorkload').value = value;
            document.querySelectorAll('.creative-btn').forEach(b => b.classList.remove('active')); 
            if(btn && btn.parentElement) {
                Array.from(btn.parentElement.children).forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
            }
        }
    };
    
    // Support setManagerOption for templates
    window.setManagerOption = window.setCreativeOption;
    
    // --- CHAT MANAGER (RESTORED) ---
    // --- GLOBAL VARIABLES ---
    let isChatSubmitting = false; // Double Enter Lock

    // --- ALL-IN-ONE SMART CHAT FUNCTION ---
    window.handleChatSubmit = async function() {
        // 1. Safety Checks
        if(isChatSubmitting) return;

        const inputEl = document.getElementById('chatInput');
        const sendBtn = document.querySelector('button[onclick="window.handleChatSubmit()"]');
        const text = inputEl.value.trim();
        if(!text) return;
        
        // 2. Lock UI
        isChatSubmitting = true;
        inputEl.disabled = true; 
        if(sendBtn) sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        // 3. UI Updates
        addMessageToUI('user', text);
        inputEl.value = '';
        const loadingId = addMessageToUI('ai', 'Thinking...', true);
        
        // 4. SMART DATA FETCHING
        let contextData = "No prior data.";
        if(userId) {
            try {
                // Fetch Brand Config
                let brand = {};
                const brandSnap = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand')); 
                if(brandSnap.exists()) brand = brandSnap.data();
                const packages = brand.brandPackages || "Not set";
                const style = brand.brandStyle || "Professional";

                // Fetch Recent Decisions
                let decisions = [];
                const qDecisions = query(collection(db, 'artifacts', appId, 'users', userId, 'decisions'), orderBy('timestamp', 'desc'), limit(3));
                const snapDecisions = await getDocs(qDecisions); 
                snapDecisions.forEach(d => decisions.push(d.data().content));

                // Fetch Chat History
                let history = [];
                const qHistory = query(collection(db, 'artifacts', appId, 'users', userId, 'history'), orderBy('timestamp', 'desc'), limit(5));
                const snapHistory = await getDocs(qHistory);
                snapHistory.forEach(d => history.push(`[${d.data().type}]: ${d.data().topic}`));

                contextData = `Studio Style: ${style} \n Packages: ${packages} \n Recent Decisions: ${decisions.join('; ')} \n Chat History: ${history.join('; ')}`;
            } catch(e) { console.log("Context fetch warning:", e); }
        }

        // 5. THE "AUTO-SWITCH" SYSTEM PROMPT (Updated with Powerful Rules)
        const systemPrompt = `
        === üé≠ SUPER-SYSTEM IDENTITY ===
        You are "The Dual-Brain AI" for With You Photo Studio (Taunggyi).
        You must dynamically SHIFT your personality based on Ko Sai's input.
        
        === üïµÔ∏è‚Äç‚ôÇÔ∏è STEP 1: INTENT & MODE ANALYSIS ===
        Analyze input: "${text}"
        
        üî¥ TRIGGER: BUSINESS MANAGER ("Ko Thet") IF:
        - Input is about: Money, Packages, Clients, Bookings, Schedule, Strategy.
        - Keyword signals: "Price", "Cost", "Post", "Customer", "Plan", "Busy".

        üîµ TRIGGER: CREATIVE MENTOR ("Saya") IF:
        - Input is about: Lighting, Composition, Camera Settings, Art, Inspiration, Mindset.
        - Keyword signals: "Light", "Mood", "Lens", "Feel", "Learn", "Idea".

        (‚ö†Ô∏è If ambiguous, default to BUSINESS MANAGER).

        === üß† MODE 1: BUSINESS MANAGER ("Ko Thet") ===
        - ROLE: Ko Sai's Right-Hand Man. Loyal, Proactive, Strategic.
        - TONE: Natural Burmese (Unicode). Ends with "Bya/Khamya". Warm but Professional.
        - üõ°Ô∏è CRITICAL RULE 1 (NO HALLUCINATIONS): If you don't know a specific price in the data, say "Let me confirm the price." DO NOT GUESS.
        - üí∞ CRITICAL RULE 2 (SANDWICH METHOD): When discussing price, wrap it in value (Value -> Price -> Value). Focus on the *feeling* of the photos.
        - GOAL: Move conversation to a "Booking" or "Solution".

        === üìö MODE 2: CREATIVE MENTOR ("Saya") ===
        - ROLE: Senior Artist & Wise Teacher.
        - TONE: Calm, Deep, Inspiring. Ends with soft "Bya".
        - RULE: NEVER talk about business/prices. Focus on Art, Light, and Emotion.
        - GOAL: Teach, Inspire, and expand Ko Sai's artistic eye.

        === üìù CONTEXT DATA ===
        ${contextData}

        === EXECUTION ===
        1. Decide the Mode (üî¥ or üîµ).
        2. Stay 100% in that character.
        3. Respond in concise, natural Burmese.
        `;
        
        // 6. Send to API
        try {
            const d = await callGenerateAPI({
                userMessage: systemPrompt + "\n\nUser Input: " + text + "\nAI Response:",
                mode: "auto-switch"
            });
            
            // 7. Success Handling
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) loadingEl.remove();

            const msgId = addMessageToUI('ai', d.result);
            addSaveButton(msgId, d.result);

            if(d.result && userId) {
                const topicTag = text.length > 20 ? text.substring(0, 20) + "..." : text;
                saveToRecents('ai_chat', d.result, topicTag);
            }
            window.trackUsage(systemPrompt + text, d.result);  // Input + Output
        } catch(e) {
            console.error(e);
            const loadingEl = document.getElementById(loadingId);
            if(loadingEl) { loadingEl.textContent = getApiErrorMessage(e); loadingEl.classList.add('text-red-400'); }
        } finally {
            // 8. Unlock UI
            isChatSubmitting = false;
            if(inputEl) { inputEl.disabled = false; inputEl.focus(); }
            if(sendBtn) sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    };
    
    window.sendChat = function(text) {
        document.getElementById('chatInput').value = text;
        window.handleChatSubmit();
    }

    function addMessageToUI(role, text, isLoading=false) {
        const container = document.getElementById('chatContainer');
        const div = document.createElement('div');
        const id = 'msg-' + Date.now();
        div.id = id;
        div.className = 'flex w-full ' + (role === 'user' ? 'justify-end' : 'justify-start');

        if (role === 'user') {
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble-user max-w-[80%] text-left';
            bubble.textContent = text;
            div.appendChild(bubble);
        } else {
            const wrap = document.createElement('div');
            wrap.className = 'flex items-start gap-3 max-w-[85%]';

            const iconWrap = document.createElement('div');
            iconWrap.className = 'w-8 h-8 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400 border border-yellow-500/30 shrink-0';
            iconWrap.innerHTML = '<i class="ph ph-robot"></i>';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble-ai';

            if (isLoading) {
                bubble.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            } else {
                bubble.textContent = text;
            }

            wrap.appendChild(iconWrap);
            wrap.appendChild(bubble);
            div.appendChild(wrap);
        }

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return id;
    }

    function addSaveButton(msgId, content) {
        const msgEl = document.getElementById(msgId).querySelector('.chat-bubble-ai');
        const btn = document.createElement('button');
        btn.className = "mt-2 text-[10px] flex items-center gap-1 text-slate-400 hover:text-yellow-400 transition";
        btn.innerHTML = `<i class="ph ph-star"></i> Save Decision`;
        btn.onclick = () => window.saveDecision(content, btn);
        msgEl.appendChild(btn);
    }
    
    window.saveDecision = async function(content, btnElement) {
        if(!requireAuth('Login to save')) return;
        try {
            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'decisions'), {
                content: content,
                timestamp: Date.now()
            });
            btnElement.innerHTML = `<i class="ph ph-star-fill text-yellow-400"></i> Saved`;
            btnElement.classList.add('text-yellow-400');
            window.showToast("Memory Updated!");
        } catch(e) { console.error(e); }
    }


    const getCreativePlatformSelection = () => {
        const onFB = document.getElementById('crFB')?.checked !== false;
        const onTT = document.getElementById('crTT')?.checked === true;
        if (onFB && onTT) return { onFB: true, onTT: true, label: 'Facebook + TikTok' };
        if (onFB) return { onFB: true, onTT: false, label: 'Facebook only' };
        if (onTT) return { onFB: false, onTT: true, label: 'TikTok only' };
        return { onFB: true, onTT: false, label: 'Facebook only' };
    };

    function buildAIPrompt(type, outId, isContinue) {
        let prompt = '';
        let contextTopic = 'General Content';

        if (type === 'manager_daily') {
            const focus = getValue('mgrFocus') || 'General';
            prompt = `Task: Daily Plan. Focus=${focus}. Output: 4 Sections (Priority, Content, Sales, Quick Win).`;
            contextTopic = `Manager Plan (${focus})`;
        } else if (type === 'creative_director') {
            const focus = normalizeIdeaTopic(getValue('crFocus')) || getServiceLabel(getValue('csService') || 'general');
            const { onFB, onTT, label } = getCreativePlatformSelection();
            const perDay = onFB && onTT
                ? 'Day X: Facebook idea (1), TikTok idea (1), Hook (2), CTA (2)'
                : (onFB ? 'Day X: Facebook idea (2), Hook (3), CTA (2)' : 'Day X: TikTok idea (2), Hook (5), CTA (2)');
            prompt = `
            Task: Create a complete 3-Day Content Plan for "${focus}".
            Platforms: ${label}
            Output format (strict):
            Day 1: ${perDay.replace('Day X: ', '')}
            Day 2: ${perDay.replace('Day X: ', '')}
            Day 3: ${perDay.replace('Day X: ', '')}
            Execution checklist (5 bullets).
            No explanation, no planning notes outside the required sections.
            `;
            contextTopic = 'Creative Plan';
        } else if (type === 'creative_post') {
            const selectedTitle = (getValue('csTopic') || '').trim();
            const focus = selectedTitle || normalizeIdeaTopic(getValue('crFocus')) || getServiceLabel(getValue('csService') || 'general');
            const photo = getValue('crPhotoContext') || selectedTitle || 'no photo context provided';
            const { onFB, onTT, label } = getCreativePlatformSelection();
            const outputSections = onFB && onTT
                ? `
            1) Facebook Final Post:
            - Hook lines (3)
            - Main Post (AIDA, one complete version)
            - Caption (2 versions)
            - CTA lines (4)
            - Hashtag set (12)

            2) TikTok Final Pack:
            - Cover text (5)
            - Hook lines (10)
            - On-screen text flow (8 lines)
            - Caption (3)
            - Hashtag set (12)
            - Comment pin (2)
            `
                : onFB
                    ? `
            1) Facebook Final Post:
            - Hook lines (3)
            - Main Post (AIDA, one complete version)
            - Caption (2 versions)
            - CTA lines (4)
            - Hashtag set (12)
            `
                    : `
            1) TikTok Final Pack:
            - Cover text (5)
            - Hook lines (10)
            - On-screen text flow (8 lines)
            - Caption (3)
            - Hashtag set (12)
            - Comment pin (2)
            `;
            prompt = `
            Task: Generate FINAL READY-TO-POST content only.
            Focus: ${focus}
            Service: ${getServiceLabel(getValue('csService') || 'general')}
            Photo context: ${photo}
            Platforms: ${label}
            Output sections (strict):
            ${outputSections}
            Must be ready-to-post Burmese content.
            Output only final content blocks (no explanation, no preface, no notes).
            Start directly from the first required heading.
            `;
            contextTopic = 'Creative Post';
        } else if (type === 'creative_tt_text') {
            const topic = normalizeIdeaTopic(getValue('crFocus')) || getServiceLabel(getValue('csService') || 'general');
            prompt = `
             Task: Build a complete TikTok Text Pack about "${topic}".
             Output format (strict):
             1) Cover text options (5)
             2) Hook text lines (10)
             3) On-screen text flow for 30s video (8 lines)
             4) Captions (3)
             5) Hashtags (15)

             Rules:
             - Natural spoken Burmese
             - No greeting, no self intro
             - Mobile-native, short punchy lines
            `;
            contextTopic = `TikTok Text Mode (${topic})`;
        } else if (type === 'creative_brand_idea') {
            const focus = normalizeIdeaTopic(getValue('crFocus')) || 'Pre-Wedding';
            const photo = getValue('crPhotoContext') || 'no photo context provided';
            const onFB = document.getElementById('crFB')?.checked;
            const onTT = document.getElementById('crTT')?.checked;
            const platformSummary = onFB && onTT ? 'Facebook + TikTok' : (onFB ? 'Facebook only' : (onTT ? 'TikTok only' : 'Facebook only'));
            const outputSections = onFB && onTT
                ? `
            1) Facebook Final Post:
            - Hook lines (3)
            - Main Post (AIDA, full)
            - Caption (2)
            - Hashtags (12)

            2) TikTok Final Pack:
            - Cover Text (5)
            - On-screen Text Flow (8 lines)
            - Caption (3)
            - Hashtags (12)
            - Comment Pin (2)
            `
                : onFB
                    ? `
            1) Facebook Final Post:
            - Hook lines (3)
            - Main Post (AIDA, full)
            - Caption (2)
            - Hashtags (12)
            `
                    : `
            1) TikTok Final Pack:
            - Cover Text (5)
            - On-screen Text Flow (8 lines)
            - Caption (3)
            - Hashtags (12)
            - Comment Pin (2)
            `;
            prompt = `
            Task: Generate FINAL READY-TO-POST content only.
            Focus: ${focus}
            Photo context: ${photo}
            Platforms: ${platformSummary}

            Output format (strict):
            ${outputSections}

            Rules:
            - Must match a photo studio brand voice
            - Natural Burmese, no greeting/self intro
            - Conversion-focused and directly usable today
            - Output only final content blocks (no explanation, no preface, no notes)
            - Do not include "Core Idea" or planning text
            - Start directly with the first final section heading
            `;
            contextTopic = `Brand Idea: ${focus}`;
        } else if (type === 'creative_studio') {
            const persona = getValue('csPersona') || 'sales_closer';
            const tone = getValue('csTone') || 'emotional';
            const length = getValue('csLength') || 'medium';
            const language = getValue('csLanguage') || 'burmese_default';
            const template = getValue('csTemplate') || 'default';
            const service = getValue('csService') || 'general';
            const topic = getValue('csTopic') || normalizeIdeaTopic(getValue('crFocus'));
            const audience = getValue('csAudience');
            const keywords = getValue('csKeywords');
            const cta = getValue('csCTA');
            const avoid = getValue('csAvoid');
            const includeContact = document.getElementById('csIncludeContact')?.checked ? 'yes' : 'no';
            const includeDM = document.getElementById('csIncludeDM')?.checked ? 'yes' : 'no';
            const formats = Array.from(document.querySelectorAll('#csFormats input[type="checkbox"]:checked')).map((el) => el.value).join(', ') || 'fb_post';
            if (!topic) {
                prompt = 'Return this exact message in Burmese: "Creative Brief / Topic ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´"';
            } else {
                prompt = `
                ROLE: You are Sales Master Content AI's Creative Studio engine for With You Studio.
                TASK: Generate conversion-ready marketing content.

                Persona: ${persona}
                Tone: ${tone}
                Length: ${length}
                Language mode: ${language}
                Template: ${template}
                Service type: ${service}
                Target audience: ${audience || 'General audience'}
                Topic: ${topic}
                Keywords: ${keywords || 'none'}
                CTA: ${cta || 'Ask to message for booking'}
                Avoid: ${avoid || 'robotic language'}
                Include contact: ${includeContact}
                Include direct message link: ${includeDM}
                Formats required: ${formats}

                RULES:
                - Must feel human, persuasive, and natural Burmese.
                - Adapt writing based on persona and tone exactly.
                - Use brand voice if persona is my_brand_voice.
                - Output clean sections by format.
                - If format includes hook_set, provide at least 5 hooks.
                - If format includes hashtag_pack, provide 10 relevant hashtags.
                - If format includes tiktok_cover, provide 5 short on-screen cover texts.
                - If format includes tiktok_script, provide one 30-45s scene-by-scene script.
                - If format includes tiktok_caption, provide 3 TikTok captions + one hashtag set.
                - If multiple formats are selected, give complete output per format.
                - Never leave any sentence unfinished.
                `;
            }
            contextTopic = `Creative Studio: ${topic || 'Untitled'}`;
        } else if (type === 'studio_ideas') {
            const service = getValue('csService') || 'general';
            const tone = getValue('csTone') || 'emotional';
            prompt = `Task: Give 8 social content ideas for ${service} in Burmese. Tone=${tone}. Add one-line hook for each.`;
            contextTopic = 'Studio Ideas';
        } else if (type === 'studio_hooks') {
            const topic = getValue('csTopic') || getValue('csService') || 'photo studio';
            prompt = `Task: Create 15 catchy Burmese hooks for topic: ${topic}. Mix emotional, curiosity, and authority styles.`;
            contextTopic = 'Studio Hooks';
        } else if (type === 'studio_cta') {
            const service = getValue('csService') || 'general';
            prompt = `Task: Write 12 Burmese CTA lines for ${service}. Include soft close and urgency variants.`;
            contextTopic = 'Studio CTA';
        } else if (type === 'studio_hashtags') {
            const topic = getValue('csTopic') || getValue('csService') || 'photo studio';
            prompt = `Task: Generate 25 Burmese/English mixed hashtags for ${topic}. Group by reach type (broad, niche, local).`;
            contextTopic = 'Studio Hashtags';
        } else if (type === 'studio_pack_fb') {
            const topic = getValue('csTopic') || getValue('csService') || 'photo studio';
            const tone = getValue('csTone') || 'emotional';
            prompt = `
            Task: Build a Facebook Post Creator Pack for "${topic}".
            Output Sections:
            1) 3 Hooks
            2) Main Post (AIDA style, Burmese)
            3) Short Caption
            4) CTA Variants (5)
            5) Hashtag set (15)
            Tone=${tone}. Make it directly usable for posting today.
            `;
            contextTopic = 'Studio FB Pack';
        } else if (type === 'studio_pack_tiktok') {
            const topic = getValue('csTopic') || getValue('csService') || 'photo studio';
            const tone = getValue('csTone') || 'emotional';
            prompt = `
            Task: Build a TikTok Content Pack for "${topic}".
            Output Sections (hard-lock):
            1) Cover Text (3 options only)
            2) Hook lines (6 only)
            3) Captions (2 only)
            Tone=${tone}. Keep it short, punchy, and mobile-native.
            Return TikTok content only. No intro/preface.
            Do not add "Video Concept", script, hashtag, CTA, or any extra section.
            `;
            contextTopic = 'Studio TikTok Pack';
        } else if (type === 'studio_pack_dm') {
            const service = getValue('csService') || 'general';
            prompt = `
            Task: Build a DM Reply Pack for studio service: ${service}.
            Output Sections:
            1) New inquiry reply (3 tones)
            2) Price objection reply (5)
            3) Ghosting follow-up (4)
            4) Booking close reply (4)
            5) FAQ mini responses (10)
            Must be natural Burmese and close-friendly.
            `;
            contextTopic = 'Studio DM Pack';
        } else if (type === 'studio_campaign' || type === 'studio_campaign_fb' || type === 'studio_campaign_tiktok') {
            const topic = (getValue('csTopic') || normalizeIdeaTopic(getValue('crFocus')) || getValue('csService') || 'photo studio').trim();
            const service = getServiceLabel(getValue('csService') || 'general');
            const tone = getValue('csTone') || 'emotional';
            const cta = getValue('csCTA') || 'Inbox for booking';
            const templateGuide = currentTemplateGuide || 'none';
            const finalFB = type !== 'studio_campaign_tiktok';
            const finalTT = type !== 'studio_campaign_fb';
            const safeFB = finalFB || !finalTT;
            const safeTT = finalTT;
            const sectionFB = `
            1) Facebook Final Post:
            - Hook lines (3)
            - Main Post (AIDA, one full version)
            - Caption (2)
            - CTA lines (3)
            - Hashtags (12)
            `;
            const sectionTT = `
            2) TikTok Final Pack:
            - Cover Text (3 only)
            - Hook lines (6 only)
            - Captions (2 only)
            `;
            const outputSections = safeFB && safeTT ? `${sectionFB}\n${sectionTT}` : (safeFB ? sectionFB : `
            1) TikTok Final Pack:
            - Cover Text (3 only)
            - Hook lines (6 only)
            - Captions (2 only)
            `);
            prompt = `
            Task: Build final campaign result from one idea.
            Idea title: ${topic}
            Service: ${service}
            Tone: ${tone}
            CTA: ${cta}
            Template guide: ${templateGuide}

            Output sections (strict):
            ${outputSections}

            Rules:
            - Final ready-to-post content only
            - Natural Burmese, no greeting/self intro
            - No explanation or planning notes
            - No intro sentence before section 1
            - Do not add "Video Concept", script, hashtag, CTA, comment pin, or extra section for TikTok
            - If TikTok section exists, enforce Cover=3, Hooks=6, Captions=2 exactly
            - Output must contain only requested section headings above
            - Facebook Main Post must be exactly one short paragraph (90-140 Burmese words), conversion-focused.
            - Do NOT write tutorial/teaching content, tips, numbered lessons, or long explanations.
            - Do NOT mention mentor/artist/photographer names or quotes.
            `;
            const modeTag = type === 'studio_campaign_fb' ? 'Facebook' : (type === 'studio_campaign_tiktok' ? 'TikTok' : (safeFB && safeTT ? 'FB+TikTok' : (safeFB ? 'Facebook' : 'TikTok')));
            contextTopic = `Final Campaign (${modeTag}): ${topic}`;
        } else if (type === 'studio_hook_pro') {
            const topic = (getValue('csTopic') || normalizeIdeaTopic(getValue('crFocus')) || getValue('csService') || 'photo studio').trim();
            const service = getServiceLabel(getValue('csService') || 'general');
            prompt = `
            Task: Generate Hook Generator Pro output for this idea.
            Idea title: ${topic}
            Service: ${service}

            Output sections (strict):
            1) Question Hooks (2)
            2) Bold Claim Hooks (2)
            3) Story Hooks (2)
            4) FOMO Hooks (2)
            5) Offer Hooks (2)

            Rules:
            - Exactly 10 hooks total
            - Short, punchy, human Burmese
            - No intro text, no explanation
            `;
            contextTopic = `Hook Pro: ${topic}`;
        } else if (type === 'dm_auto_detect') {
            prompt = `Task: Best DM Reply for "${getValue('dmInput')}".`;
            contextTopic = 'Auto DM Reply';
        } else if (type === 'dm_analyze') {
            prompt = `Task: Analyze "${getValue('dmInput')}". Output: Status, Reason.`;
        } else if (type === 'dm_best') {
            prompt = `Task: 3 Sales Replies. Client: "${getValue('dmInput')}".`;
            contextTopic = 'DM Sales';
        } else if (type === 'fbpost') {
            prompt = `Task: 3 FB Posts. Topic: ${getValue('fbInput')}.`;
            contextTopic = 'FB Post';
        } else if (type === 'timeline') {
            prompt = `Task: Wedding Timeline. Place: ${getValue('tlPlace')}.`;
            contextTopic = 'Timeline';
        } else if (type === 'tt_post_full') {
            const topic = getValue('ttInput');
            prompt = `Role: TikTok Expert for a Photo Studio.
             Task: Create a complete TikTok Post Package for topic: "${topic}".
             OUTPUT FORMAT:
             1. üì∫ **Text on Video (Hook)**: (Short text to put on video cover)
             2. üìù **Caption**: (Engaging caption in Burmese, asking a question)
             3. #Ô∏è‚É£ **Hashtags**: (5-10 Trending Myanmar Hashtags)
             4. üéµ **Song Vibe**: (Suggested music style)
             `;
            contextTopic = `TikTok Post (${topic})`;
        } else if (type.includes('tt_')) {
            const subType = type === 'tt_script' ? 'Video Script (Scene by Scene)' : '3 Viral Captions';
            prompt = `Task: Write ${subType} for TikTok. Topic: ${getValue('ttInput')}. Style: ${getValue('ttStyle')}.`;
            contextTopic = 'TikTok Content';
            if (isContinue) prompt = `Context: Continue TikTok content from: "${document.getElementById(outId).innerText.slice(-50)}".`;
        } else if (type === 'pose') {
            prompt = `Task: 3 Pose Ideas. Context: ${getValue('poseInput')}.`;
            contextTopic = 'Pose';
        } else if (type === 'mentor') {
            const topic = getValue('mentorInput');
            prompt = `
             ROLE: World-Class Photography Mentor & Senior Artist.
             USER: Ko Sai (Professional Photographer).
             TASK: Provide artistic advice on: "${topic}".
             
             GUIDELINES:
             - Tone: Inspiring, Deep, Educational, Warm (Teacher to Student).
             - Language: Natural Burmese (Unicode).
             - Focus: Art, Emotion, Composition, Lighting, Mindset.
             - RESTRICTION: Do NOT talk about pricing, packages, or business. Only Art.
             
             If asking about a specific master (e.g., Jerry Ghionis), explain their style and how Ko Sai can apply it.
             `;
            contextTopic = `Mentorship: ${topic}`;
        }

        if (isContinue) {
            const currentText = document.getElementById(outId) ? document.getElementById(outId).innerText : '';
            prompt = `Context: Continue correctly from this output tail: "${currentText.slice(-500)}". Continue seamlessly, do not repeat previous lines, and complete all unfinished sections.`;
        }

        return { prompt, contextTopic };
    }


    window.generateAI = async function(type, isContinue = false) {
        const outId = AI_UI_CONFIG.outputIds[type];
        const areaId = AI_UI_CONFIG.areaIds[type];
        const triggerBtn = isContinue
            ? document.getElementById(AI_UI_CONFIG.continueBtnIds[type])
            : document.querySelector(AI_UI_CONFIG.actionButtonSelectors[type] || '');
        setButtonBusy(triggerBtn, true, isContinue ? 'Continuing...' : 'Generating...');


        // UI Loading
        if(type !== 'dm_analyze') {
            const areaEl = document.getElementById(areaId);
            if(areaEl) areaEl.classList.remove('hidden');
            
            if(!isContinue) {
                const outEl = document.getElementById(outId);
                if(outEl) outEl.textContent = 'Thinking...';
                // Mobile Scroll
                if(window.innerWidth < 768) {
                    const scrollTarget = document.getElementById(areaId);
                    if(scrollTarget) setTimeout(() => { scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
                }
            }
        } else {
             const panel = document.getElementById('dmAnalysisPanel');
             if(panel) { 
                 panel.classList.remove('hidden'); 
                 const content = document.getElementById('dmAnalysisContent');
                 if(content) content.textContent = 'Analyzing...'; 
             }
        }

        // Data Loading
        let packages = "Not specified";
        let contactInfo = "Not set";
        let brandStyle = "Cinematic, Emotional";
        let brandClient = "Wedding clients";
        
        if (userId) { 
            try { 
                const s = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'config', 'brand')); 
                if(s.exists()) {
                    const d = s.data();
                    if(d.brandPackages) packages = d.brandPackages;
                    if(d.brandStyle) brandStyle = d.brandStyle;
                    if(d.brandClient) brandClient = d.brandClient;
                    contactInfo = `Phone: ${d.brandPhone || ''}, Viber: ${d.brandViber || ''}`;
                }
            } catch(e){ console.log("Brand fetch error", e); } 
        }

        const systemPrompt = `
        === üé≠ ROLE & IDENTITY ===
        YOU ARE: The "Creative Director & Senior Sales Strategist" for 'With You Photo Studio' (Taunggyi).
        BRAND VOICE: Cinematic, Emotional, High-End yet Accessible, Warm.
        MISSION: Turn casual viewers into paying clients through storytelling.

        === ‚úçÔ∏è WRITING RULES (CRITICAL) ===
        1. üó£Ô∏è TONE: Natural Burmese (Unicode). Use "Bya/Khamya" for politeness, but keep the vibe Exciting & Emotional.
        2. üö´ NO ROBOTIC LANGUAGE: Avoid formal textbook Burmese. Write like a human influencer talking to fans.
        3. üé£ HOOKS FIRST: Always start with a "Hook" (Question, Shocking Statement, or Emotional Appeal) to grab attention.
        4. üçî STRUCTURE: Use the AIDA model (Attention -> Interest -> Desire -> Action).
        5. ‚ú® FORMATTING: Use Emojis (üì∏, ‚ú®, üë∞) strategically to break up text. Use Bullet points for readability.

        === üß† KNOWLEDGE BASE ===
        - Studio Data: Packages=[${packages}], Contact=[${contactInfo}], BrandStyle=[${brandStyle}], TargetClient=[${brandClient}].
        - Location context: Taunggyi, Inle, Kalaw (Shan State vibes).

        === üéØ GOAL PER TYPE ===
        - If FB POST: Focus on "Storytelling" & "Emotion". Long form is okay.
        - If TIKTOK: Focus on "Trends", "Fast Pace", & "Visual descriptions".
        - If DM REPLY: Focus on "Empathy", "Clarity", & "Closing the Deal".
        - If TIMELINE: Be "Logical" & "Detailed".

        IMPORTANT: Always output COMPLETE responses. Do not cut off.
        - Start directly with the requested deliverable content.
        - Do NOT add greeting lines (e.g., "·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´").
        - Do NOT introduce yourself or mention any role/title.
        - Do NOT write meta-intro text; output only usable post content.
        - Prefer complete detailed output over overly short output.
        - Ensure every requested section is present before finishing.
        `;
        const { prompt, contextTopic } = buildAIPrompt(type, outId, isContinue);
        const promptWithCompletionRule = END_MARKER_TYPES.has(type)
            ? (prompt + "\n\nCompletion rule: end the final line with [END] only when output is fully complete.")
            : prompt;

        try {
            const packTypes = new Set(['studio_pack_fb', 'studio_pack_tiktok', 'studio_pack_dm', 'studio_campaign', 'studio_campaign_fb', 'studio_campaign_tiktok']);
            const tiktokHeavyTypes = new Set(['tt_script', 'tt_caption', 'tt_post_full']);
            const longFormTypes = new Set(['creative_director', 'creative_post', 'creative_tt_text', 'creative_brand_idea', 'creative_studio', 'studio_pack_fb', 'studio_pack_tiktok', 'studio_pack_dm', 'studio_campaign', 'studio_campaign_fb', 'studio_campaign_tiktok', 'studio_hook_pro', 'fbpost', 'tt_post_full']);
            const maxOutputTokens = packTypes.has(type)
                ? ((type === 'studio_campaign' || type === 'studio_campaign_fb' || type === 'studio_campaign_tiktok') ? 3000 : 2200)
                : (tiktokHeavyTypes.has(type)
                    ? (type === 'tt_caption' ? 1200 : 1700)
                    : (longFormTypes.has(type)
                        ? (type === 'creative_brand_idea' ? 2000 : 1700)
                        : 900));
            const d = await callGenerateAPI({
                userMessage: systemPrompt + "\n\n" + promptWithCompletionRule,
                maxOutputTokens
            });
            let cleanedResult = sanitizeGeneratedOutput(type, d.result);
            if (!cleanedResult) {
                throw new Error(d.finishReason
                    ? `No content returned (finishReason: ${d.finishReason}). Try simpler input.`
                    : 'No content returned. Try simpler input.');
            }

            // If model leaked internal instructions, force one clean rewrite pass.
            if (hasMetaLeak(cleanedResult)) {
                try {
                    const rewrite = await callGenerateAPI({
                        userMessage: systemPrompt + "\n\nRewrite the following as FINAL READY-TO-POST CONTENT ONLY. Remove all explanations/rules/meta text. Keep Burmese natural and complete.\n\n" + cleanedResult,
                        maxOutputTokens
                    }, { timeoutMs: Math.max(API_TIMEOUT_MS, 40000), retries: 0 });
                    const rewritten = sanitizeGeneratedOutput(type, rewrite.result);
                    if (rewritten) cleanedResult = rewritten;
                } catch (rewriteErr) {
                    console.warn('Meta-clean rewrite skipped:', rewriteErr?.message || rewriteErr);
                }
            }

            const autoContinueTypes = new Set(['creative_director', 'creative_post', 'creative_tt_text', 'creative_brand_idea', 'creative_studio', 'studio_pack_fb', 'studio_pack_tiktok', 'studio_pack_dm', 'studio_campaign', 'studio_campaign_fb', 'studio_campaign_tiktok', 'studio_hook_pro', 'tt_script', 'tt_caption', 'tt_post_full']);
            let needsMore = typeof d.isCut === 'boolean' ? d.isCut : shouldShowContinue(type, cleanedResult);

            // Full mode: allow automatic continuation for completeness.
            const ENABLE_AUTO_CONTINUE = true;
            if (ENABLE_AUTO_CONTINUE && !isContinue && needsMore && autoContinueTypes.has(type)) {
                const maxPasses = type === 'tt_caption' ? 3 : 2;
                let pass = 0;

                while (needsMore && pass < maxPasses) {
                    pass += 1;
                    try {
                        const follow = await callGenerateAPI({
                            userMessage: systemPrompt + "\n\nContinue the unfinished output below. Return only NEW remaining lines. Do not repeat any previous line.\n\n" + cleanedResult.slice(-700),
                            maxOutputTokens
                        }, { timeoutMs: Math.max(API_TIMEOUT_MS, 40000), retries: 0 });

                        const followText = sanitizeGeneratedOutput(type, follow.result);
                        if (!followText) break;

                        cleanedResult = (cleanedResult + "\n" + followText).trim();
                        needsMore = typeof follow.isCut === 'boolean'
                            ? follow.isCut
                            : shouldShowContinue(type, cleanedResult);
                    } catch (followErr) {
                        console.warn('Auto-continue skipped:', followErr?.message || followErr);
                        break;
                    }
                }
            }

            // If output is still too short for content types, do one expansion pass.
            const minLengthTypes = new Set(['creative_brand_idea', 'creative_post', 'creative_studio', 'studio_pack_fb', 'studio_pack_tiktok', 'studio_pack_dm', 'studio_campaign', 'studio_campaign_fb', 'studio_campaign_tiktok', 'studio_hook_pro', 'fbpost']);
            if (!isContinue && minLengthTypes.has(type) && cleanedResult.length < 180) {
                try {
                    const expand = await callGenerateAPI({
                        userMessage: systemPrompt + "\n\nExpand and complete all missing sections from this draft without repeating:\n" + cleanedResult,
                        maxOutputTokens
                    }, { timeoutMs: Math.max(API_TIMEOUT_MS, 40000), retries: 0 });
                    const expanded = sanitizeGeneratedOutput(type, expand.result);
                    if (expanded) cleanedResult = (cleanedResult + "\n" + expanded).trim();
                } catch (expandErr) {
                    console.warn('Expand pass skipped:', expandErr?.message || expandErr);
                }
            }

            // Quality gate: if required sections are missing, request only missing sections once.
            if (!isContinue) {
                const missing = getMissingSections(type, cleanedResult);
                if (missing.length) {
                    try {
                        const refill = await callGenerateAPI({
                            userMessage: systemPrompt + "\n\nThe draft is missing these sections: " + missing.join(', ') + ". Return ONLY those missing sections in Burmese, ready-to-use, without repeating existing sections.\n\nDraft:\n" + cleanedResult,
                            maxOutputTokens
                        }, { timeoutMs: Math.max(API_TIMEOUT_MS, 40000), retries: 0 });
                        const refillText = sanitizeGeneratedOutput(type, refill.result);
                        if (refillText) cleanedResult = (cleanedResult + "\n\n" + refillText).trim();
                    } catch (refillErr) {
                        console.warn('Missing-sections refill skipped:', refillErr?.message || refillErr);
                    }
                }
            }

            // Hard-lock gate for TikTok output shape to keep exact counts.
            if (!isContinue && (type === 'studio_pack_tiktok' || type === 'studio_campaign' || type === 'studio_campaign_fb' || type === 'studio_campaign_tiktok')) {
                try {
                    const hardLockPrompt = (type === 'studio_pack_tiktok' || type === 'studio_campaign_tiktok')
                        ? (
`Reformat this draft into STRICT final output with exact shape.

Required output (only these 3 sections):
1) Cover Text:
- exactly 3 lines
2) Hook lines:
- exactly 6 lines
3) Captions:
- exactly 2 lines

Rules:
- Keep persuasive Burmese suitable for converting photo clients.
- No intro sentence, no explanation.
- Do NOT include Video Concept, script, hashtags, CTA, comment pin, or any extra section.

Draft:
${cleanedResult}`
                        )
                        : (type === 'studio_campaign_fb'
                        ? (
`Reformat this draft into STRICT final output for Facebook only.

Required output:
1) Facebook Final Post:
- Hook lines (3)
- Main Post (1 full AIDA version)
- Caption (2)
- CTA lines (3)
- Hashtags (12)

Rules:
- No intro sentence, no explanation.
- Do NOT include any TikTok section.
- Output only section 1.
- Main Post must be exactly one short paragraph (90-140 Burmese words).
- Do NOT include tutorial tips, numbered lessons, mentor voice, famous quotes, or photographer names.

Draft:
${cleanedResult}`
                        )
                        : (
`Reformat this draft into STRICT final campaign output with exact sections.

Required output:
1) Facebook Final Post:
- Hook lines (3)
- Main Post (1 full AIDA version)
- Caption (2)
- CTA lines (3)
- Hashtags (12)

2) TikTok Final Pack:
- Cover Text (exactly 3)
- Hook lines (exactly 6)
- Captions (exactly 2)

Rules:
- No intro sentence, no explanation.
- Do NOT include Video Concept, script, hashtags in TikTok section, comment pin, or extra sections.
- Output only section 1 and section 2.
- Facebook Main Post must be exactly one short paragraph (90-140 Burmese words).
- Do NOT include tutorial tips, numbered lessons, mentor voice, famous quotes, or photographer names.

Draft:
${cleanedResult}`
                        ));

                    const hardLock = await callGenerateAPI({
                        userMessage: systemPrompt + "\n\n" + hardLockPrompt,
                        maxOutputTokens
                    }, { timeoutMs: Math.max(API_TIMEOUT_MS, 40000), retries: 0 });
                    const locked = sanitizeGeneratedOutput(type, hardLock.result);
                    if (locked) cleanedResult = locked;
                } catch (hardErr) {
                    console.warn('Hard-lock pass skipped:', hardErr?.message || hardErr);
                }
            }
            
            if(type === 'dm_analyze') {
                const analysisEl = document.getElementById('dmAnalysisContent');
                if (analysisEl) analysisEl.textContent = d.result;
            } else {
                const outEl = document.getElementById(outId);
                if(outEl) {
                    if(isContinue) outEl.innerText += "\n" + cleanedResult;
                    else outEl.innerText = cleanedResult;

                    // --- SAVE TO RECENT LOGIC ---
                    if(cleanedResult && !cleanedResult.includes("Error") && userId) {
                         // Manager Plan (·Äû·Ä≠·ÄØ·Ä∑) ·Ä°·ÄÅ·Äº·Ä¨·Ä∏ result ·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ Recent ·Äë·Ä≤·Äû·Ä≠·Äô·Ä∫·Ä∏·Äï·Ä´·Äô·Äö·Ä∫
                         await saveToRecents(type, outEl.innerText, contextTopic);
                    }
                }
                const btn = document.getElementById(AI_UI_CONFIG.continueBtnIds[type]);
                if (btn) {
                    btn.onclick = () => window.continueAI(type);
                    const shouldContinue = CONTINUE_ELIGIBLE_TYPES.has(type)
                        ? (typeof needsMore === 'boolean' ? needsMore : shouldShowContinue(type, cleanedResult))
                        : false;
                    if (shouldContinue) btn.classList.remove('hidden');
                    else btn.classList.add('hidden');
                }
            }
            if (cleanedResult && !cleanedResult.includes("No content returned")) {
                window.trackUsage(prompt, cleanedResult);
            }
        } catch(e) {
            console.error(e);
            const outEl = document.getElementById(outId);
            if(outEl && !isContinue) outEl.innerText = "Connection Error: " + getApiErrorMessage(e);
            window.showToast(getApiErrorMessage(e));
        } finally {
            setButtonBusy(triggerBtn, false);
        }
    };

    window.continueAI = (t) => window.generateAI(t, true);
    window.showToast = (m) => { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); };
    window.copyText = (id) => { navigator.clipboard.writeText(document.getElementById(id).innerText); window.showToast("Copied"); };
    window.copyEncoded = (encoded) => { navigator.clipboard.writeText(decodeURIComponent(encoded)); window.showToast("Copied"); };
    window.setDmType = (t, b) => { document.getElementById('dmType').value = t; document.querySelectorAll('.tactic-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
    window.fillPose = (t) => { document.getElementById('poseInput').value = t === 'Shy' ? "·Ä°·Äõ·Äô·Ä∫·Ä∏·Äõ·Äæ·ÄÄ·Ä∫·Äê·Äê·Ä∫·Äê·Äö·Ä∫" : "·Äù·Äê·Ä≤·Ä∑·Ä°·Äê·ÄΩ·Ä≤"; };
    window.startVoiceInput = (id, btn) => {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR) return window.showToast("No Voice Support");
        const r = new SR(); r.lang = 'my-MM'; r.start();
        btn.classList.add('listening-ring');
        r.onresult = (e) => { document.getElementById(id).value += " " + e.results[0][0].transcript; window.showToast("Heard!"); };
        r.onend = () => btn.classList.remove('listening-ring');
    };
    window.clearHistory = async () => {
        if (!requireAuth()) return;
        if (!confirm('Clear all cloud history?')) return;
        try {
            const q = query(collection(db, 'artifacts', appId, 'users', userId, 'history'));
            const snap = await getDocs(q);
            await Promise.all(snap.docs.map((d) => deleteDoc(d.ref)));
            window.showToast('Cloud history cleared');
        } catch (e) {
            console.error(e);
            window.showToast('Clear failed');
        }
    };
    window.toggleExpand = (el) => { if(el.classList.contains('line-clamp-3')) el.classList.remove('line-clamp-3'); else el.classList.add('line-clamp-3'); };
    window.downloadFile = (n, id) => { const b = new Blob([document.getElementById(id).innerText],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=n; a.click(); };
    window.downloadMarkdownFile = (n, id) => {
        const content = document.getElementById(id)?.innerText || '';
        const b = new Blob([content], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = n;
        a.click();
    };

    window.loadView('creative'); // Start with Creative
    setupDraftAutosave();
    applyTheme(localStorage.getItem(THEME_KEY) || 'studio-blue');
    if (typeof window.applyTemplatePreset === 'function') window.applyTemplatePreset();




    // Mentor Mode Helper
window.askMaster = function(name, style) {
    const input = document.getElementById('mentorInput');
    if(input) {
        input.value = `${name} ·Äõ·Ä≤·Ä∑ Style ·Äñ·Äº·ÄÖ·Ä∫·Äê·Ä≤·Ä∑ ${style} ·ÄÄ·Ä≠·ÄØ ·ÄÄ·Äª·ÄΩ·Äî·Ä∫·Äê·Ä±·Ä¨·Ä∑·Ä∫·Äõ·Ä≤·Ä∑ Pre-wedding ·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·ÄÄ·ÄΩ·ÄÑ·Ä∫·Ä∏·Äê·ÄΩ·Ä±·Äô·Äæ·Ä¨ ·Äò·Äö·Ä∫·Äú·Ä≠·ÄØ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·ÄÅ·Äª·Äú·Ä≠·ÄØ·Ä∑·Äõ·Äô·Äú·Ä≤?`;
        window.generateAI('mentor');
    }
};

  </script>
  <div class="md:hidden fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-xl border-t border-slate-800 z-50 flex justify-between items-end px-6 py-4 pb-6 shadow-2xl">
      
      <button onclick="window.loadView('manager')" id="btm-manager" class="mobile-btm-nav flex flex-col items-center gap-1 text-slate-500 transition active:scale-90">
          <i class="ph ph-robot text-2xl mb-0.5"></i>
          <span class="text-[10px] font-bold">Partner</span>
      </button>

      <button onclick="window.loadView('mentor')" id="btm-mentor" class="mobile-btm-nav flex flex-col items-center gap-1 text-slate-500 transition active:scale-90">
          <i class="ph ph-student text-2xl mb-0.5"></i>
          <span class="text-[10px] font-bold">Mentor</span>
      </button>
      
      <div class="relative -top-5">
          <button onclick="window.loadView('creative')" id="btm-creative" class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 shadow-lg shadow-blue-600/40 flex items-center justify-center text-white border-[5px] border-slate-950 active:scale-95 transition transform hover:-translate-y-1">
              <i class="ph ph-lightbulb text-3xl"></i>
          </button>
      </div>

      <button onclick="window.loadView('dm')" id="btm-dm" class="mobile-btm-nav flex flex-col items-center gap-1 text-slate-500 transition active:scale-90">
          <i class="ph ph-chat-circle-text text-2xl mb-0.5"></i>
          <span class="text-[10px] font-bold">DM</span>
      </button>

      <button onclick="window.toggleSidebar()" class="flex flex-col items-center gap-1 text-slate-500 transition active:scale-90">
          <i class="ph ph-squares-four text-2xl mb-0.5"></i>
          <span class="text-[10px] font-bold">Menu</span>
      </button>
  </div>
</body>
</html>
